<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Loading Sheet - Good Way Express</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.4;
            background-color: #f5f9fc;
            color: #2c3e50;
            height: 100vh;
            overflow: hidden;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
            padding: 8px;
            height: calc(100vh - 50px);
            display: flex;
            flex-direction: column;
        }

        /* Header Styles */
        .header-container {
            display: flex;
            background: linear-gradient(135deg, #3498db, #2c3e50);
            color: white;
            padding: 5px 10px;
            border-radius: 6px;
            margin-bottom: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            align-items: center;
        }

        .logo-section {
            display: flex;
            align-items: center;
            flex: 0 0 200px;
        }

        .logo {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            overflow: hidden;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
        }

        .logo i {
            color: #3498db;
            font-size: 24px;
        }

        .user-info {
            flex: 1;
            text-align: left;
            padding: 0 15px;
        }

        .user-info p {
            margin: 2px 0;
            font-size: 0.9em;
        }

        .header-search-section {
            flex: 0 0 300px;
            display: flex;
            align-items: center;
        }

        .header-search-bar {
            display: flex;
            align-items: center;
            background-color: white;
            border-radius: 20px;
            padding: 5px 10px;
            width: 100%;
        }

        .header-search-bar input {
            border: none;
            outline: none;
            padding: 5px;
            width: 100%;
            font-size: 0.9em;
        }

        .header-search-bar button {
            background-color: #2980b9;
            color: white;
            border: none;
            border-radius: 20px;
            padding: 5px 12px;
            cursor: pointer;
            font-size: 0.8em;
            margin-left: 5px;
        }

        .logout-section {
            flex: 0 0 100px;
            text-align: right;
        }

        .logout-button button {
            background-color: #e74c3c;
            color: white;
            border: none;
            border-radius: 20px;
            padding: 6px 15px;
            cursor: pointer;
            font-size: 0.9em;
        }

        /* Navigation Styles */
        .nav-container {
            display: flex;
            background: linear-gradient(135deg, #2c3e50, #34495e);
            border-radius: 6px;
            margin-bottom: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 0;
        }

        nav ul {
            list-style-type: none;
            display: flex;
            padding: 0;
            margin: 0;
            width: 100%;
        }

        nav ul li {
            position: relative;
        }

        nav ul li a {
            color: white;
            text-decoration: none;
            padding: 10px 15px;
            display: block;
            transition: background-color 0.3s ease;
            font-size: 0.9em;
        }

        nav ul li a:hover {
            background-color: #3498db;
        }

        nav ul li ul {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            background-color: #2c3e50;
            min-width: 200px;
            z-index: 1000;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border-radius: 0 0 4px 4px;
        }

        nav ul li:hover > ul {
            display: block;
        }

        nav ul li ul li {
            width: 100%;
        }

        nav ul li ul li a {
            padding: 10px 15px;
            background-color: #2c3e50;
            /* Remove any button styles that might be inherited */
            border: none;
            border-radius: 0;
            text-align: left;
            display: block;
            width: 100%;
        }

        nav ul li ul li a:hover {
            background-color: #3498db;
        }

        /* Specifically fix the Bulk Booking link */
        nav ul li ul li a.btn-secondary {
            background-color: #2c3e50 !important;
            color: white !important;
            border: none !important;
            border-radius: 0 !important;
            padding: 10px 15px !important;
            text-align: left !important;
            display: block !important;
            width: 100% !important;
            font-size: 0.9em !important;
            font-weight: normal !important;
            text-decoration: none !important;
            transition: background-color 0.3s ease !important;
        }

        nav ul li ul li a.btn-secondary:hover {
            background-color: #3498db !important;
            color: white !important;
            transform: none !important;
            box-shadow: none !important;
        }

        /* Main Content */
        .main-content {
            display: flex;
            flex-direction: column;
            gap: 8px;
            height: 100%;
            overflow: hidden;
        }

        .content {
            background-color: white;
            padding: 12px;
            border-radius: 6px;
            box-shadow: 0 0 8px rgba(0, 0, 0, 0.08);
            overflow-y: auto;
        }

        .search-section {
            background-color: white;
            padding: 12px;
            border-radius: 6px;
            box-shadow: 0 0 8px rgba(0, 0, 0, 0.08);
            margin-bottom: 8px;
        }

        h2 {
            margin-bottom: 10px;
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 5px;
            font-size: 1.1em;
        }

        /* Compact form controls */
        .form-row {
            display: flex;
            gap: 8px;   
            margin-bottom: 0;
            align-items: flex-end;
            flex-wrap: nowrap;
        }

        .form-group {
            flex: 0 0 180px;
            min-width: 140px;
        }

        label {
            display: block;
            margin-bottom: 4px;
            font-weight: 600;
            font-size: 0.74em;
            color: #34495e;
        }

        input, select {
            width: 100%;
            padding: 6px 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.82em;
            height: 34px;
            box-sizing: border-box;
        }

        /* Date filter row */
        .date-filter {
            display: flex;
            gap: 8px;
            margin-bottom: 0;
            align-items: flex-end;
            flex-wrap: nowrap;
        }

        .date-filter .form-group {
            flex: 0 0 150px;
            min-width: 120px;
        }

        .date-filter-button {
            flex: 0 0 auto;
            margin-bottom: 0;
            display: flex;
            align-items: center;
        }

        .date-filter-button button, .header-search-bar button, button {
            height: 34px;
            padding: 6px 10px;
            font-size: 0.82em;
        }

        /* Updated search section layout */
        .search-section {
            background-color: white;
            padding: 10px;
            border-radius: 6px;
            box-shadow: 0 0 8px rgba(0, 0, 0, 0.08);
            margin-bottom: 8px;

            display: flex;
            gap: 12px;
            align-items: flex-end;
            flex-wrap: nowrap;
            overflow: hidden;
        }

        /* Destination checkbox styles */
        .destination-checkbox-group {
            flex: 0 0 250px;
            min-width: 200px;
        }

        .destination-checkboxes {
            max-height: 120px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 6px;
            background-color: #f9f9f9;
            font-size: 0.8em;
        }

        .destination-checkbox {
            display: flex;
            align-items: center;
            margin-bottom: 4px;
        }

        .destination-checkbox input {
            width: auto;
            height: auto;
            margin-right: 6px;
        }

        .destination-checkbox label {
            margin-bottom: 0;
            font-weight: normal;
            cursor: pointer;
        }

        /* CNote number group */
        .cnote-group {
            flex: 0 0 250px;
            min-width: 200px;
        }

        /* Date and search group */
        .date-search-group {
            display: flex;
            gap: 8px;
            align-items: flex-end;
            flex: 1;
        }

        .date-search-group .form-group {
            flex: 0 0 150px;
        }

        .search-button-group {
            flex: 0 0 auto;
        }

        /* Responsive adjustments */
        @media (max-width: 1400px) {
            .search-section {
                flex-wrap: wrap;
            }
            
            .destination-checkbox-group, .cnote-group, .date-search-group {
                flex: 1 1 100%;
                margin-bottom: 8px;
            }
            
            .date-search-group {
                flex-wrap: wrap;
            }
            
            .date-search-group .form-group {
                flex: 1 1 calc(50% - 8px);
            }
        }

        @media (max-width: 768px) {
            .date-search-group {
                flex-direction: column;
            }
            
            .date-search-group .form-group {
                flex: 1 1 100%;
            }
        }

        /* Table Styles */
        .table-container {
            overflow-x: auto;
            margin-bottom: 8px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.8em;
        }

        th, td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        th {
            background-color: #3498db;
            color: white;
            position: sticky;
            top: 0;
        }

        tfoot td {
            font-weight: bold;
            background-color: #f0f0f0;
        }

        /* Buttons */
        button {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 6px 12px;
            cursor: pointer;
            font-size: 0.85em;
            transition: background 0.2s;
            height: 32px;
            box-sizing: border-box;
        }

        button:hover {
            background: linear-gradient(135deg, #2980b9, #1c6ea4);
        }

        .footer {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }

        .btn-check {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
        }

        .btn-check:hover {
            background: linear-gradient(135deg, #27ae60, #219653);
        }

        /* Popup Styles */
        .popup {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            padding: 20px;
            z-index: 1000;
            width: 90%;
            max-width: 1000px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }

        .close {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 24px;
            font-weight: bold;
            color: #aaa;
            cursor: pointer;
            transition: color 0.3s;
        }

        .close:hover {
            color: #333;
        }

        /* Filter row in popup */
        .filter-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 8px;
            margin-bottom: 8px;
        }

        .filter-row input {
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.85em;
            height: 32px;
            box-sizing: border-box;
            width: 100%;
        }

        /* Success Popup */
        .success-popup {
            display: none;
            position: fixed;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
            text-align: center;
        }

        .success-popup h2 {
            margin-top: 0;
            color: #27ae60;
        }

        .success-popup-buttons {
            margin-top: 20px;
            display: flex;
            justify-content: center;
            gap: 10px;
        }

        /* Status message */
        .status-message {
            padding: 8px;
            margin: 8px 0;
            border-radius: 4px;
            text-align: center;
            font-size: 0.9em;
        }

        .status-error {
            background-color: #ffebee;
            color: #c62828;
        }

        .status-success {
            background-color: #e8f5e9;
            color: #2e7d32;
        }

        /* IMPROVED ASSIGN TRANSPORTER POPUP STYLES */
        #assign-transporter-popup {
            max-width: 500px;
            padding: 0;
            border-radius: 12px;
            overflow: hidden;
        }

        .popup-header {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            padding: 20px;
            border-radius: 12px 12px 0 0;
        }

        .popup-header h2 {
            margin: 0;
            color: white;
            border-bottom: none;
            font-size: 1.3em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .popup-header h2 i {
            font-size: 1.2em;
        }

        .popup-content {
            padding: 25px;
        }

        #assign-transporter-popup .close {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 24px;
            font-weight: bold;
            color: white;
            cursor: pointer;
            transition: color 0.3s;
            background: rgba(255,255,255,0.2);
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #assign-transporter-popup .close:hover {
            background: rgba(255,255,255,0.3);
            color: #f1f1f1;
        }

        /* Improved Form Styles for Assign Transporter Popup */
        .transporter-form {
            padding: 0;
        }

        .form-group-enhanced {
            margin-bottom: 20px;
        }

        .form-group-enhanced label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
            font-size: 0.9em;
        }

        .form-group-enhanced select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            font-size: 1em;
            background-color: #f8f9fa;
            transition: all 0.3s ease;
            height: 48px;
        }

        .form-group-enhanced select:focus {
            border-color: #3498db;
            background-color: white;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
            outline: none;
        }

        .selected-cnotes-info {
            background-color: #f8f9fa;
            border: 1px solid #e1e8ed;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .selected-cnotes-info h4 {
            margin: 0 0 10px 0;
            color: #2c3e50;
            font-size: 0.95em;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .selected-cnotes-info h4 i {
            color: #3498db;
        }

        .cnotes-count {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .cnotes-count span {
            font-size: 0.9em;
            color: #7f8c8d;
        }

        .cnotes-count .count-badge {
            background: #3498db;
            color: white;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: bold;
        }

        .popup-footer {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 25px;
            padding-top: 20px;
            border-top: 1px solid #e1e8ed;
        }

        .btn-primary {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 25px;
            cursor: pointer;
            font-size: 0.95em;
            font-weight: 600;
            transition: all 0.3s ease;
            min-width: 140px;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #2980b9, #1c6ea4);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
        }

        .btn-secondary {
            background: #95a5a6;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 25px;
            cursor: pointer;
            font-size: 0.95em;
            font-weight: 600;
            transition: all 0.3s ease;
            min-width: 100px;
        }

        .btn-secondary:hover {
            background: #7f8c8d;
            transform: translateY(-2px);
        }

        /* Responsive Adjustments */
        @media (max-width: 1400px) {
            .form-row {
                flex-wrap: wrap;
            }
            
            .form-group {
                flex: 1 1 calc(50% - 4px);
            }
            
            .header-container {
                flex-wrap: wrap;
            }
            
            .logo-section, .user-info, .header-search-section, .logout-section {
                flex: 1 1 100%;
                margin-bottom: 5px;
            }
            
            .filter-row {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 992px) {
            .filter-row {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .filter-row {
                grid-template-columns: 1fr;
            }
            
            .date-filter {
                flex-direction: column;
            }
            
            .footer {
                flex-direction: column;
            }
            
            .form-group {
                flex: 1 1 100%;
            }
            
            .popup-footer {
                flex-direction: column;
            }
            
            .btn-primary, .btn-secondary {
                min-width: 100%;
            }
        }
    </style>

    <link rel="manifest" href="/static/manifest.json">
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register("/service-worker.js")
            .then(() => console.log("Service Worker Registered!"))
            .catch(err => console.log("Service Worker Failed", err));
        }
    </script>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header-container">
            <div class="logo-section">
                <div class="logo">
                    <img src="/static/images/logo.jpg" alt="Company Logo" style="width: 100%; height: 100%; object-fit: cover">                
                </div>
                <div>
                    <p style="font-weight: bold;">Good Way</p>
                    <p style="font-weight: bold;">Express</p>
                </div>
            </div>
            
            <div class="user-info">
                <p>Welcome AMIT (MUMBAI - MAHARASHTRA)</p>
                <p id="currentDateTime" style="margin-top: 2px; font-size: 0.8em;"></p>  
            </div>
            
            <div class="header-search-section">
                <div class="header-search-bar">
                    <input type="text" id="searchCNote" placeholder="Search CNote Number" />
                    <button id="searchButton">Search</button>
                </div>
            </div>
            
            <div class="logout-section">
                <button type="button" id="logoutBtn">Logout</button>
            </div>
        </div>

        <!-- Navigation -->
        <div class="nav-container">
            <nav>
                <ul>
                    <li>
                        <a href="/dealer/create_cnotes/"><i class="fas fa-home"></i> Home</a>
                    </li>
                    <li>
                        <a href="#"><i class="fas fa-cogs"></i> Operations</a>
                        <ul>
                            <li>
                                <a href="/dealer/create_cnotes/"> Booking</a>
                            </li>
                            <li>
                                <a href="/dealer/import-cnotes/" target="_blank" rel="noopener noreferrer">Bulk Booking</a>
                            </li>
                            <li>
                                <a href="/dealer/loading_sheet/"target="_blank" rel="noopener noreferrer"> Loading Sheet</a>
                            </li>
                        </ul>
                    </li>

                    <li>
                        <a href="#"><i class="fas fa-tools"></i> Master</a>
                            <ul>
                                <li>
                                    <a href="/dealer/qr-printer-setting/" target="_blank">QR Printer Setting</a>
                                </li>
                            </ul>
                    </li>

                    
                    <li>
                        <a href="/dealer/booking_register/"target="_blank" rel="noopener noreferrer"><i class="fas fa-chart-bar"></i> Report</a>
                        <ul>
                        </ul>
                    </li>
                </ul>
            </nav>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="content">
                <h2>Loading Sheet</h2>
                
                <div class="search-section">
                    <div class="destination-checkbox-group">
                        <label>Select Destination</label>
                        <div class="destination-checkboxes" id="destination-checkboxes">
                            <!-- Destination checkboxes will be populated here -->
                        </div>
                    </div>
                    
                    <div class="cnote-group">
                        <label for="cnote-number">CNote Number</label>
                        <input id="cnote-number" placeholder="Enter CNote Number and press Enter" type="text"/>
                    </div>
                    
                    <div class="date-search-group">
                        <div class="form-group">
                            <label for="from-date">From Date</label>
                            <input type="date" id="from-date">
                        </div>
                        <div class="form-group">
                            <label for="to-date">To Date</label>
                            <input type="date" id="to-date">
                        </div>
                        <div class="form-group search-button-group">
                            <button onclick="searchData()">Search</button>
                        </div>
                    </div>
                </div>

                <div id="statusMessage" class="status-message" style="display: none;"></div>

                <h2>Pending CNotes For Dispatch</h2>
                <div class="table-container">
                    <table id="main-table">
                        <thead>
                            <tr>
                                <th><input type="checkbox" id="select-all" onclick="toggleSelectAll(this)"></th>
                                <th>SR</th>
                                <th>Bkg/Unloading Date</th>
                                <th>CNote Number</th>
                                <th>Destination</th> 
                                <th>Consignor</th>
                                <th>Consignee</th>
                                <th>Total Art</th>
                                <th>Weight</th>
                                <th>CNote Type</th>
                                <th>Grand Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Data will be populated here -->
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="7"><strong>Totals:</strong></td>
                                <td id="total-art">0</td>
                                <td id="total-weight">0</td>
                                <td></td>
                                <td id="total-amount">0</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
                
                <div class="footer">
                    <button id="check-loading-sheet-btn" onclick="checkLoadingSheet()">Check Loading Sheet</button>
                    <button onclick="cancel()">Cancel</button>
                    <button onclick="assignTransporters()">Assign Transporters</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Popups -->
    <div class="overlay" id="overlay"></div>
    
    <div class="popup" id="search-popup">
        <span class="close" onclick="closePopup('search-popup')">&times;</span>
        <h2>Search Results</h2>
        <div class="filter-row">
            <input type="text" placeholder="Filter SR" id="filter-sr">
            <input type="text" placeholder="Filter Date" id="filter-date">
            <input type="text" placeholder="Filter CNote Number" id="filter-cnote">
            <input type="text" placeholder="Filter Destination" id="filter-destination">
            <input type="text" placeholder="Filter Consignor" id="filter-consignor">
            <input type="text" placeholder="Filter Consignee" id="filter-consignee">
            <input type="text" placeholder="Filter Total Art" id="filter-total-art">
            <input type="text" placeholder="Filter Weight" id="filter-weight">
            <input type="text" placeholder="Filter CNote Type" id="filter-cnote-type">
            <input type="text" placeholder="Filter Grand Total" id="filter-grand-total">
        </div>
        <div class="table-container">
            <table id="popup-table">
                <thead>
                    <tr>
                        <th><input type="checkbox" id="select-all-popup" onclick="toggleSelectAllPopup(this)"></th>
                        <th>SR</th>
                        <th>Bkg/Unloading Date</th>
                        <th>CNote Number</th>
                        <th>Destination</th> 
                        <th>Consignor</th>
                        <th>Consignee</th>
                        <th>Total Art</th>
                        <th>Weight</th>
                        <th>CNote Type</th>
                        <th>Grand Total</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Search results will be populated here -->
                </tbody>
            </table>
        </div>
        <div class="footer">
            <button onclick="addSelectedData()">Add Selected</button>
        </div>
    </div>
    
    <!-- Improved Assign Transporter Popup -->
    <div class="popup" id="assign-transporter-popup">
        <div class="popup-header">
            <h2><i class="fas fa-truck-loading"></i> Assign Transporter</h2>
            <span class="close" onclick="closePopup('assign-transporter-popup')">&times;</span>
        </div>
        <div class="popup-content">
            <div class="selected-cnotes-info">
                <h4><i class="fas fa-list-check"></i> Selected CNotes Summary</h4>
                <div class="cnotes-count">
                    <span>Total CNotes Selected:</span>
                    <span class="count-badge" id="selected-cnotes-count">0</span>
                </div>
            </div>
            
            <form id="pickup-request-form" class="transporter-form">
                <div class="form-group-enhanced">
                    <label for="select-transporter"><i class="fas fa-truck"></i> Select Transporter</label>
                    <select id="select-transporter" name="transporter_name" required>
                        <option value="">-- Choose a Transporter --</option>
                        <option value="ATUL">ATUL</option>
                        <option value="GOOD WAY EXPRESS">GOOD WAY EXPRESS</option>
                    </select>
                </div>
                <input type="hidden" name="cnote_ids" id="selected-cnote-ids">
                
                <div class="popup-footer">
                    <button type="button" class="btn-secondary" onclick="closePopup('assign-transporter-popup')">Cancel</button>
                    <button type="button" class="btn-primary" onclick="sendPickupRequest()">
                        <i class="fas fa-paper-plane"></i> Send Pickup Request
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <div class="success-popup" id="success-popup">
        <h2>लोडिंग शीट सफलतापूर्वक जनरेट हो गई है</h2>
        <p>आपकी लोडिंग शीट नंबर <span id="loading-sheet-number"></span> चुने गए CNotes के साथ जनरेट हो गई है।</p>
        <div class="success-popup-buttons">
            <button onclick="savePDF()">Save as PDF</button>
            <button onclick="printLoadingSheet()">Print</button>
        </div>
    </div>

    <script>
        let data = [];
        let addedCNoteNumbers = new Set();

        // Helper function to get CSRF token from cookies
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // Logout function
        function handleLogout() {
            if (confirm('Are you sure you want to logout?')) {
                const csrfToken = getCookie('csrftoken');
                
                fetch('/logout/', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrfToken,
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    credentials: 'same-origin'
                })
                .then(response => {
                    if (response.redirected) {
                        window.location.href = response.url;
                    } else if (response.ok) {
                        window.location.href = '/login/';
                    } else {
                        throw new Error('Logout failed');
                    }
                })
                .catch(error => {
                    console.error('Logout error:', error);
                    // Fallback: redirect to login page
                    window.location.href = '/login/';
                });
            }
        }

        document.addEventListener("DOMContentLoaded", function() {
            console.log("DOM fully loaded");
            
            // Add event listener to logout button
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);
            
            fetchPendingCNotes();
            fetchTransporters();
            
            // Set default date range (last 7 days)
            const today = new Date();
            const oneWeekAgo = new Date();
            oneWeekAgo.setDate(today.getDate() - 7);
            
            document.getElementById('from-date').valueAsDate = oneWeekAgo;
            document.getElementById('to-date').valueAsDate = today;
            
            // Ensure filter works when user types
            document.querySelectorAll('.filter-row input').forEach(input => {
                input.addEventListener('input', function() {
                    console.log("Filtering:", input.id, input.value);
                    filterPopupTable();
                });
            });

            // Add event listener for Enter key in CNote number field
            document.getElementById('cnote-number').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    addCNoteByNumber();
                }
            });
        });

        function fetchPendingCNotes() {
            const fromDate = document.getElementById('from-date').value;
            const toDate = document.getElementById('to-date').value;
            
            fetch(`/dealer/api/fetch_pending_cnotes/?from_date=${fromDate}&to_date=${toDate}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(cnotes => {
                    console.log('Fetched data:', cnotes);
                    data = cnotes;
                    populateDestinationCheckboxes();
                })
                .catch(error => {
                    console.error('Error fetching CNotes:', error);
                    showMessage('Error fetching data. Please try again.', 'error');
                });
        }

        function populateDestinationCheckboxes() {
            const container = document.getElementById('destination-checkboxes');
            const destinations = [...new Set(data.map(item => item.delivery_destination__destination_name))].filter(Boolean);
            container.innerHTML = '';
            
            destinations.forEach(destination => {
                const checkboxDiv = document.createElement('div');
                checkboxDiv.className = 'destination-checkbox';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `dest-${destination}`;
                checkbox.value = destination;
                
                const label = document.createElement('label');
                label.htmlFor = `dest-${destination}`;
                label.textContent = destination;
                
                checkboxDiv.appendChild(checkbox);
                checkboxDiv.appendChild(label);
                container.appendChild(checkboxDiv);
            });
            
            console.log('Populated destination checkboxes:', destinations);
        }

        function getSelectedDestinations() {
            const checkboxes = document.querySelectorAll('#destination-checkboxes input[type="checkbox"]:checked');
            return Array.from(checkboxes).map(cb => cb.value);
        }

        function renderTable(tableId, cnotes) {
            const tableBody = document.getElementById(tableId).getElementsByTagName('tbody')[0];
            tableBody.innerHTML = '';
            cnotes.forEach((item, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><input type="checkbox" data-sr="${item.id}"></td>
                    <td>${index + 1}</td>
                    <td>${new Date(item.created_at).toLocaleDateString()}</td>
                    <td>${item.cnote_number}</td>
                    <td>${item.delivery_destination__destination_name || ''}</td>
                    <td>${item.consignor_name}</td>
                    <td>${item.consignee_name}</td>
                    <td>${item.total_articles}</td>
                    <td>${item.actual_weight}</td>
                    <td>${item.payment_type}</td>
                    <td>${item.grand_total}</td>
                `;
                tableBody.appendChild(row);
            });
            if (tableId === 'main-table') {
                updateTotals();
            }
        }

        function searchData() {
            const selectedDestinations = getSelectedDestinations();
            const cnoteNumber = document.getElementById('cnote-number').value;
            const fromDate = document.getElementById('from-date').value;
            const toDate = document.getElementById('to-date').value;
            
            const filteredData = data.filter(item => {
                const itemDate = new Date(item.created_at).toISOString().split('T')[0];
                const dateInRange = (!fromDate || itemDate >= fromDate) && 
                                   (!toDate || itemDate <= toDate);
                
                const destinationMatch = selectedDestinations.length === 0 || 
                                       selectedDestinations.includes(item.delivery_destination__destination_name);
                
                return destinationMatch &&
                    (!cnoteNumber || item.cnote_number.includes(cnoteNumber)) &&
                    dateInRange &&
                    !addedCNoteNumbers.has(item.cnote_number);
            });

            renderTable('popup-table', filteredData);
            showPopup('search-popup');
        }

        function filterPopupTable() {
            const filters = {
                sr: document.getElementById('filter-sr').value.toLowerCase(),
                date: document.getElementById('filter-date').value.toLowerCase(),
                cnoteNumber: document.getElementById('filter-cnote').value.toLowerCase(),
                destination: document.getElementById('filter-destination').value.toLowerCase(),
                consignor: document.getElementById('filter-consignor').value.toLowerCase(),
                consignee: document.getElementById('filter-consignee').value.toLowerCase(),
                totalArt: document.getElementById('filter-total-art').value.toLowerCase(),
                weight: document.getElementById('filter-weight').value.toLowerCase(),
                cnoteType: document.getElementById('filter-cnote-type').value.toLowerCase(),
                grandTotal: document.getElementById('filter-grand-total').value.toLowerCase()
            };

            const filteredData = data.filter(item => {
                return (
                    (!filters.sr || item.id.toString().toLowerCase().includes(filters.sr)) &&
                    (!filters.date || item.created_at.toString().toLowerCase().includes(filters.date)) &&
                    (!filters.cnoteNumber || item.cnote_number.toLowerCase().includes(filters.cnoteNumber)) &&
                    (!filters.destination || item.delivery_destination__destination_name?.toLowerCase().includes(filters.destination)) &&
                    (!filters.consignor || item.consignor_name.toLowerCase().includes(filters.consignor)) &&
                    (!filters.consignee || item.consignee_name.toLowerCase().includes(filters.consignee)) &&
                    (!filters.totalArt || (item.total_articles || '0').toString().toLowerCase().includes(filters.totalArt)) &&
                    (!filters.weight || (item.actual_weight || '0').toString().toLowerCase().includes(filters.weight)) &&
                    (!filters.cnoteType || item.payment_type.toLowerCase().includes(filters.cnoteType)) &&
                    (!filters.grandTotal || (item.grand_total || '0').toString().toLowerCase().includes(filters.grandTotal))
                );
            });
            
            renderTable('popup-table', filteredData);
            console.log("Filters applied:", filters);
            console.log("Filtered Data:", filteredData);
        }

        function showPopup(popupId) {
            document.getElementById(popupId).style.display = 'block';
            document.getElementById('overlay').style.display = 'block';
            
            // Update selected CNotes count for assign transporter popup
            if (popupId === 'assign-transporter-popup') {
                // Only count checkboxes in tbody, exclude the "select all" checkbox in the header
                const selectedCount = document.querySelectorAll('#main-table tbody input[type="checkbox"]:checked').length;
                document.getElementById('selected-cnotes-count').textContent = selectedCount;
            }
        }

        function closePopup(popupId) {
            document.getElementById(popupId).style.display = 'none';
            document.getElementById('overlay').style.display = 'none';
        }

        function addSelectedData() {
            const popupTableBody = document.getElementById('popup-table').getElementsByTagName('tbody')[0];
            const checkboxes = popupTableBody.querySelectorAll('input[type="checkbox"]:checked');

            const selectedItems = Array.from(checkboxes).map(checkbox => {
                const row = checkbox.closest('tr');
                const cnoteNumber = row.cells[3].innerText;
                addedCNoteNumbers.add(cnoteNumber);
                return data.find(item => item.cnote_number === cnoteNumber);
            });

            const currentMainTableData = Array.from(document.getElementById('main-table').getElementsByTagName('tbody')[0].rows)
                .map(row => data.find(item => item.cnote_number === row.cells[3].innerText));

            renderTable('main-table', [...currentMainTableData, ...selectedItems]);
            closePopup('search-popup');
        }

        function addCNoteByNumber() {
            const cnoteNumber = document.getElementById('cnote-number').value.trim();
            
            if (!cnoteNumber) {
                showMessage('Please enter a CNote number', 'error');
                return;
            }
            
            // Find the CNote in the data
            const cnote = data.find(item => 
                item.cnote_number === cnoteNumber && 
                !addedCNoteNumbers.has(item.cnote_number)
            );
            
            if (cnote) {
                // Add to the main table
                addedCNoteNumbers.add(cnote.cnote_number);
                
                const currentMainTableData = Array.from(document.getElementById('main-table').getElementsByTagName('tbody')[0].rows)
                    .map(row => data.find(item => item.cnote_number === row.cells[3].innerText));
                
                renderTable('main-table', [...currentMainTableData, cnote]);
                
                // Clear the input and show success message
                document.getElementById('cnote-number').value = '';
                showMessage('CNote successfully added to dispatch list', 'success');
            } else {
                // If not found, show error or open search popup
                if (data.some(item => item.cnote_number === cnoteNumber)) {
                    showMessage('This CNote is already added to the dispatch list', 'error');
                } else {
                    showMessage('CNote not found in pending list', 'error');
                    // Optionally open the search popup
                    searchData();
                }
            }
        }

        function showMessage(message, type) {
            const statusElement = document.getElementById('statusMessage');
            statusElement.textContent = message;
            statusElement.className = `status-message status-${type}`;
            statusElement.style.display = 'block';
            
            // Auto hide after 3 seconds
            setTimeout(() => {
                statusElement.style.display = 'none';
            }, 3000);
        }

        function updateTotals() {
            const mainTableBody = document.getElementById('main-table').getElementsByTagName('tbody')[0];
            const rows = mainTableBody.getElementsByTagName('tr');

            let totalArt = 0;
            let totalWeight = 0;
            let totalAmount = 0;

            for (let i = 0; i < rows.length; i++) {
                const cells = rows[i].getElementsByTagName('td');
                totalArt += parseInt(cells[7].innerText) || 0;
                totalWeight += parseFloat(cells[8].innerText) || 0;
                totalAmount += parseFloat(cells[10].innerText) || 0;
            }

            document.getElementById('total-art').innerText = totalArt;
            document.getElementById('total-weight').innerText = totalWeight.toFixed(2);
            document.getElementById('total-amount').innerText = totalAmount.toFixed(2);
        }

        function toggleSelectAll(source) {
            const checkboxes = document.querySelectorAll('#main-table tbody input[type="checkbox"]');
            checkboxes.forEach(checkbox => checkbox.checked = source.checked);
        }

        function toggleSelectAllPopup(source) {
            const checkboxes = document.querySelectorAll('#popup-table tbody input[type="checkbox"]');
            checkboxes.forEach(checkbox => checkbox.checked = source.checked);
        }

        function assignTransporters() {
            const selectedCNotes = Array.from(document.querySelectorAll('#main-table tbody input[type="checkbox"]:checked'));
            if (selectedCNotes.length === 0) {
                showMessage("Please select at least one CNote to assign a transporter.", 'error');
                return;
            }
            const cnoteIds = selectedCNotes.map(checkbox => checkbox.getAttribute('data-sr')).filter(id => id); 
            
            console.log("Collected CNote IDs:", cnoteIds);

            document.getElementById('selected-cnote-ids').value = cnoteIds.join(',');
            
            showPopup('assign-transporter-popup');
        }
        
        function showSuccessPopup(loadingSheetId) {
            document.getElementById('loading-sheet-number').textContent = loadingSheetId;
            document.getElementById('success-popup').style.display = 'block';
            document.getElementById('overlay').style.display = 'block';
        }

        function savePDF() {
            const loadingSheetNumber = document.getElementById('loading-sheet-number').textContent;
            fetch(`/dealer/api/generate_pdf/${loadingSheetNumber}/`, {
                method: 'GET',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                }
            })
            .then(response => response.blob())
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = `loading_sheet_${loadingSheetNumber}.pdf`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
            })
            .catch(error => {
                console.error('Error generating PDF:', error);
                showMessage('Failed to generate PDF. Please try again.', 'error');
            });
            closeSuccessPopup();
        }

        function printLoadingSheet() {
            const loadingSheetNumber = document.getElementById('loading-sheet-number').textContent;
            const selectedCNotes = Array.from(document.querySelectorAll('#main-table tbody input[type="checkbox"]:checked'))
                .map(checkbox => {
                    const row = checkbox.closest('tr');
                    return {
                        cnoteNumber: row.cells[3].innerText,
                        destination: row.cells[4].innerText,
                        consignee: row.cells[6].innerText,
                        totalArt: row.cells[7].innerText,
                        weight: row.cells[8].innerText,
                        amount: row.cells[10].innerText
                    };
                });
            
            sessionStorage.setItem('mfPrintData', JSON.stringify(selectedCNotes));
            sessionStorage.setItem('loadingSheetNumber', loadingSheetNumber);
            
            const printWindow = window.open('/dealer/mf_print/', '_blank');
            
            closeSuccessPopup();
        }

        function closeSuccessPopup() {
            document.getElementById('success-popup').style.display = 'none';
            document.getElementById('overlay').style.display = 'none';
        }

        function fetchTransporters() {
            fetch('/dealer/api/fetch_transporters/', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/xml',
                },
            })
            .then(response => response.text())
            .then(str => (new window.DOMParser()).parseFromString(str, "text/xml"))
            .then(data => {
                const transporters = data.getElementsByTagName('transporter');
                const selectTransporter = document.getElementById('select-transporter');
                selectTransporter.innerHTML = '<option value="">-- Choose a Transporter --</option>';
                
                for (let transporter of transporters) {
                    const id = transporter.getAttribute('id');
                    const name = transporter.getElementsByTagName('name')[0].textContent;
                    const option = document.createElement('option');
                    option.value = name;
                    option.textContent = name;
                    selectTransporter.appendChild(option);
                }
            })
            .catch(error => {
                console.error('Error fetching transporters:', error);
            });
        }

        function sendPickupRequest() {
            const form = document.getElementById('pickup-request-form');
            const formData = new FormData(form);
            const transporterName = formData.get('transporter_name');
            const selectedCNotes = Array.from(document.querySelectorAll('#main-table tbody input[type="checkbox"]:checked'))
                .map(checkbox => {
                    const row = checkbox.closest('tr');
                    return {
                        id: checkbox.getAttribute('data-sr'),
                        cnoteNumber: row.cells[3].innerText,
                        destination: row.cells[4].innerText,
                        consignor: row.cells[5].innerText,
                        consignee: row.cells[6].innerText,
                        totalArt: row.cells[7].innerText,
                        weight: row.cells[8].innerText,
                        cnoteType: row.cells[9].innerText,
                        grandTotal: row.cells[10].innerText
                    };
                });

            if (selectedCNotes.length === 0) {
                showMessage('Please select at least one CNote.', 'error');
                return;
            }

            if (!transporterName) {
                showMessage('Please select a transporter.', 'error');
                return;
            }

            const updatedFormData = new FormData();
            const cnoteIds = selectedCNotes.map(cnote => cnote.id).filter(id => id);
            updatedFormData.append('cnote_ids', cnoteIds.join(','));
            updatedFormData.append('transporter_name', transporterName);

            sessionStorage.setItem('mfPrintData', JSON.stringify(selectedCNotes));
            sessionStorage.setItem('transporterName', transporterName);

            fetch('/dealer/send-pickup-request/', {
                method: 'POST',
                body: updatedFormData,
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                },
                redirect: 'follow'
            })
            .then(response => {
                if (response.redirected) {
                    closePopup('assign-transporter-popup');
                    
                    // Remove selected rows
                    selectedCNotes.forEach(cnote => {
                        const row = document.querySelector(`#main-table tr td input[data-sr="${cnote.id}"]`);
                        if (row && row.closest('tr')) {
                            row.closest('tr').remove();
                        }
                    });
                    
                    updateTotals();
                    fetchPendingCNotes();

                    // Open the new window
                    window.open(response.url, '_blank');
                    return { success: true };
                }
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                if (data.error) {
                    throw new Error(data.error);
                }
                
                if (!data.success) {
                    console.log('Loading sheet created:', data);
                    
                    closePopup('assign-transporter-popup');
                    
                    // Remove rows
                    selectedCNotes.forEach(cnote => {
                        const row = document.querySelector(`#main-table tr td input[data-sr="${cnote.id}"]`);
                        if (row && row.closest('tr')) {
                            row.closest('tr').remove();
                        }
                    });
                    
                    updateTotals();
                    
                    if (data.loading_sheet_id) {
                        showSuccessPopup(data.loading_sheet_id);
                    }
                    
                    fetchPendingCNotes();
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showMessage('An error occurred while sending the pickup request: ' + error.message, 'error');
            });
        }

        function cancel() {
            const mainTableBody = document.getElementById('main-table').getElementsByTagName('tbody')[0];
            mainTableBody.innerHTML = '';
            document.getElementById('total-art').innerText = '0';
            document.getElementById('total-weight').innerText = '0';
            document.getElementById('total-amount').innerText = '0';
            addedCNoteNumbers.clear();
            
            // Clear destination checkboxes
            document.querySelectorAll('#destination-checkboxes input[type="checkbox"]').forEach(cb => {
                cb.checked = false;
            });
            
            document.getElementById('cnote-number').value = '';
            showMessage('Selection cleared', 'success');
        }

        function updateDateTime() {
            const now = new Date();
            const dateTimeString = now.toLocaleString('en-US', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            document.getElementById('currentDateTime').textContent = dateTimeString;
        }

        setInterval(updateDateTime, 1000);
        updateDateTime();

        function checkLoadingSheet() {
            console.log("✅ Check Loading Sheet button clicked!");
            
            // Get all checked checkboxes from the main table
            const selectedCheckboxes = document.querySelectorAll('#main-table tbody input[type="checkbox"]:checked');
            
            if (selectedCheckboxes.length === 0) {
                showMessage("❌ Please select at least one CNote!", 'error');
                return;
            }
            
            // Extract the CNote IDs from the data-sr attribute
            const selectedCNoteIds = Array.from(selectedCheckboxes).map(checkbox => checkbox.getAttribute('data-sr'));
            console.log("🔍 Selected CNotes:", selectedCNoteIds);
            
            // Generate the query string
            const queryString = selectedCNoteIds.map(id => `selected_cnotes=${id}`).join("&");
            const url = `/dealer/check-loading-sheet/?${queryString}`;
            
            console.log("🔍 Redirecting to URL:", url);
            
            // Open in a new tab
            window.open(url, '_blank');
        }

        // Search functionality for header search bar
        document.getElementById('searchButton').addEventListener('click', function() {
            const searchTerm = document.getElementById('searchCNote').value;
            if (searchTerm) {
                window.location.href = `/dealer/view-cnote/${encodeURIComponent(searchTerm)}/`;
            }
        });
    </script>
</body>
</html>
