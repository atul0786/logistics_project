<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Loading Sheet</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/>
    <style>
        :root {
            --primary-color: #00a2e8;
            --secondary-color: #0073aa;
            --background-color: #f2f2f2;
            --surface-color: #ffffff;
            --text-color: #333333;
            --border-color: #dddddd;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--background-color);
            color: var(--text-color);
        }

        .header {
            background-color: var(--primary-color);
            color: white;
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header img {
            height: 50px;
        }

        .header-controls {
            display: flex;
            gap: 10px;
        }

        .nav {
            background-color: var(--secondary-color);
            padding: 10px 20px;
        }

        .nav a {
            color: white;
            text-decoration: none;
            padding: 5px 10px;
            margin-right: 10px;
            border-radius: 4px;
            transition: background-color 0.3s;
        }

        .nav a:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .content {
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .search-section {
            background-color: var(--surface-color);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .search-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 10px;
        }

        .search-controls select, .search-controls input[type="text"] {
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            flex-grow: 1;
        }

        .search-controls button {
            padding: 8px 16px;
            background-color: var(--secondary-color);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .search-controls button:hover {
            background-color: #005a87;
        }

        .table-container {
            overflow-x: auto;
            background-color: var(--surface-color);
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        th {
            background-color: var(--secondary-color);
            color: white;
        }

        tr:nth-child(even) {
            background-color: #f8f8f8;
        }

        .footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }

        .footer button {
            padding: 10px 20px;
            background-color: var(--secondary-color);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .footer button:hover {
            background-color: #005a87;
        }

        .popup {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: var(--surface-color);
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 20px;
            z-index: 1000;
            width: 90%;
            max-width: 1000px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .popup .close {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-color);
        }

        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }

        .message-popup {
            display: none;
            background-color: #f44336;
            color: white;
            padding: 5px 8px;
            border-radius: 4px;
            margin-top: 5px;
            position: absolute;
            width: calc(100% - 16px);
            z-index: 10;
            font-size: 14px;
            line-height: 1.2;
            box-sizing: border-box;
        }

        .cnote-input-container {
            position: relative;
            flex-grow: 1;
        }

        .search-controls-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        @media (max-width: 768px) {
            .search-controls-row {
                flex-direction: column;
            }

            .search-controls select, .search-controls input[type="text"], .cnote-input-container {
                width: 100%;
            }
        }

        .sms-popup {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: var(--surface-color);
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 20px;
            z-index: 1001;
            width: 300px;
            text-align: center;
        }

        .sms-popup button {
            margin-top: 10px;
            padding: 5px 10px;
            background-color: var(--secondary-color);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        
        header {
            background-color: #87ceeb;
            color: #333;
            padding: 10px 0;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .logo {
            width: 80px;
            height: auto;
        }

        .top-bar {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            padding: 0 20px;
        }

        .user-info {
            text-align: center;
            flex-grow: 1;
        }

        .search-bar input {
            width: 200px;
            padding: 8px;
            border: none;
            outline: none;
            font-size: 14px;
        }

        .search-bar button {
            padding: 8px 15px;
            background-color: #4682b4;
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .search-bar button:hover {
            background-color: #36648b;
        }
        
        .search-logout-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }

        .search-bar {
            display: flex;
            align-items: center;
            background-color: #ffffff;
            border-radius: 20px;
            padding: 5px 10px;
            margin-right: 80px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        } 
        
        .logout-button {  
            position: absolute;  
            right: 15px;  
            top: 39px;  
        }

        .logout-button button {
            background-color: #ff4500;
            color: white;
            padding: 9px 18px;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .logout-button button:hover {
            background-color: #e63900;
        }

        .popup#assign-transporter-popup {
            background-color: #f9f9f9;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            padding: 30px;
            max-width: 400px;
        }

        .popup#assign-transporter-popup h2 {
            color: #333;
            font-size: 24px;
            margin-bottom: 20px;
            text-align: center;
        }

        .popup#assign-transporter-popup select {
            width: 100%;
            padding: 12px;
            margin-bottom: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            appearance: none;
            background-image: url('data:image/svg+xml;utf8,<svg fill="%23333" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/><path d="M0 0h24v24H0z" fill="none"/></svg>');
            background-repeat: no-repeat;
            background-position: right 10px center;
        }

        .popup#assign-transporter-popup button {
            width: 100%;
            padding: 12px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .popup#assign-transporter-popup button:hover {
            background-color: #45a049;
        }

        .popup#assign-transporter-popup .close {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 28px;
            font-weight: bold;
            color: #aaa;
            cursor: pointer;
            transition: color 0.3s;
        }

        .popup#assign-transporter-popup .close:hover {
            color: #333;
        }
        
        nav {
            background-color: #4682b4;
            padding: 1px 0;
        }

        nav ul {
            list-style-type: none;
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
        }

        nav ul li {
            position: relative;
        }

        nav ul li a {
            color: white;
            text-decoration: none;
            padding: 5px 10px;
            border-radius: 4px;
            transition: background-color 0.3s;
        }

        nav ul li a:hover {
            background-color: #3a6d8c;
        }

        nav ul li ul {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            background-color: #4682b4;
            padding: 10px;
            border-radius: 0 0 4px 4px;
            z-index: 1000;
        }

        nav ul li:hover > ul {
            display: block;
        }

        nav ul li ul li {
            width: 200px;
            padding: 5px 0;
        }

        nav ul li ul li a {
            display: block;
            padding: 5px 10px;
        }

        /* New styles for filter inputs */
        .filter-row {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 10px;
        }

        .filter-row input {
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            flex-grow: 1;
        }

        @media (max-width: 768px) {
            .filter-row {
                flex-direction: column;
            }
        }
        .success-popup {
            display: none;
            position: fixed;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
        }

        .success-popup h2 {
            margin-top: 0;
        }

        .success-popup-buttons {
            margin-top: 20px;
            text-align: right;
        }

        .success-popup-buttons button {
            margin-left: 10px;
        }

        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <div class="top-bar">
                <div class="logo" style="width: 80px; height: 80px; border-radius: 50%; overflow: hidden;">  
                    {% if dealer.photo %}  
                        <img src="{{ dealer.photo.url }}" alt="Dealer Photo" style="width: 100%; height: 100%; object-fit: cover">  
                    {% else %}  
                     
                    {% endif %}  
                </div> 
                <div class="user-info"> 
                    <p>Welcome {{ dealer.name }} ({{ dealer.city}} - {{ dealer.state}})</p>
                    <p id="currentDateTime"></p>  
                </div>  
                <div class="search-bar">
                    <input type="text" id="searchCNote" placeholder="Search CNote Number" />
                    <button id="searchButton">Search</button>
                </div>
                <form action="{% url 'logout' %}" method="post" class="logout-button">
                    {% csrf_token %}
                    <button type="submit" id="logoutBtn">Logout</button>
                </form>
            </div>
        </div>
    </header>

    <nav>
       <!-- <ul>
            <li>
                <a href="#"><i class="fas fa-home"></i> Home</a>
            </li>
            <li>
                <a href="#"><i class="fas fa-cogs"></i> Operations</a>
                <ul>
                    <li>
                        <a href="{% url 'dealer:create_cnotes' %}"> Booking</a>
                    </li>
                    <li>
                        <a href="{% url 'dealer:loading_sheet' %}"> Loading Sheet</a>
                    </li>
                    <li>
                        <a href="#">Operation 3</a>
                    </li>
                </ul>
            </li>
            <li>
                <a href="{% url 'dealer:search' %}"><i class="fas fa-search"></i> Search</a>
            </li>
            <li>
                <a href="{% url 'dealer:booking_register' %}"><i class="fas fa-chart-bar"></i> Report</a>
                <ul>
                    <li><a href="{% url 'dealer:booking_register' %}">Booking Register</a></li>
                    <li><a href="#">Report 2</a></li>
                    <li><a href="#">Report 3</a></li>
                </ul>
            </li>
            <li>
                <a href="#"><i class="fas fa-user"></i> Profile</a>
                <ul>
                    <li><a href="#">Edit Profile</a></li>
                    <li><a href="#">Change Password</a></li>
                    <li><a href="#">Logout</a></li>
                </ul>
            </li>
            <li>
                <a href="#"><i class="fas fa-tasks"></i> Masters</a>
                <ul>
                    <li><a href="#">Master 1</a></li>
                    <li><a href="#">Master 2</a></li>
                    <li><a href="#">Master 3</a></li>
                </ul>
            </li>
            <li>
                <a href="#"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
                <ul>
                    <li><a href="#">Overview</a></li>
                    <li><a href="#">Analytics</a></li>
                    <li><a href="#">Reports</a></li>
                </ul>
            </li>
        </ul>-->
    </nav>
    <div class="content">
        <div class="search-section">
            <div class="search-controls">
                <div class="search-controls-row">
                    <select id="select-destination">
                        <option value="">Select Destination</option>
                    </select>
                </div>
                <div class="search-controls-row">
                    <div class="cnote-input-container">
                        <input id="cnote-number" placeholder="CNote Number" type="text"/>
                        <div id="message-popup" class="message-popup"></div>
                    </div>
                    <button onclick="searchData()">Search</button>
                </div>
            </div>
        </div>
        <h2>Pending CNotes For Dispatch</h2>
        <div class="table-container">
            <table id="main-table">
                <thead>
                    <tr>
                        <th><input type="checkbox" id="select-all" onclick="toggleSelectAll(this)"></th>
                        <th>SR</th>
                        <th>Bkg/Unloading Date</th>
                        <th>CNote Number</th>
                        <th>Destination</th> 
                        <th>Consignor</th>
                        <th>Consignee</th>
                        <th>Total Art</th>
                        <th>Weight</th>
                        <th>CNote Type</th>
                        <th>Grand Total</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Data will be populated here -->
                </tbody>
                <tfoot>
                    <tr>
                        <td colspan="7"><strong>Totals:</strong></td>
                        <td id="total-art">0</td>
                        <td id="total-weight">0</td>
                        <td></td>
                        <td id="total-amount">0</td>
                    </tr>
                </tfoot>
            </table>
        </div>
        <div class="footer">
            <button onclick="cancel()">Cancel</button>
            <button onclick="assignTransporters()">Assign Transporters</button>
        </div>
    </div>
    <div class="overlay" id="overlay"></div>
    <div class="popup" id="search-popup">
        <span class="close" onclick="closePopup('search-popup')">&times;</span>
        <h2>Search Results</h2>
        <div class="filter-row">
            <input type="text" placeholder="Filter SR" id="filter-sr">
            <input type="text" placeholder="Filter Date" id="filter-date">
            <input type="text" placeholder="Filter CNote Number" id="filter-cnote">
            <input type="text" placeholder="Filter Destination" id="filter-destination">
            <input type="text" placeholder="Filter Consignor" id="filter-consignor">
            <input type="text" placeholder="Filter Consignee" id="filter-consignee">
            <input type="text" placeholder="Filter Total Art" id="filter-total-art">
            <input type="text" placeholder="Filter Weight" id="filter-weight">
            <input type="text" placeholder="Filter CNote Type" id="filter-cnote-type">
            <input type="text" placeholder="Filter Grand Total" id="filter-grand-total">
        </div>
        <div class="table-container">
            <table id="popup-table">
                <thead>
                    <tr>
                        <th><input type="checkbox" id="select-all-popup" onclick="toggleSelectAllPopup(this)"></th>
                        <th>SR</th>
                        <th>Bkg/Unloading Date</th>
                        <th>CNote Number</th>
                        <th>Destination</th> 
                        <th>Consignor</th>
                        <th>Consignee</th>
                        <th>Total Art</th>
                        <th>Weight</th>
                        <th>CNote Type</th>
                        <th>Grand Total</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Search results will be populated here -->
                </tbody>
            </table>
        </div>
        <div class="footer">
            <button onclick="addSelectedData()">Add Selected</button>
        </div>
    </div>
    <div class="popup" id="assign-transporter-popup">
        <span class="close" onclick="closePopup('assign-transporter-popup')">&times;</span>
        <h2>Assign Transporter</h2>
        <form id="pickup-request-form" method="POST" action="{% url 'dealer:send_pickup_request' %}">
            {% csrf_token %}
            <select id="select-transporter" name="transporter_name" required>
                <option value="">Select Transporter</option>
                {% for transporter in transporters %}
                    <option value="{{ transporter.name }}">{{ transporter.name }}</option>
                {% endfor %}                
            </select>
            <input type="hidden" name="cnote_ids" id="selected-cnote-ids">
            <button type="submit">Send Pickup Request</button>
        </form>
    </div>
    <div class="sms-popup" id="sms-popup">
        <p>Please select at least one CNote to assign a transporter.</p>
        <button onclick="closeSmsPopup()">OK</button>
    </div>

    <div class="overlay" id="overlay"></div>
    <div class="success-popup" id="success-popup">
        <h2>लोडिंग शीट सफलतापूर्वक जनरेट हो गई है</h2>
        <p>आपकी लोडिंग शीट नंबर <span id="loading-sheet-number"></span> चुने गए CNotes के साथ जनरेट हो गई है।</p>
        <div class="success-popup-buttons">
            <button onclick="savePDF()">Save as PDF</button>
            <button onclick="printLoadingSheet()">Print</button>
        </div>
    </div>

    <script>
        let data = [];
        let addedCNoteNumbers = new Set();

        document.addEventListener("DOMContentLoaded", function() {
            console.log("DOM fully loaded");
            fetchPendingCNotes();
            fetchTransporters();
            // ✅ Ensure filter works when user types
            document.querySelectorAll('.filter-row input').forEach(input => {
                input.addEventListener('input', function() {
                    console.log("Filtering:", input.id, input.value);
                    filterPopupTable();
                });
            });
        });
        function fetchPendingCNotes() {
            fetch('/dealer/api/fetch_pending_cnotes/')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(cnotes => {
                    console.log('Fetched data:', cnotes);
                    data = cnotes;
                    populateDestinationOptions();
                })
                .catch(error => {
                    console.error('Error fetching CNotes:', error);
                    showMessage('Error fetching data. Please try again.');
                });
        }

        function populateDestinationOptions() {
            const selectDestination = document.getElementById('select-destination');
            const destinations = [...new Set(data.map(item => item.delivery_destination__destination_name))].filter(Boolean);
            selectDestination.innerHTML = `<option value="">Select Destination</option>`;
            destinations.forEach(destination => {
                const option = document.createElement('option');
                option.value = destination;
                option.textContent = destination;
                selectDestination.appendChild(option);
            });
            console.log('Populated destinations:', destinations);
        }

        function renderTable(tableId, cnotes) {
            const tableBody = document.getElementById(tableId).getElementsByTagName('tbody')[0];
            tableBody.innerHTML = '';
            cnotes.forEach((item, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><input type="checkbox" data-sr="${item.id}"></td>
                    <td>${index + 1}</td>
                    <td>${new Date(item.created_at).toLocaleDateString()}</td>
                    <td>${item.cnote_number}</td>
                    <td>${item.delivery_destination__destination_name || ''}</td>
                    <td>${item.consignor_name}</td>
                    <td>${item.consignee_name}</td>
                    <td>${item.total_articles}</td>  <!-- ✅ Corrected: Now using total_articles -->
                    <td>${item.actual_weight}</td>
                    <td>${item.payment_type}</td>
                    <td>${item.grand_total}</td>
                `;
                tableBody.appendChild(row);
            });
            if (tableId === 'main-table') {
                updateTotals();
            }
        }

        function searchData() {
            const destination = document.getElementById('select-destination').value;
            const cnoteNumber = document.getElementById('cnote-number').value;
            

            const filteredData = data.filter(item => {
                return (!destination || item.delivery_destination__destination_name === destination) &&
                    (!cnoteNumber || item.cnote_number.includes(cnoteNumber)) &&
                    !addedCNoteNumbers.has(item.cnote_number);
            });

            renderTable('popup-table', filteredData);
            showPopup('search-popup');
        }

        function filterPopupTable() {
            const filters = {
                sr: document.getElementById('filter-sr').value.toLowerCase(),
                date: document.getElementById('filter-date').value.toLowerCase(),
                cnoteNumber: document.getElementById('filter-cnote').value.toLowerCase(),
                destination: document.getElementById('filter-destination').value.toLowerCase(),
                consignor: document.getElementById('filter-consignor').value.toLowerCase(),
                consignee: document.getElementById('filter-consignee').value.toLowerCase(),
                totalArt: document.getElementById('filter-total-art').value.toLowerCase(),
                weight: document.getElementById('filter-weight').value.toLowerCase(),
                cnoteType: document.getElementById('filter-cnote-type').value.toLowerCase(),
                grandTotal: document.getElementById('filter-grand-total').value.toLowerCase()
            };

            const filteredData = data.filter(item => {
                return (
                    (!filters.sr || item.id.toString().toLowerCase().includes(filters.sr)) &&
                    (!filters.date || item.created_at.toString().toLowerCase().includes(filters.date)) &&
                    (!filters.cnoteNumber || item.cnote_number.toLowerCase().includes(filters.cnoteNumber)) &&
                    (!filters.destination || item.delivery_destination__destination_name?.toLowerCase().includes(filters.destination)) &&
                    (!filters.consignor || item.consignor_name.toLowerCase().includes(filters.consignor)) &&
                    (!filters.consignee || item.consignee_name.toLowerCase().includes(filters.consignee)) &&
                    (!filters.totalArt || (item.total_articles || '0').toString().toLowerCase().includes(filters.totalArt)) &&
                    (!filters.weight || (item.actual_weight || '0').toString().toLowerCase().includes(filters.weight)) &&
                    (!filters.cnoteType || item.payment_type.toLowerCase().includes(filters.cnoteType)) &&
                    (!filters.grandTotal || (item.grand_total || '0').toString().toLowerCase().includes(filters.grandTotal))
                );
            });
            

            renderTable('popup-table', filteredData);
            console.log("Filters applied:", filters);
            console.log("Filtered Data:", filteredData);

        }

        function showPopup(popupId) {
            document.getElementById(popupId).style.display = 'block';
            document.getElementById('overlay').style.display = 'block';
        }

        function closePopup(popupId) {
            document.getElementById(popupId).style.display = 'none';
            document.getElementById('overlay').style.display = 'none';
        }

        function addSelectedData() {
            const popupTableBody = document.getElementById('popup-table').getElementsByTagName('tbody')[0];
            const checkboxes = popupTableBody.querySelectorAll('input[type="checkbox"]:checked');

            const selectedItems = Array.from(checkboxes).map(checkbox => {
                const row = checkbox.closest('tr');
                const cnoteNumber = row.cells[3].innerText;
                addedCNoteNumbers.add(cnoteNumber);
                return data.find(item => item.cnote_number === cnoteNumber);
            });

            const currentMainTableData = Array.from(document.getElementById('main-table').getElementsByTagName('tbody')[0].rows)
                .map(row => data.find(item => item.cnote_number === row.cells[3].innerText));

            renderTable('main-table', [...currentMainTableData, ...selectedItems]);
            closePopup('search-popup');
        }

        function updateTotals() {
            const mainTableBody = document.getElementById('main-table').getElementsByTagName('tbody')[0];
            const rows = mainTableBody.getElementsByTagName('tr');

            let totalArt = 0;
            let totalWeight = 0;
            let totalAmount = 0;

            for (let i = 0; i < rows.length; i++) {
                const cells = rows[i].getElementsByTagName('td');
                totalArt += parseInt(cells[7].innerText) || 0;
                totalWeight += parseFloat(cells[8].innerText) || 0;
                totalAmount += parseFloat(cells[10].innerText) || 0;
            }

            document.getElementById('total-art').innerText = totalArt;
            document.getElementById('total-weight').innerText = totalWeight.toFixed(2);
            document.getElementById('total-amount').innerText = totalAmount.toFixed(2);
        }

        function toggleSelectAll(source) {
            const checkboxes = document.querySelectorAll('#main-table tbody input[type="checkbox"]');
            checkboxes.forEach(checkbox => checkbox.checked = source.checked);
        }

        function toggleSelectAllPopup(source) {
            const checkboxes = document.querySelectorAll('#popup-table tbody input[type="checkbox"]');
            checkboxes.forEach(checkbox => checkbox.checked = source.checked);
        }

        function assignTransporters() {
            const selectedCNotes = Array.from(document.querySelectorAll('#main-table input[type="checkbox"]:checked'));
            if (selectedCNotes.length === 0) {
                showSmsPopup();
                return;
            }
            const cnoteIds = selectedCNotes.map(checkbox => checkbox.getAttribute('data-sr')).filter(id => id); 
            
            console.log("Collected CNote IDs:", cnoteIds);

            document.getElementById('selected-cnote-ids').value = cnoteIds.join(',');
            
            showPopup('assign-transporter-popup');
        }
        
        function showSuccessPopup(loadingSheetId) {
            document.getElementById('loading-sheet-number').textContent = loadingSheetId;
            document.getElementById('success-popup').style.display = 'block';
            document.getElementById('overlay').style.display = 'block';
        }

        function savePDF() {
            const loadingSheetNumber = document.getElementById('loading-sheet-number').textContent;
            fetch(`/dealer/api/generate_pdf/${loadingSheetNumber}/`, {
                method: 'GET',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                }
            })
            .then(response => response.blob())
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = `loading_sheet_${loadingSheetNumber}.pdf`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
            })
            .catch(error => {
                console.error('Error generating PDF:', error);
                showMessage('Failed to generate PDF. Please try again.');
            });
            closeSuccessPopup();
        }

        function printLoadingSheet() {
            const loadingSheetNumber = document.getElementById('loading-sheet-number').textContent;
            const selectedCNotes = Array.from(document.querySelectorAll('#main-table input[type="checkbox"]:checked'))
                .map(checkbox => {
                    const row = checkbox.closest('tr');
                    return {
                        cnoteNumber: row.cells[3].innerText,
                        destination: row.cells[4].innerText,
                        consignee: row.cells[6].innerText,
                        totalArt: row.cells[7].innerText,
                        weight: row.cells[8].innerText,
                        amount: row.cells[10].innerText
                    };
                });
            
            sessionStorage.setItem('mfPrintData', JSON.stringify(selectedCNotes));
            sessionStorage.setItem('loadingSheetNumber', loadingSheetNumber);
            
            const printWindow = window.open('/dealer/mf_print/', '_blank');
            
            closeSuccessPopup();
        }

        function closeSuccessPopup() {
            document.getElementById('success-popup').style.display = 'none';
            document.getElementById('overlay').style.display = 'none';
        }

        function fetchTransporters() {
            fetch('/dealer/api/fetch_transporters/', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/xml',
                },
            })
            .then(response => response.text())
            .then(str => (new window.DOMParser()).parseFromString(str, "text/xml"))
            .then(data => {
                const transporters = data.getElementsByTagName('transporter');
                const selectTransporter = document.getElementById('select-transporter');
                selectTransporter.innerHTML = '<option value="">Select Transporter</option>';
                
                for (let transporter of transporters) {
                    const id = transporter.getAttribute('id');
                    const name = transporter.getElementsByTagName('name')[0].textContent;
                    const option = document.createElement('option');
                    option.value = name;
                    option.textContent = name;
                    selectTransporter.appendChild(option);
                }
            })
            .catch(error => {
                console.error('Error fetching transporters:', error);
            });
        }
        
        document.addEventListener('DOMContentLoaded', fetchTransporters);
        
        function showSmsPopup() {
            const smsPopup = document.getElementById('sms-popup');
            smsPopup.style.display = 'block';
            document.getElementById('overlay').style.display = 'block';
        }

        function closeSmsPopup() {
            document.getElementById('sms-popup').style.display = 'none';
            document.getElementById('overlay').style.display = 'none';
        }

        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('pickup-request-form');
            form.addEventListener('submit', function(event) {
                event.preventDefault();
                sendPickupRequest();
            });
        });
        
        function sendPickupRequest() {
            const form = document.getElementById('pickup-request-form');
            const formData = new FormData(form);
            const transporterName = formData.get('transporter_name');
            const selectedCNotes = Array.from(document.querySelectorAll('#main-table input[type="checkbox"]:checked'))
                .map(checkbox => {
                    const row = checkbox.closest('tr');
                    return {
                        id: checkbox.getAttribute('data-sr'),
                        cnoteNumber: row.cells[3].innerText,
                        destination: row.cells[4].innerText,
                        consignor: row.cells[5].innerText,
                        consignee: row.cells[6].innerText,
                        totalArt: row.cells[7].innerText,
                        weight: row.cells[8].innerText,
                        cnoteType: row.cells[9].innerText,
                        grandTotal: row.cells[10].innerText
                    };
                });

            if (selectedCNotes.length === 0) {
                alert('Please select at least one CNote.');
                return;
            }

            if (!transporterName) {
                alert('Please select a transporter.');
                return;
            }

            const updatedFormData = new FormData(form);
            const cnoteIds = selectedCNotes.map(cnote => cnote.id).filter(id => id);
            updatedFormData.set('cnote_ids', cnoteIds.join(','));

            sessionStorage.setItem('mfPrintData', JSON.stringify(selectedCNotes));
            sessionStorage.setItem('transporterName', transporterName);

            fetch(form.action, {
                method: 'POST',
                body: updatedFormData,
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                },
                redirect: 'follow'
            })
            .then(response => {
                if (response.redirected) {
                    // First update the UI
                    closePopup('assign-transporter-popup');
                    
                    // Remove selected rows
                    selectedCNotes.forEach(cnote => {
                        const row = document.querySelector(`#main-table tr td input[data-sr="${cnote.id}"]`);
                        if (row && row.closest('tr')) {
                            row.closest('tr').remove();
                        }
                    });
                    
                    updateTotals();
                    fetchPendingCNotes();

                    // Then open the new window
                    window.open(response.url, '_blank');
                    return { success: true };
                }
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                if (data.error) {
                    throw new Error(data.error);
                }
                
                if (!data.success) {
                    console.log('Loading sheet created:', data);
                    
                    closePopup('assign-transporter-popup');
                    
                    // Only try to remove rows if they exist
                    selectedCNotes.forEach(cnote => {
                        const row = document.querySelector(`#main-table tr td input[data-sr="${cnote.id}"]`);
                        if (row && row.closest('tr')) {
                            row.closest('tr').remove();
                        }
                    });
                    
                    updateTotals();
                    
                    if (data.loading_sheet_id) {
                        showSuccessPopup(data.loading_sheet_id);
                    }
                    
                    fetchPendingCNotes();
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while sending the pickup request: ' + error.message);
            });
        }

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        function cancel() {
            const mainTableBody = document.getElementById('main-table').getElementsByTagName('tbody')[0];
            mainTableBody.innerHTML = '';
            document.getElementById('total-art').innerText = '0';
            document.getElementById('total-weight').innerText = '0';
            document.getElementById('total-amount').innerText = '0';
            addedCNoteNumbers.clear();
            document.getElementById('select-destination').value = '';
            document.getElementById('cnote-number').value = '';
        }

        function showMessage(message) {
            const messagePopup = document.getElementById('message-popup');
            messagePopup.textContent = message;
            messagePopup.style.display = 'block';
            setTimeout(() => {
                messagePopup.style.display = 'none';
            }, 3000);
        }

        function updateDateTime() {
            const now = new Date();
            const dateTimeString = now.toLocaleString('en-US', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            document.getElementById('currentDateTime').textContent = dateTimeString;
        }

        setInterval(updateDateTime, 1000);
        updateDateTime();

        function cancelLoadingSheet() {
            const loadingSheetId = getCurrentLoadingSheetId(); 
            if (confirm('Are you sure you want to cancel this loading sheet? This action cannot be undone.')) {
                fetch(`/dealer/api/cancel_loading_sheet/${loadingSheetId}/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken'),
                        'Content-Type': 'application/json',
                    },
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Loading sheet cancelled successfully. CNotes have been reverted to their previous state.');
                        location.reload(); 
                    } else {
                        alert('Error cancelling loading sheet: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while cancelling the loading sheet.');
                });
            }
        }

        function getCurrentLoadingSheetId() {
            return document.getElementById('current-loading-sheet-id').value;
        }

        document.getElementById('contactSupport').addEventListener('click', function(e) {
            e.preventDefault();
            alert('Please contact support at support@example.com or call 1-800-SUPPORT');
        });

        document.getElementById('searchButton').addEventListener('click', function() {
            const searchTerm = document.getElementById('searchCNote').value;
            console.log('Searching for:', searchTerm);
        });

        window.addEventListener('message', function(event) {
            if (event.data === 'reloadLoadingSheet') {
                location.reload();
            }
        });
    </script>
    <input type="hidden" id="current-loading-sheet-id" value="123">
</body>
</html>

