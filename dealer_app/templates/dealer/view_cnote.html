<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CNote Details - Logistics Management System</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <style>
        * {
          box-sizing: border-box;
          margin: 0;
          padding: 0;
        }
        body {
          font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
          line-height: 1.6;
          background-color: #f0f8ff;
          color: #333;
        }
        .container {
          max-width: 1400px;
          margin: 0 auto;
        }
        header {
          background-color: #87ceeb;
          color: #333;
          box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        .top-bar {
          display: flex;
          justify-content: flex-end;
          align-items: center;
          padding: 0 20px;
        }
        .user-info {
          text-align: center;
          flex-grow: 1;
        }
        .search-bar input {
          width: 200px;
          padding: 8px;
          border: none;
          outline: none;
          font-size: 14px;
        }
        .search-bar button {
          padding: 8px 15px;
          background-color: #4682b4;
          color: white;
          border: none;
          border-radius: 20px;
          cursor: pointer;
          transition: background-color 0.3s;
        }
        .search-bar button:hover {
          background-color: #36648b;
        }
        nav {
          background-color: #4682b4;
          padding: 10px 0;
        }
        nav ul {
          list-style-type: none;
          display: flex;
          justify-content: space-around;
          flex-wrap: wrap;
        }
        nav ul li a {
          color: white;
          text-decoration: none;
          padding: 5px 10px;
          border-radius: 4px;
          transition: background-color 0.3s;
        }
        nav ul li a:hover {
          background-color: #3a6d8c;
        }
        main {
          display: flex;
          flex-wrap: wrap;
          gap: 20px;
          margin-top: 20px;
        }
        .form-container,
        .charges-container {
          background-color: white;
          padding: 20px;
          border-radius: 8px;
          box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        .form-container {
          flex: 3;
          min-width: 600px;
        }
        .charges-container {
          flex: 1;
          min-width: 250px;
        }
        h2 {
          margin-bottom: 20px;
          color: #4682b4;
          border-bottom: 2px solid #4682b4;
          padding-bottom: 10px;
        }
        .form-row {
          display: flex;
          gap: 20px;
          margin-bottom: 15px;
        }
        .form-group {
          flex: 1;
        }
        label {
          display: block;
          margin-bottom: 5px;
          font-weight: bold;
        }
        input,
        select,
        textarea {
          width: 100%;
          padding: 8px;
          border: 1px solid #ddd;
          border-radius: 4px;
          font-size: 14px;
        }
        textarea {
          resize: vertical;
        }
        .required::after {
          content: " *";
          color: red;
        }
        button {
          background-color: #4682b4;
          color: white;
          padding: 10px 15px;
          border: none;
          border-radius: 4px;
          cursor: pointer;
          transition: background-color 0.3s;
        }
        button:hover {
          background-color: #3a6d8c;
        }
        table {
          width: 100%;
          border-collapse: collapse;
          margin-bottom: 20px;
        }
        th,
        td {
          border: 1px solid #ddd;
          padding: 8px;
          text-align: left;
          font-size: 14px;
        }
        th {
          background-color: #4682b4;
          color: white;
        }
        .search-bar {
          display: flex;
          align-items: center;
          background-color: #ffffff;
          border-radius: 20px;
          padding: 5px 10px;
          box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        } 
        .logout-button {  
          position: absolute;  
          right: 8px;  
          top: 10px;  
        }
        .logout-button button {
          background-color: #ff4500;
          color: white;
          padding: 9px 18px;
          border: none;
          border-radius: 20px;
          cursor: pointer;
          transition: background-color 0.3s;
        }
        .logout-button button:hover {
          background-color: #e63900;
        }
        .status-indicator {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 4px;
            font-weight: bold;
            margin-top: 10px;
        }
        .status-booked { background-color: #ffd700; color: #000; }
        .status-dispatched { background-color: #1e90ff; color: #fff; }
        .status-received { background-color: #32cd32; color: #fff; }
        .status-due-for-delivery { background-color: #ff8c00; color: #fff; }
        .status-delivered { background-color: #008000; color: #fff; }
        .status-received-at-godown { background-color: #4b0082; color: #fff; }
        .status-cancelled { background-color: #ff0000; color: #fff; }
        .search-container {
            position: relative;
            width: 100%;
        }
        .search-input {
            width: 100%;
            padding: 10px;
            padding-right: 30px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .dropdown-arrow {
            position: absolute;
            top: 50%;
            right: 10px;
            transform: translateY(-50%);
            cursor: pointer;
        }
        .dropdown-list {
            position: absolute;
            top: 100%;
            left: 0;
            width: 100%;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ccc;
            border-top: none;
            background: white;
            z-index: 1000;
            display: none;
        }
        .dropdown-item {
            padding: 10px;
            cursor: pointer;
        }
        .dropdown-item:hover,
        .dropdown-item.active {
            background-color: #f0f0f0;
        }
        .article-container {
            margin-bottom: 20px;
        }
        .summary-container {
            background-color: #f0f0f0;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
        }
        .summary-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }
        .summary-row span:first-child {
            font-weight: bold;
        }
        #articleTable {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        #articleTable th, #articleTable td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        #articleTable th {
            background-color: #4682b4;
            color: white;
        }
        #addArticle, .remove-article, #saveCNoteBtn {
            background-color: #4682b4;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
        }
        #addArticle:hover, .remove-article:hover, #saveCNoteBtn:hover {
            background-color: #3a6d8c;
        }
        .remove-article {
            background-color: #ff4500;
        }
        .remove-article:hover {
            background-color: #e63900;
        }
        #editFreightBtn {
            background-color: #4682b4;
            color: white;
            padding: 5px 10px;
            margin-left: 5px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        #editFreightBtn:hover {
            background-color: #3a6d8c;
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <div class="top-bar">
                <div class="user-info" style="text-align: left; margin-left: 0px;">
                    <p>Welcome {{ dealer.name }} ({{ dealer.city }} - {{ dealer.state }})</p>
                    <p id="currentDateTime" style="margin-top: 5px;"></p>  
                </div>
                {% if messages %}
                <ul class="messages">
                    {% for message in messages %}
                    <li{% if message.tags %} class="{{ message.tags }}"{% endif %}>{{ message }}</li>
                    {% endfor %}
                </ul>
                {% endif %}
                <div class="search-bar">
                    <form method="GET" action="{% url 'dealer:search_cnote' %}">
                        <input type="text" id="searchCNote" name="cnote_number" placeholder="Search CNote Number" required />
                        <button type="submit" id="searchButton">Search</button>
                    </form>
                </div>
                <div id="errorMessage" class="error-message" style="display: none;"></div>
                <form action="{% url 'logout' %}" method="post" class="logout-button">
                    {% csrf_token %}
                    <button type="submit" id="logoutBtn">Logout</button>
                </form>
            </div>
        </div>
    </header>
    <nav>
        <ul>
            <li>
                <a href="{% url 'dealer:create_cnotes' %}"><i class="fas fa-home"></i> Go To Booking Page</a>
            </li>
        </ul>
    </nav>
    <div class="container">
        <main>
            <div class="form-container">
                <h2>CNote Details</h2>
                <input type="hidden" id="hasCNote" value="{% if cnote %}true{% else %}false{% endif %}" />
                {% if cnote %}
                    <button id="printNoteBtn">Print Note</button>
                    <form id="cnoteDetailsForm">
                        {% csrf_token %}
                        <div class="form-row">
                            <div class="form-group">
                                <label for="cnoteNumber">CNote Number</label>
                                <input type="text" id="cnoteNumber" name="cnote_number" value="{{ cnote.cnote_number }}" readonly />
                            </div>
                            <div class="form-group">
                                <label for="createdAt">Created At</label>
                                <input type="text" id="createdAt" name="created_at" value="{{ cnote.created_at|date:'Y-m-d H:i:s' }}" readonly />
                            </div>
                            <div class="form-group">
                                <label for="status">Status</label>
                                <input type="text" id="status" name="status" value="{{ cnote.get_status_display }}" readonly />
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="fromCity">From City</label>
                                <input type="text" id="fromCity" name="from_city" value="{{ dealer.city }}" readonly />
                            </div>
                            <div class="form-group">
                                <label for="deliveryDestination" class="required">Delivery Destination</label>
                                <div class="search-container">
                                    <input 
                                        type="text" 
                                        class="search-input" 
                                        placeholder="Search or select destination" 
                                        id="deliveryDestination"
                                        name="delivery_destination"
                                        required
                                        value="{{ cnote.delivery_destination.destination_name }}"
                                        data-destination-id="{{ cnote.delivery_destination.id }}"
                                    >
                                    <input 
                                        type="hidden" 
                                        id="deliveryDestinationId" 
                                        name="delivery_destination_id" 
                                        value="{{ cnote.delivery_destination.id }}"
                                    >
                                    <span class="dropdown-arrow" id="dropdownArrow">â–¾</span>
                                    <div class="dropdown-list" id="dropdownList"></div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="fromDealer">From Dealer</label>
                                <input type="text" id="fromDealer" name="from_dealer" value="{{ dealer.name }}" readonly />
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="bookingType">Booking Type</label>
                                <select id="bookingType" name="booking_type" disabled>
                                    <option value="sundry" {% if cnote.booking_type == 'sundry' %}selected{% endif %}>Sundry</option>
                                    <option value="other" {% if cnote.booking_type == 'other' %}selected{% endif %}>Other</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="paymentType">Payment Type</label>
                                <input type="text" id="paymentType" name="payment_type" value="{{ cnote.payment_type|upper }}" readonly />
                            </div>
                            <div class="form-group">
                                <label for="deliveryMethod">Delivery Method</label>
                                <select id="deliveryMethod" name="delivery_method" disabled>
                                    <option value="door" {% if cnote.delivery_method == 'door' %}selected{% endif %}>Door Delivery</option>
                                    <option value="godown" {% if cnote.delivery_method == 'godown' %}selected{% endif %}>Godown Delivery</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="actualWt">Actual Weight</label>
                                <input type="number" step="0.01" id="actualWt" name="actual_weight" value="{{ cnote.actual_weight }}" />
                            </div>
                            <div class="form-group">
                                <label for="chargedWt">Charged Weight</label>
                                <input type="number" step="0.01" id="chargedWt" name="charged_weight" value="{{ cnote.charged_weight }}" />
                            </div>
                            <div class="form-group">
                                <label for="totalAmt">Total Amount</label>
                                <input type="text" id="totalAmt" name="total_amount" value="{{ cnote.grand_total }}" readonly />
                            </div>
                        </div>
                        <h3>Consignor Details</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="consignorName">Consignor Name</label>
                                <input type="text" id="consignorName" name="consignor_name" value="{{ cnote.consignor_name }}" disabled />
                            </div>
                            <div class="form-group">
                                <label for="consignorMobile">Consignor Mobile</label>
                                <input type="text" id="consignorMobile" name="consignor_mobile" value="{{ cnote.consignor_mobile }}" disabled />
                            </div>
                            <div class="form-group">
                                <label for="consignorGST">Consignor GST</label>
                                <input type="text" id="consignorGST" name="consignor_gst" value="{{ cnote.consignor_gst }}" disabled />
                            </div>
                        </div>
                        <h3>Consignee Details</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="consigneeName">Consignee Name</label>
                                <input type="text" id="consigneeName" name="consignee_name" value="{{ cnote.consignee_name }}" disabled />
                            </div>
                            <div class="form-group">
                                <label for="consigneeMobile">Consignee Mobile</label>
                                <input type="text" id="consigneeMobile" name="consignee_mobile" value="{{ cnote.consignee_mobile }}" disabled />
                            </div>
                            <div class="form-group">
                                <label for="consigneeGST">Consignee GST</label>
                                <input type="text" id="consigneeGST" name="consignee_gst" value="{{ cnote.consignee_gst }}" disabled />
                            </div>
                        </div>
                        <h3>Article Details</h3>
                        <div class="article-container">
                            <table id="articleTable">
                                <thead>
                                    <tr>
                                        <th>Article Type</th>
                                        <th>Quantity</th>
                                        <th>Description</th>
                                        <th>Amount</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for article in articles %}
                                    <tr data-article-id="{{ article.id }}">
                                        <td>
                                            <select name="art_type[]" class="art-type" required>
                                                <option value="">Select Article Type</option>
                                                {% for art_type in art_types %}
                                                <option value="{{ art_type.id }}" 
                                                    {% if article.art_type and article.art_type.id == art_type.id %}selected{% endif %}>
                                                    {{ art_type.art_type_name }}
                                                </option>
                                                {% endfor %}
                                            </select>
                                        </td>
                                        <td>
                                            <input type="number" name="quantity[]" class="quantity" value="{{ article.art }}" required />
                                        </td>
                                        <td>
                                            <input type="text" name="description[]" class="description" value="{{ article.said_to_contain }}" required />
                                        </td>
                                        <td>
                                            <input type="number" name="amount[]" class="amount" value="{{ article.art_amount }}" step="0.01" required />
                                        </td>
                                        <td>
                                            <button type="button" class="remove-article">Remove</button>
                                        </td>
                                    </tr>
                                    {% empty %}
                                    <tr>
                                        <td colspan="5">No articles found.</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                            <button type="button" id="addArticle">Add Article</button>
                            <button type="button" id="saveCNoteBtn" style="margin-left: 10px;">Update and Save</button>
                        </div>
                        <div class="summary-container">
                            <div class="summary-row">
                                <span>Total Quantity:</span>
                                <span id="totalQuantity">0</span>
                            </div>
                            <div class="summary-row">
                                <span>Total Amount:</span>
                                <span id="totalAmount">0.00</span>
                            </div>
                        </div>
                    </form>
                {% else %}
                    <p>No CNote details available for the provided number.</p>
                {% endif %}
            </div>
            {% if cnote %}
            <div class="charges-container">
                <h2>Charges</h2>
                <table>
                    <tr>
                        <td>Freight</td>
                        <td>
                            <input type="number" step="0.01" name="freight" id="freightInput" value="{{ cnote.freight }}" readonly />
                            <button type="button" id="editFreightBtn">Edit Freight</button>
                        </td>
                    </tr>
                    <tr><td>Docket Charge</td><td><input type="number" step="0.01" name="docket_charge" value="{{ cnote.docket_charge }}" /></td></tr>
                    <tr><td>Door Delivery Charge</td><td><input type="number" step="0.01" name="door_delivery_charge" value="{{ cnote.door_delivery_charge }}" /></td></tr>
                    <tr><td>Handling Charge</td><td><input type="number" step="0.01" name="handling_charge" value="{{ cnote.handling_charge }}" /></td></tr>
                    <tr><td>Pickup Charge</td><td><input type="number" step="0.01" name="pickup_charge" value="{{ cnote.pickup_charge }}" /></td></tr>
                    <tr><td>Transhipment Charge</td><td><input type="number" step="0.01" name="transhipment_charge" value="{{ cnote.transhipment_charge }}" /></td></tr>
                    <tr><td>Insurance</td><td><input type="number" step="0.01" name="insurance" value="{{ cnote.insurance }}" /></td></tr>
                    <tr><td>Fuel Surcharge</td><td><input type="number" step="0.01" name="fuel_surcharge" value="{{ cnote.fuel_surcharge }}" /></td></tr>
                    <tr><td>Commission</td><td><input type="number" step="0.01" name="commission" value="{{ cnote.commission }}" /></td></tr>
                    <tr><td>Other Charge</td><td><input type="number" step="0.01" name="other_charge" value="{{ cnote.other_charge }}" /></td></tr>
                    <tr><td>Carrier Risk</td><td><input type="number" step_checkpoint="0.01" name="carrier_risk" value="{{ cnote.carrier_risk }}" /></td></tr>
                    <tr>
                        <td><strong>Grand Total</strong></td>
                        <td><strong><input type="number" step="0.01" name="grand_total" id="grandTotalInput" value="{{ cnote.grand_total }}" readonly /></strong></td>
                    </tr>
                </table>
            </div>
            {% endif %}
        </main>
    </div>
    {% if cnote %}
    <div class="status-update-container" style="margin-top: 20px;">
        <h3>Update CNote Status</h3>
        <form action="{% url 'dealer:update_cnote_status' cnote.id %}" method="post">
            {% csrf_token %}
            <select name="status">
                {% for status, label in cnote.STATUS_CHOICES %}
                    <option value="{{ status }}" {% if status == cnote.status %}selected{% endif %}>{{ label }}</option>
                {% endfor %}
            </select>
            <button type="submit">Update Status</button>
        </form>
    </div>
    {% endif %}
    {{ art_types_json | json_script:"art-types" }}
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            let artTypes = [];
            const artTypesElement = document.getElementById("art-types");
            if (artTypesElement) {
                try {
                    artTypes = JSON.parse(artTypesElement.textContent);
                } catch (e) {
                    console.error("Error parsing artTypes JSON:", e);
                }
            }

            function updateDateTime() {
                const now = new Date();
                const dateTimeString = now.toLocaleString("en-US", {
                    day: "2-digit",
                    month: "2-digit",
                    year: "numeric",
                    hour: "2-digit",
                    minute: "2-digit",
                    second: "2-digit",
                    hour12: true
                });
                const currentDateTime = document.getElementById("currentDateTime");
                if (currentDateTime) currentDateTime.textContent = dateTimeString;
            }
            setInterval(updateDateTime, 1000);
            updateDateTime();

            const searchButton = document.getElementById("searchButton");
            const searchInput = document.getElementById("searchCNote");
            if (searchButton && searchInput) {
                searchButton.addEventListener("click", function() {
                    const cnoteNumber = searchInput.value.trim();
                    if (cnoteNumber) {
                        window.location.href = `/dealer/view-cnote/${encodeURIComponent(cnoteNumber)}/`;
                    } else {
                        alert("Please enter a CNote number to search.");
                    }
                });
                searchInput.addEventListener("keypress", function(event) {
                    if (event.key === "Enter") {
                        event.preventDefault();
                        searchButton.click();
                    }
                });
            }

            const hasCNoteInput = document.getElementById("hasCNote");
            const hasCNote = hasCNoteInput && hasCNoteInput.value === "true";
            if (hasCNote) {
                const printNoteBtn = document.getElementById("printNoteBtn");
                if (printNoteBtn) {
                    printNoteBtn.addEventListener("click", function() {
                        const cnoteNumberInput = document.getElementById("cnoteNumber");
                        if (cnoteNumberInput && cnoteNumberInput.value) {
                            window.location.href = `/dealer/cnote-success/${encodeURIComponent(cnoteNumberInput.value)}/`;
                        } else {
                            alert("CNote number is not available.");
                        }
                    });
                }

                const articleTable = document.getElementById("articleTable");
                const addArticleBtn = document.getElementById("addArticle");
                const saveCNoteBtn = document.getElementById("saveCNoteBtn");
                const totalQuantitySpan = document.getElementById("totalQuantity");
                const totalAmountSpan = document.getElementById("totalAmount");

                function updateTotals() {
                    if (!articleTable || !totalQuantitySpan || !totalAmountSpan) return;
                    let totalQuantity = 0;
                    let totalAmount = 0;
                    const rows = articleTable.getElementsByTagName("tbody")[0].getElementsByTagName("tr");
                    for (let i = 0; i < rows.length; i++) {
                        const quantityInput = rows[i].querySelector(".quantity");
                        const amountInput = rows[i].querySelector(".amount");
                        if (quantityInput && amountInput) {
                            totalQuantity += parseInt(quantityInput.value) || 0;
                            totalAmount += parseFloat(amountInput.value) || 0;
                        }
                    }
                    totalQuantitySpan.textContent = totalQuantity;
                    totalAmountSpan.textContent = totalAmount.toFixed(2);
                    updateFreightAndTotal();
                }

                function addArticleRow() {
                    if (!articleTable) return;
                    const tbody = articleTable.getElementsByTagName("tbody")[0];
                    const newRow = tbody.insertRow();
                    newRow.removeAttribute("data-article-id"); // Ensure new rows have no article_id
                    let options = '<option value="">Select Article Type</option>';
                    artTypes.forEach(artType => {
                        const escapedName = String(artType.name)
                            .replace(/&/g, "&amp;")
                            .replace(/</g, "&lt;")
                            .replace(/>/g, "&gt;")
                            .replace(/"/g, "&quot;")
                            .replace(/'/g, "&#39;");
                        options += `<option value="${artType.id}">${escapedName}</option>`;
                    });
                    newRow.innerHTML = `
                        <td>
                            <select name="art_type[]" class="art-type" required>
                                ${options}
                            </select>
                        </td>
                        <td><input type="number" name="quantity[]" class="quantity" required /></td>
                        <td><input type="text" name="description[]" class="description" required /></td>
                        <td><input type="number" name="amount[]" class="amount" step="0.01" required /></td>
                        <td><button type="button" class="remove-article">Remove</button></td>
                    `;
                    setupArticleRowListeners(newRow);
                    updateTotals();
                }

                function setupArticleRowListeners(row) {
                    const removeBtn = row.querySelector(".remove-article");
                    const quantityInput = row.querySelector(".quantity");
                    const amountInput = row.querySelector(".amount");
                    if (removeBtn) {
                        removeBtn.addEventListener("click", function() {
                            articleTable.getElementsByTagName("tbody")[0].removeChild(row);
                            updateTotals();
                        });
                    }
                    if (quantityInput) quantityInput.addEventListener("input", updateTotals);
                    if (amountInput) amountInput.addEventListener("input", updateTotals);
                }

                if (addArticleBtn) {
                    addArticleBtn.addEventListener("click", addArticleRow);
                    Array.from(articleTable.getElementsByTagName("tbody")[0].rows).forEach(setupArticleRowListeners);
                }

                function updateFreightAndTotal() {
                    const freightInput = document.querySelector('input[name="freight"]');
                    const grandTotalInput = document.querySelector('input[name="grand_total"]');
                    const totalAmtInput = document.getElementById("totalAmt");
                    if (!freightInput || !grandTotalInput || !totalAmtInput) return;
                    let grandTotal = parseFloat(freightInput.value) || 0;
                    document.querySelectorAll('.charges-container input[type="number"]:not([name="grand_total"]):not([name="freight"])').forEach(input => {
                        grandTotal += parseFloat(input.value) || 0;
                    });
                    grandTotalInput.value = grandTotal.toFixed(2);
                    totalAmtInput.value = grandTotal.toFixed(2);
                }

                const chargeInputs = document.querySelectorAll('.charges-container input[type="number"]:not([name="grand_total"])');
                chargeInputs.forEach(input => {
                    input.addEventListener("input", updateFreightAndTotal);
                });

                if (saveCNoteBtn) {
                    saveCNoteBtn.addEventListener("click", function() {
                        const cnoteNumberInput = document.getElementById("cnoteNumber");
                        if (!cnoteNumberInput || !cnoteNumberInput.value) {
                            alert("CNote number is not available.");
                            return;
                        }

                        const actualWtInput = document.getElementById("actualWt");
                        const chargedWtInput = document.getElementById("chargedWt");
                        const destinationIdInput = document.getElementById("deliveryDestinationId");
                        const freightInput = document.getElementById("freightInput");
                        const rows = articleTable.getElementsByTagName("tbody")[0].getElementsByTagName("tr");

                        const articles = Array.from(rows).map(row => {
                            const artTypeSelect = row.querySelector(".art-type");
                            const quantityInput = row.querySelector(".quantity");
                            const descriptionInput = row.querySelector(".description");
                            const amountInput = row.querySelector(".amount");
                            if (!artTypeSelect.value || !quantityInput.value || !descriptionInput.value || !amountInput.value) {
                                alert("Please fill all article fields.");
                                throw new Error("Incomplete article data");
                            }
                            return {
                                id: row.dataset.articleId || null, // Only include valid article_id
                                art_type: parseInt(artTypeSelect.value),
                                quantity: parseInt(quantityInput.value),
                                description: descriptionInput.value,
                                amount: amountInput.value // Send as string to avoid precision issues
                            };
                        });

                        const charges = {};
                        document.querySelectorAll('.charges-container input[type="number"]:not([name="grand_total"])').forEach(input => {
                            charges[input.name] = input.value; // Send as string
                        });

                        const data = {
                            cnote_number: cnoteNumberInput.value,
                            actual_weight: actualWtInput.value, // Send as string
                            charged_weight: chargedWtInput.value, // Send as string
                            delivery_destination_id: parseInt(destinationIdInput.value) || null,
                            articles,
                            charges
                        };

                        if (data.actual_weight < 0 || data.charged_weight < 0) {
                            alert("Weights cannot be negative.");
                            return;
                        }
                        if (!data.delivery_destination_id) {
                            alert("Please select a valid delivery destination.");
                            return;
                        }
                        if (articles.length === 0) {
                            alert("At least one article is required.");
                            return;
                        }

                        fetch("/dealer/save_cnote/", {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json",
                                "X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken]").value
                            },
                            body: JSON.stringify(data)
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                alert("CNote updated successfully!");
                                window.location.reload();
                            } else {
                                alert("Error updating CNote: " + (data.error || "Unknown error"));
                            }
                        })
                        .catch(error => {
                            console.error("Error updating CNote:", error);
                            alert("An error occurred while updating the CNote.");
                        });
                    });
                }

                const deliveryDestinationInput = document.getElementById("deliveryDestination");
                const dropdownList = document.getElementById("dropdownList");
                const dropdownArrow = document.getElementById("dropdownArrow");
                let cities = [];
                let activeIndex = -1;
                let isFullListVisible = false;

                async function fetchCities() {
                    try {
                        const response = await fetch("/dealer/fetch_cities/");
                        const data = await response.json();
                        if (data.success) {
                            cities = data.cities.map(city => ({
                                id: city.id,
                                name: city.destination_name
                            }));
                            // Do not call populateDropdown() here to avoid showing the list on page load
                        } else {
                            console.error("Error fetching cities:", data.error);
                        }
                    } catch (error) {
                        console.error("Error fetching cities:", error);
                    }
                }

                function populateDropdown(filter = "") {
                    if (!dropdownList) return;
                    dropdownList.innerHTML = "";
                    const filteredCities = filter
                        ? cities.filter(city => city.name.toLowerCase().includes(filter.toLowerCase()))
                        : cities;
                    filteredCities.forEach((city) => {
                        const div = document.createElement("div");
                        div.classList.add("dropdown-item");
                        div.textContent = city.name;
                        div.dataset.cityId = city.id;
                        div.addEventListener("click", () => {
                            if (deliveryDestinationInput) {
                                deliveryDestinationInput.value = city.name;
                                const destinationIdInput = document.getElementById("deliveryDestinationId");
                                if (destinationIdInput) destinationIdInput.value = city.id;
                            }
                            dropdownList.style.display = "none";
                            isFullListVisible = false;
                        });
                        dropdownList.appendChild(div);
                    });

                    // Only show the dropdown if the user has interacted with the input or arrow
                    if (filter || isFullListVisible) {
                        dropdownList.style.display = filteredCities.length > 0 ? "block" : "none";
                    } else {
                        dropdownList.style.display = "none"; // Ensure the dropdown is hidden by default
                    }
                    activeIndex = -1;
                }

                if (deliveryDestinationInput) {
                    deliveryDestinationInput.addEventListener("input", (e) => {
                        isFullListVisible = false; // Reset the full list visibility flag
                        populateDropdown(e.target.value);
                    });
                    deliveryDestinationInput.addEventListener("keydown", (e) => {
                        const items = Array.from(dropdownList.querySelectorAll(".dropdown-item"));
                        if (e.key === "ArrowDown") {
                            e.preventDefault();
                            activeIndex = (activeIndex + 1) % items.length;
                            updateActiveItem(items);
                        } else if (e.key === "ArrowUp") {
                            e.preventDefault();
                            activeIndex = (activeIndex - 1 + items.length) % items.length;
                            updateActiveItem(items);
                        } else if (e.key === "Enter") {
                            e.preventDefault();
                            if (activeIndex >= 0 && items[activeIndex]) {
                                deliveryDestinationInput.value = items[activeIndex].textContent;
                                const destinationIdInput = document.getElementById("deliveryDestinationId");
                                if (destinationIdInput) destinationIdInput.value = items[activeIndex].dataset.cityId;
                                dropdownList.style.display = "none";
                                isFullListVisible = false;
                            }
                        }
                    });
                }

                if (dropdownArrow) {
                    dropdownArrow.addEventListener("click", () => {
                        if (dropdownList.style.display === "block" && isFullListVisible) {
                            dropdownList.style.display = "none";
                            isFullListVisible = false;
                        } else {
                            populateDropdown();
                            isFullListVisible = true;
                            dropdownList.style.display = "block";
                        }
                    });
                }

                document.addEventListener("click", (e) => {
                    if (!e.target.closest(".search-container") && dropdownList) {
                        dropdownList.style.display = "none";
                        isFullListVisible = false;
                    }
                });

                function updateActiveItem(items) {
                    items.forEach(item => item.classList.remove("active"));
                    if (activeIndex >= 0 && items[activeIndex]) {
                        items[activeIndex].classList.add("active");
                        items[activeIndex].scrollIntoView({ block: "nearest" });
                    }
                }

                const editFreightBtn = document.getElementById("editFreightBtn");
                const freightInput = document.getElementById("freightInput");
                let isFreightEditing = false;

                if (editFreightBtn && freightInput) {
                    editFreightBtn.addEventListener("click", function() {
                        if (!isFreightEditing) {
                            freightInput.removeAttribute("readonly");
                            freightInput.focus();
                            editFreightBtn.textContent = "Save Freight";
                            isFreightEditing = true;
                        } else {
                            const newFreight = freightInput.value; // Send as string
                            const cnoteNumberInput = document.getElementById("cnoteNumber");
                            if (!cnoteNumberInput || !cnoteNumberInput.value) {
                                alert("CNote number is not available.");
                                return;
                            }
                            fetch("/dealer/update_freight/", {
                                method: "POST",
                                headers: {
                                    "Content-Type": "application/json",
                                    "X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken]").value
                                },
                                body: JSON.stringify({
                                    cnote_number: cnoteNumberInput.value,
                                    freight: newFreight
                                })
                            })
                            .then(response => response.json())
                            .then(data => {
                                if (data.success) {
                                    alert("Freight updated successfully!");
                                    freightInput.setAttribute("readonly", "true");
                                    freightInput.value = data.freight.toFixed(2);
                                    document.getElementById("grandTotalInput").value = data.grand_total.toFixed(2);
                                    document.getElementById("totalAmt").value = data.grand_total.toFixed(2);
                                    editFreightBtn.textContent = "Edit Freight";
                                    isFreightEditing = false;
                                } else {
                                    alert("Error updating freight: " + (data.error || "Unknown error"));
                                }
                            })
                            .catch(error => {
                                console.error("Error updating freight:", error);
                                alert("An error occurred while updating the freight.");
                            });
                        }
                    });
                    freightInput.addEventListener("input", updateFreightAndTotal);
                }

                // Fetch cities on page load, but don't populate the dropdown yet
                fetchCities();
                updateTotals();
            }
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'93de772d384b6788',t:'MTc0NjkzMjg0MC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
