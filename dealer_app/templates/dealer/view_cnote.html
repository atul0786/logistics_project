<!DOCTYPE html>
<html lang="en">
<head>
    {% load static %}
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CNote Details - Good Way Express</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.4;
            background-color: #f5f9fc;
            color: #2c3e50;
            height: 100vh;
            overflow: hidden;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
            padding: 8px;
            height: calc(100vh - 50px);
            display: flex;
            flex-direction: column;
        }

        /* Header Styles - Matching create_cnotes */
        .header-container {
            display: flex;
            background: linear-gradient(135deg, #3498db, #2c3e50);
            color: white;
            padding: 5px 10px;
            border-radius: 6px;
            margin-bottom: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            align-items: center;
        }

        .logo-section {
            display: flex;
            align-items: center;
            flex: 0 0 200px;
        }

        .logo {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            overflow: hidden;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
        }

        .logo i {
            color: #3498db;
            font-size: 24px;
        }

        .user-info {
            flex: 1;
            text-align: left;
            padding: 0 15px;
        }

        .user-info p {
            margin: 2px 0;
            font-size: 0.9em;
        }

        .search-section {
            flex: 0 0 300px;
            display: flex;
            align-items: center;
        }

        .search-bar {
            display: flex;
            align-items: center;
            background-color: white;
            border-radius: 20px;
            padding: 5px 10px;
            width: 100%;
        }

        .search-bar input {
            border: none;
            outline: none;
            padding: 5px;
            width: 100%;
            font-size: 0.9em;
        }

        .search-bar button {
            background-color: #2980b9;
            color: white;
            border: none;
            border-radius: 20px;
            padding: 5px 12px;
            cursor: pointer;
            font-size: 0.8em;
            margin-left: 5px;
        }

        .logout-section {
            flex: 0 0 100px;
            text-align: right;
        }

        .logout-button button {
            background-color: #e74c3c;
            color: white;
            border: none;
            border-radius: 20px;
            padding: 6px 15px;
            cursor: pointer;
            font-size: 0.9em;
        }

        /* Navigation Styles */
        .nav-container {
            display: flex;
            background: linear-gradient(135deg, #2c3e50, #34495e);
            border-radius: 6px;
            margin-bottom: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 0;
        }

        nav ul {
            list-style-type: none;
            display: flex;
            padding: 0;
            margin: 0;
            width: 100%;
        }

        nav ul li {
            position: relative;
        }

        nav ul li a {
            color: white;
            text-decoration: none;
            padding: 10px 15px;
            display: block;
            transition: background-color 0.3s ease;
            font-size: 0.9em;
        }

        nav ul li a:hover {
            background-color: #3498db;
        }

        nav ul li ul {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            background-color: #2c3e50;
            min-width: 200px;
            z-index: 1000;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border-radius: 0 0 4px 4px;
        }

        nav ul li:hover > ul {
            display: block;
        }

        nav ul li ul li {
            width: 100%;
        }

        nav ul li ul li a {
            padding: 10px 15px;
            background-color: #2c3e50;
        }

        nav ul li ul li a:hover {
            background-color: #3498db;
        }

        /* Main Content */
        .main-content {
            display: flex;
            gap: 8px;
            height: 100%;
            overflow: hidden;
        }

        .form-container {
            flex: 3;
            background-color: white;
            padding: 12px;
            border-radius: 6px;
            box-shadow: 0 0 8px rgba(0, 0, 0, 0.08);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .charges-container {
            flex: 1;
            background-color: white;
            padding: 12px;
            border-radius: 6px;
            box-shadow: 0 0 8px rgba(0, 0, 0, 0.08);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        h2 {
            margin-bottom: 10px;
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 5px;
            font-size: 1.1em;
        }

        h3 {
            color: #2c3e50;
            margin: 8px 0;
            font-size: 1em;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        /* Form Elements */
        .form-row {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
        }

        .form-group {
            flex: 1;
        }

        label {
            display: block;
            margin-bottom: 2px;
            font-weight: bold;
            font-size: 0.8em;
            color: #34495e;
        }

        input, select, textarea {
            width: 100%;
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.85em;
            background-color: #f9f9f9;
        }

        textarea {
            height: 60px;
            resize: vertical;
        }

        input:read-only, select:disabled, textarea:read-only {
            background-color: #f0f0f0;
            color: #7f8c8d;
        }

        .required::after {
            content: " *";
            color: #e74c3c;
        }

        /* Article Table */
        .article-details {
            max-height: 180px;
            overflow-y: auto;
            margin: 8px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.8em;
        }

        th, td {
            border: 1px solid #ddd;
            padding: 5px;
            text-align: left;
        }

        th {
            background-color: #3498db;
            color: white;
            position: sticky;
            top: 0;
        }

        /* Charges Table */
        .charges-container table {
            font-size: 0.8em;
        }

        .charges-container table td {
            padding: 4px;
        }

        .charges-container input {
            padding: 4px;
            text-align: right;
        }

        /* Buttons */
        button {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 6px 12px;
            cursor: pointer;
            font-size: 0.85em;
            transition: background 0.2s;
        }

        button:hover {
            background: linear-gradient(135deg, #2980b9, #1c6ea4);
        }

        .print-button {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
            margin-bottom: 10px;
        }

        .print-button:hover {
            background: linear-gradient(135deg, #27ae60, #219653);
        }

        .update-button {
            background: linear-gradient(135deg, #f39c12, #e67e22);
        }

        .update-button:hover {
            background: linear-gradient(135deg, #e67e22, #d35400);
        }

        #submitBtn {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
            width: 100%;
            padding: 10px;
            margin-top: 10px;
            font-size: 0.9em;
            font-weight: bold;
        }

        #submitBtn:hover {
            background: linear-gradient(135deg, #27ae60, #219653);
        }

        /* Status Indicators */
        .status-indicator {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            margin: 5px 0;
            font-weight: bold;
        }

        .status-booked { background-color: #f39c12; color: #000; }
        .status-dispatched { background-color: #3498db; color: #fff; }
        .status-received { background-color: #2ecc71; color: #fff; }
        .status-due-for-delivery { background-color: #e67e22; color: #fff; }
        .status-delivered { background-color: #27ae60; color: #fff; }
        .status-received-at-godown { background-color: #8e44ad; color: #fff; }
        .status-cancelled { background-color: #e74c3c; color: #fff; }

        /* Search and Dropdown */
        .search-container {
            position: relative;
            width: 100%;
        }

        .search-input {
            width: 100%;
            padding: 6px;
            padding-right: 30px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 0.85em;
        }

        .dropdown-arrow {
            position: absolute;
            top: 50%;
            right: 8px;
            transform: translateY(-50%);
            cursor: pointer;
            color: #7f8c8d;
        }

        .dropdown-list {
            position: absolute;
            top: 100%;
            left: 0;
            width: 100%;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-top: none;
            background: white;
            z-index: 1000;
            display: none;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .dropdown-item {
            padding: 8px;
            cursor: pointer;
            font-size: 0.85em;
            border-bottom: 1px solid #f1f1f1;
        }

        .dropdown-item:hover,
        .dropdown-item.active {
            background-color: #e3f2fd;
        }

        /* Status Update */
        .status-update-container {
            margin-top: 12px;
            padding: 8px;
            background-color: #f9f9f9;
            border-radius: 4px;
            border: 1px solid #eee;
        }

        .status-update-container h3 {
            margin-bottom: 6px;
            color: #2c3e50;
        }

        .status-update-container select {
            margin-right: 8px;
            padding: 5px;
        }

        /* Error Message */
        .error-message {
            background-color: #e74c3c;
            color: white;
            padding: 10px;
            margin: 8px 0;
            border-radius: 4px;
            text-align: center;
            display: none;
            font-size: 0.85em;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #bdc3c7;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #95a5a6;
        }

        /* Responsive Adjustments */
        @media (max-width: 1400px) {
            .form-container {
                flex: 2;
            }
            
            .form-row {
                flex-wrap: wrap;
            }
            
            .form-group {
                flex: 1 1 calc(50% - 4px);
            }
            
            .header-container {
                flex-wrap: wrap;
            }
            
            .logo-section, .user-info, .search-section, .logout-section {
                flex: 1 1 100%;
                margin-bottom: 5px;
            }
        }
    </style>
</head>
<body>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <div class="container">
        <!-- Header -->
        <div class="header-container">
            <div class="logo-section">
                <div class="logo">
                    <img src="{% static 'images/logo.jpg' %}" alt="Company Logo" style="width: 100%; height: auto; max-height: 25mm;">                
                </div>
                <div>
                    <p style="font-weight: bold;">Good Way</p>
                    <p style="font-weight: bold;">Express</p>
                </div>
            </div>
            
            <div class="user-info">
                <p>Welcome {{ dealer.name }} ({{ dealer.city }} - {{ dealer.state }})</p>
                <p id="currentDateTime" style="margin-top: 2px; font-size: 0.8em;"></p>  
            </div>
            
            <div class="search-section">
                <div class="search-bar">
                    <input type="text" id="searchCNote" name="cnote_number" placeholder="Search CNote Number" required />
                    <button type="submit" id="searchButton">Search</button>
                </div>
                <div id="errorMessage" class="error-message" style="display: none;"></div>
            </div>
            
            <div class="logout-section">
                <form action="{% url 'logout' %}" method="post" class="logout-button">
                    {% csrf_token %}
                    <button type="submit" id="logoutBtn">Logout</button>
                </form>
            </div>
        </div>

        <!-- Navigation -->
        <div class="nav-container">
            <nav>
                <ul>
                    <li>
                        <a href="{% url 'dealer:create_cnotes' %}"><i class="fas fa-home"></i> Home</a>
                    </li>
                    <li>
                        <a href="#"><i class="fas fa-cogs"></i> Operations</a>
                        <ul>
                            <li>
                                <a href="{% url 'dealer:create_cnotes' %}"> Booking</a>
                            </li>
                            <li>
                                <a href="{% url 'dealer:import_cnotes' %}" target="_blank" rel="noopener noreferrer" class="btn btn-secondary">Bulk Booking</a>
                            </li>
                            <li>
                                <a href="{% url 'dealer:loading_sheet' %}"target="_blank" rel="noopener noreferrer"> Loading Sheet</a>
                            </li>
                        </ul>
                    </li>

                    <li>
                        <a href="#"><i class="fas fa-tools"></i> Master</a>
                            <ul>
                                <li>
                                    <a href="{% url 'dealer:select_qr_printer' %}" target="_blank">QR Printer Setting</a>
                                </li>
                            </ul>
                    </li>

                    
                    <li>
                        <a href="{% url 'dealer:booking_register' %}"target="_blank" rel="noopener noreferrer"><i class="fas fa-chart-bar"></i> Report</a>
                        <ul>
                        </ul>
                    </li>
                </ul>
            </nav>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Form Container -->
            <div class="form-container">
                <h2>CNote Details</h2>
                <input type="hidden" id="hasCNote" value="{% if cnote %}true{% else %}false{% endif %}" />
                
                {% if cnote %}
                    <button id="printNoteBtn" class="print-button"><i class="fas fa-print"></i> Print Note</button>
                    
                    <div class="status-indicator status-{{ cnote.status|lower }}">
                        Status: {{ cnote.get_status_display }}
                    </div>
                    
                    <form id="cnoteDetailsForm">
                        {% csrf_token %}
                        <div class="form-row">
                            <div class="form-group">
                                <label for="cnoteNumber">CNote Number</label>
                                <input type="text" id="cnoteNumber" name="cnote_number" value="{{ cnote.cnote_number }}" readonly />
                            </div>
                            <div class="form-group">
                                <label for="createdAt">Created At</label>
                                <input type="text" id="createdAt" name="created_at" value="{{ cnote.created_at|date:'Y-m-d H:i:s' }}" readonly />
                            </div>
                            <div class="form-group">
                                <label for="paymentType">Payment Type</label>
                                <input type="text" id="paymentType" name="payment_type" value="{{ cnote.payment_type|upper }}" readonly />
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="fromCity">From City</label>
                                <input type="text" id="fromCity" name="from_city" value="{{ dealer.city }}" readonly />
                            </div>
                            <div class="form-group">
                                <label for="deliveryDestination" class="required">Delivery Destination</label>
                                <div class="search-container">
                                    <input 
                                        type="text" 
                                        class="search-input" 
                                        placeholder="Search or select destination" 
                                        id="deliveryDestination"
                                        name="delivery_destination"
                                        required
                                        value="{{ cnote.delivery_destination.destination_name }}"
                                        data-destination-id="{{ cnote.delivery_destination.id }}"
                                    >
                                    <input 
                                        type="hidden" 
                                        id="deliveryDestinationId" 
                                        name="delivery_destination_id" 
                                        value="{{ cnote.delivery_destination.id }}"
                                    >
                                    <span class="dropdown-arrow" id="dropdownArrow">â–¾</span>
                                    <div class="dropdown-list" id="dropdownList"></div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="fromDealer">From Dealer</label>
                                <input type="text" id="fromDealer" name="from_dealer" value="{{ dealer.name }}" readonly />
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="bookingType">Booking Type</label>
                                <select id="bookingType" name="booking_type" disabled>
                                    <option value="sundry" {% if cnote.booking_type == 'sundry' %}selected{% endif %}>Sundry</option>
                                    <option value="other" {% if cnote.booking_type == 'other' %}selected{% endif %}>Other</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="deliveryMethod">Delivery Method</label>
                                <select id="deliveryMethod" name="delivery_method" disabled>
                                    <option value="door" {% if cnote.delivery_method == 'door' %}selected{% endif %}>Door Delivery</option>
                                    <option value="godown" {% if cnote.delivery_method == 'godown' %}selected{% endif %}>Godown Delivery</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="riskType">Risk Type</label>
                                <select id="riskType" name="risk_type" disabled>
                                    <option value="owner" {% if cnote.risk_type == 'owner' %}selected{% endif %}>Owner Risk</option>
                                    <option value="carrier" {% if cnote.risk_type == 'carrier' %}selected{% endif %}>Carrier Risk</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="actualWt">Actual Weight</label>
                                <input type="number" step="0.01" id="actualWt" name="actual_weight" value="{{ cnote.actual_weight }}" />
                            </div>
                            <div class="form-group">
                                <label for="chargedWt">Charged Weight</label>
                                <input type="number" step="0.01" id="chargedWt" name="charged_weight" value="{{ cnote.charged_weight }}" />
                            </div>
                            <div class="form-group">
                                <label for="totalAmt">Total Amount</label>
                                <input type="text" id="totalAmt" name="total_amount" value="{{ cnote.grand_total }}" readonly />
                            </div>
                        </div>
                        
                        <h3>Consignor Details</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="consignorName">Consignor Name</label>
                                <input type="text" id="consignorName" name="consignor_name" value="{{ cnote.consignor_name }}" readonly />
                            </div>
                            <div class="form-group">
                                <label for="consignorMobile">Consignor Mobile</label>
                                <input type="text" id="consignorMobile" name="consignor_mobile" value="{{ cnote.consignor_mobile }}" readonly />
                            </div>
                            <div class="form-group">
                                <label for="consignorGST">Consignor GST</label>
                                <input type="text" id="consignorGST" name="consignor_gst" value="{{ cnote.consignor_gst }}" readonly />
                            </div>
                        </div>
                        
                        <h3>Consignee Details</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="consigneeName">Consignee Name</label>
                                <input type="text" id="consigneeName" name="consignee_name" value="{{ cnote.consignee_name }}" readonly />
                            </div>
                            <div class="form-group">
                                <label for="consigneeMobile">Consignee Mobile</label>
                                <input type="text" id="consigneeMobile" name="consignee_mobile" value="{{ cnote.consignee_mobile }}" readonly />
                            </div>
                            <div class="form-group">
                                <label for="consigneeGST">Consignee GST</label>
                                <input type="text" id="consigneeGST" name="consignee_gst" value="{{ cnote.consignee_gst }}" readonly />
                            </div>
                        </div>
                        
                        <h3>Article Details</h3>
                        <div class="article-details">
                            <table id="articleTable">
                                <thead>
                                    <tr>
                                        <th>Article Type</th>
                                        <th>Quantity</th>
                                        <th>Description</th>
                                        <th>Amount</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for article in articles %}
                                    <tr data-article-id="{{ article.id }}">
                                        <td>
                                            <select name="art_type[]" class="art-type" required>
                                                <option value="">Select Article Type</option>
                                                {% for art_type in art_types %}
                                                <option value="{{ art_type.id }}" 
                                                    {% if article.art_type and article.art_type.id == art_type.id %}selected{% endif %}>
                                                    {{ art_type.art_type_name }}
                                                </option>
                                                {% endfor %}
                                            </select>
                                        </td>
                                        <td>
                                            <input type="number" name="quantity[]" class="quantity" value="{{ article.art }}" required />
                                        </td>
                                        <td>
                                            <input type="text" name="description[]" class="description" value="{{ article.said_to_contain }}" required />
                                        </td>
                                        <td>
                                            <input type="number" name="amount[]" class="amount" value="{{ article.art_amount }}" step="0.01" required />
                                        </td>
                                        <td>
                                            <button type="button" class="remove-article">Remove</button>
                                        </td>
                                    </tr>
                                    {% empty %}
                                    <tr>
                                        <td colspan="5">No articles found.</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <button type="button" id="addArticle">Add Article</button>
                                <button type="button" id="saveCNoteBtn" class="update-button">Update and Save</button>
                            </div>
                        </div>
                    </form>
                {% else %}
                    <p>No CNote details available for the provided number.</p>
                {% endif %}
            </div>

            <!-- Charges Container -->
            {% if cnote %}
            <div class="charges-container">
                <h2>Charges</h2>
                <table>
                    <tr>
                        <td>Freight</td>
                        <td>
                            <input type="number" step="0.01" name="freight" id="freightInput" value="{{ cnote.freight }}" readonly />
                            <button type="button" id="editFreightBtn">Edit</button>
                        </td>
                    </tr>
                    <tr><td>Docket Charge</td><td><input type="number" step="0.01" name="docket_charge" value="{{ cnote.docket_charge }}" /></td></tr>
                    <tr><td>Door Delivery Charge</td><td><input type="number" step="0.01" name="door_delivery_charge" value="{{ cnote.door_delivery_charge }}" /></td></tr>
                    <tr><td>Handling Charge</td><td><input type="number" step="0.01" name="handling_charge" value="{{ cnote.handling_charge }}" /></td></tr>
                    <tr><td>Pickup Charge</td><td><input type="number" step="0.01" name="pickup_charge" value="{{ cnote.pickup_charge }}" /></td></tr>
                    <tr><td>Transhipment Charge</td><td><input type="number" step="0.01" name="transhipment_charge" value="{{ cnote.transhipment_charge }}" /></td></tr>
                    <tr><td>Insurance</td><td><input type="number" step="0.01" name="insurance" value="{{ cnote.insurance }}" /></td></tr>
                    <tr><td>Fuel Surcharge</td><td><input type="number" step="0.01" name="fuel_surcharge" value="{{ cnote.fuel_surcharge }}" /></td></tr>
                    <tr><td>Commission</td><td><input type="number" step="0.01" name="commission" value="{{ cnote.commission }}" /></td></tr>
                    <tr><td>Other Charge</td><td><input type="number" step="0.01" name="other_charge" value="{{ cnote.other_charge }}" /></td></tr>
                    <tr><td>Carrier Risk</td><td><input type="number" step="0.01" name="carrier_risk" value="{{ cnote.carrier_risk }}" /></td></tr>
                    <tr>
                        <td><strong>Grand Total</strong></td>
                        <td><strong><input type="number" step="0.01" name="grand_total" id="grandTotalInput" value="{{ cnote.grand_total }}" readonly /></strong></td>
                    </tr>
                </table>
                
                <div class="status-update-container">
                    <h3>Update CNote Status</h3>
                    <form action="{% url 'dealer:update_cnote_status' cnote.id %}" method="post">
                        {% csrf_token %}
                        <div style="display: flex; gap: 8px; align-items: center;">
                            <select name="status" style="flex: 1;">
                                {% for status, label in cnote.STATUS_CHOICES %}
                                    <option value="{{ status }}" {% if status == cnote.status %}selected{% endif %}>{{ label }}</option>
                                {% endfor %}
                            </select>
                            <button type="submit" class="update-button">Update Status</button>
                        </div>
                    </form>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
    
    {{ art_types_json | json_script:"art-types" }}
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            let artTypes = [];
            const artTypesElement = document.getElementById("art-types");
            if (artTypesElement) {
                try {
                    artTypes = JSON.parse(artTypesElement.textContent);
                } catch (e) {
                    console.error("Error parsing artTypes JSON:", e);
                }
            }

            function updateDateTime() {
                const now = new Date();
                const dateTimeString = now.toLocaleString("en-US", {
                    day: "2-digit",
                    month: "2-digit",
                    year: "numeric",
                    hour: "2-digit",
                    minute: "2-digit",
                    second: "2-digit",
                    hour12: true
                });
                const currentDateTime = document.getElementById("currentDateTime");
                if (currentDateTime) currentDateTime.textContent = dateTimeString;
            }
            setInterval(updateDateTime, 1000);
            updateDateTime();

            const searchButton = document.getElementById("searchButton");
            const searchInput = document.getElementById("searchCNote");
            if (searchButton && searchInput) {
                searchButton.addEventListener("click", function() {
                    const cnoteNumber = searchInput.value.trim();
                    if (cnoteNumber) {
                        window.location.href = `/dealer/view-cnote/${encodeURIComponent(cnoteNumber)}/`;
                    } else {
                        alert("Please enter a CNote number to search.");
                    }
                });
                searchInput.addEventListener("keypress", function(event) {
                    if (event.key === "Enter") {
                        event.preventDefault();
                        searchButton.click();
                    }
                });
            }

            const hasCNoteInput = document.getElementById("hasCNote");
            const hasCNote = hasCNoteInput && hasCNoteInput.value === "true";
            if (hasCNote) {
                const printNoteBtn = document.getElementById("printNoteBtn");
                if (printNoteBtn) {
                    printNoteBtn.addEventListener("click", function() {
                        const cnoteNumberInput = document.getElementById("cnoteNumber");
                        if (cnoteNumberInput && cnoteNumberInput.value) {
                            window.location.href = `/dealer/cnote-success/${encodeURIComponent(cnoteNumberInput.value)}/`;
                        } else {
                            alert("CNote number is not available.");
                        }
                    });
                }

                const articleTable = document.getElementById("articleTable");
                const addArticleBtn = document.getElementById("addArticle");
                const saveCNoteBtn = document.getElementById("saveCNoteBtn");

                function updateTotals() {
                    let totalQuantity = 0;
                    let totalAmount = 0;
                    const rows = articleTable.getElementsByTagName("tbody")[0].getElementsByTagName("tr");
                    for (let i = 0; i < rows.length; i++) {
                        const quantityInput = rows[i].querySelector(".quantity");
                        const amountInput = rows[i].querySelector(".amount");
                        if (quantityInput && amountInput) {
                            totalQuantity += parseInt(quantityInput.value) || 0;
                            totalAmount += parseFloat(amountInput.value) || 0;
                        }
                    }
                    updateFreightAndTotal();
                }

                function addArticleRow() {
                    const tbody = articleTable.getElementsByTagName("tbody")[0];
                    const newRow = tbody.insertRow();
                    newRow.removeAttribute("data-article-id");
                    let options = '<option value="">Select Article Type</option>';
                    artTypes.forEach(artType => {
                        const escapedName = String(artType.name)
                            .replace(/&/g, "&amp;")
                            .replace(/</g, "&lt;")
                            .replace(/>/g, "&gt;")
                            .replace(/"/g, "&quot;")
                            .replace(/'/g, "&#39;");
                        options += `<option value="${artType.id}">${escapedName}</option>`;
                    });
                    newRow.innerHTML = `
                        <td>
                            <select name="art_type[]" class="art-type" required>
                                ${options}
                            </select>
                        </td>
                        <td><input type="number" name="quantity[]" class="quantity" required /></td>
                        <td><input type="text" name="description[]" class="description" required /></td>
                        <td><input type="number" name="amount[]" class="amount" step="0.01" required /></td>
                        <td><button type="button" class="remove-article">Remove</button></td>
                    `;
                    setupArticleRowListeners(newRow);
                    updateTotals();
                }

                function setupArticleRowListeners(row) {
                    const removeBtn = row.querySelector(".remove-article");
                    const quantityInput = row.querySelector(".quantity");
                    const amountInput = row.querySelector(".amount");
                    if (removeBtn) {
                        removeBtn.addEventListener("click", function() {
                            articleTable.getElementsByTagName("tbody")[0].removeChild(row);
                            updateTotals();
                        });
                    }
                    if (quantityInput) quantityInput.addEventListener("input", updateTotals);
                    if (amountInput) amountInput.addEventListener("input", updateTotals);
                }

                if (addArticleBtn) {
                    addArticleBtn.addEventListener("click", addArticleRow);
                    Array.from(articleTable.getElementsByTagName("tbody")[0].rows).forEach(setupArticleRowListeners);
                }

                function updateFreightAndTotal() {
                    const freightInput = document.querySelector('input[name="freight"]');
                    const grandTotalInput = document.querySelector('input[name="grand_total"]');
                    const totalAmtInput = document.getElementById("totalAmt");
                    if (!freightInput || !grandTotalInput || !totalAmtInput) return;
                    let grandTotal = parseFloat(freightInput.value) || 0;
                    document.querySelectorAll('.charges-container input[type="number"]:not([name="grand_total"]):not([name="freight"])').forEach(input => {
                        grandTotal += parseFloat(input.value) || 0;
                    });
                    grandTotalInput.value = grandTotal.toFixed(2);
                    totalAmtInput.value = grandTotal.toFixed(2);
                }

                const chargeInputs = document.querySelectorAll('.charges-container input[type="number"]:not([name="grand_total"])');
                chargeInputs.forEach(input => {
                    input.addEventListener("input", updateFreightAndTotal);
                });

                if (saveCNoteBtn) {
                    saveCNoteBtn.addEventListener("click", function() {
                        const cnoteNumberInput = document.getElementById("cnoteNumber");
                        if (!cnoteNumberInput || !cnoteNumberInput.value) {
                            alert("CNote number is not available.");
                            return;
                        }

                        const actualWtInput = document.getElementById("actualWt");
                        const chargedWtInput = document.getElementById("chargedWt");
                        const destinationIdInput = document.getElementById("deliveryDestinationId");
                        const freightInput = document.getElementById("freightInput");
                        const rows = articleTable.getElementsByTagName("tbody")[0].getElementsByTagName("tr");

                        const articles = Array.from(rows).map(row => {
                            const artTypeSelect = row.querySelector(".art-type");
                            const quantityInput = row.querySelector(".quantity");
                            const descriptionInput = row.querySelector(".description");
                            const amountInput = row.querySelector(".amount");
                            if (!artTypeSelect.value || !quantityInput.value || !descriptionInput.value || !amountInput.value) {
                                alert("Please fill all article fields.");
                                throw new Error("Incomplete article data");
                            }
                            return {
                                id: row.dataset.articleId || null,
                                art_type: parseInt(artTypeSelect.value),
                                quantity: parseInt(quantityInput.value),
                                description: descriptionInput.value,
                                amount: amountInput.value
                            };
                        });

                        const charges = {};
                        document.querySelectorAll('.charges-container input[type="number"]:not([name="grand_total"])').forEach(input => {
                            charges[input.name] = input.value;
                        });

                        const data = {
                            cnote_number: cnoteNumberInput.value,
                            actual_weight: actualWtInput.value,
                            charged_weight: chargedWtInput.value,
                            delivery_destination_id: parseInt(destinationIdInput.value) || null,
                            articles,
                            charges
                        };

                        if (data.actual_weight < 0 || data.charged_weight < 0) {
                            alert("Weights cannot be negative.");
                            return;
                        }
                        if (!data.delivery_destination_id) {
                            alert("Please select a valid delivery destination.");
                            return;
                        }
                        if (articles.length === 0) {
                            alert("At least one article is required.");
                            return;
                        }

                        fetch("/dealer/save_cnote/", {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json",
                                "X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken]").value
                            },
                            body: JSON.stringify(data)
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                alert("CNote updated successfully!");
                                window.location.reload();
                            } else {
                                alert("Error updating CNote: " + (data.error || "Unknown error"));
                            }
                        })
                        .catch(error => {
                            console.error("Error updating CNote:", error);
                            alert("An error occurred while updating the CNote.");
                        });
                    });
                }

                const deliveryDestinationInput = document.getElementById("deliveryDestination");
                const dropdownList = document.getElementById("dropdownList");
                const dropdownArrow = document.getElementById("dropdownArrow");
                let cities = [];
                let activeIndex = -1;
                let isFullListVisible = false;

                async function fetchCities() {
                    try {
                        const response = await fetch("/dealer/fetch_cities/");
                        const data = await response.json();
                        if (data.success) {
                            cities = data.cities.map(city => ({
                                id: city.id,
                                name: city.destination_name
                            }));
                        } else {
                            console.error("Error fetching cities:", data.error);
                        }
                    } catch (error) {
                        console.error("Error fetching cities:", error);
                    }
                }

                function populateDropdown(filter = "") {
                    if (!dropdownList) return;
                    dropdownList.innerHTML = "";
                    const filteredCities = filter
                        ? cities.filter(city => city.name.toLowerCase().includes(filter.toLowerCase()))
                        : cities;
                    filteredCities.forEach((city) => {
                        const div = document.createElement("div");
                        div.classList.add("dropdown-item");
                        div.textContent = city.name;
                        div.dataset.cityId = city.id;
                        div.addEventListener("click", () => {
                            if (deliveryDestinationInput) {
                                deliveryDestinationInput.value = city.name;
                                const destinationIdInput = document.getElementById("deliveryDestinationId");
                                if (destinationIdInput) destinationIdInput.value = city.id;
                            }
                            dropdownList.style.display = "none";
                            isFullListVisible = false;
                        });
                        dropdownList.appendChild(div);
                    });

                    if (filter || isFullListVisible) {
                        dropdownList.style.display = filteredCities.length > 0 ? "block" : "none";
                    } else {
                        dropdownList.style.display = "none";
                    }
                    activeIndex = -1;
                }

                if (deliveryDestinationInput) {
                    deliveryDestinationInput.addEventListener("input", (e) => {
                        isFullListVisible = false;
                        populateDropdown(e.target.value);
                    });
                    deliveryDestinationInput.addEventListener("keydown", (e) => {
                        const items = Array.from(dropdownList.querySelectorAll(".dropdown-item"));
                        if (e.key === "ArrowDown") {
                            e.preventDefault();
                            activeIndex = (activeIndex + 1) % items.length;
                            updateActiveItem(items);
                        } else if (e.key === "ArrowUp") {
                            e.preventDefault();
                            activeIndex = (activeIndex - 1 + items.length) % items.length;
                            updateActiveItem(items);
                        } else if (e.key === "Enter") {
                            e.preventDefault();
                            if (activeIndex >= 0 && items[activeIndex]) {
                                deliveryDestinationInput.value = items[activeIndex].textContent;
                                const destinationIdInput = document.getElementById("deliveryDestinationId");
                                if (destinationIdInput) destinationIdInput.value = items[activeIndex].dataset.cityId;
                                dropdownList.style.display = "none";
                                isFullListVisible = false;
                            }
                        }
                    });
                }

                if (dropdownArrow) {
                    dropdownArrow.addEventListener("click", () => {
                        if (dropdownList.style.display === "block" && isFullListVisible) {
                            dropdownList.style.display = "none";
                            isFullListVisible = false;
                        } else {
                            populateDropdown();
                            isFullListVisible = true;
                            dropdownList.style.display = "block";
                        }
                    });
                }

                document.addEventListener("click", (e) => {
                    if (!e.target.closest(".search-container") && dropdownList) {
                        dropdownList.style.display = "none";
                        isFullListVisible = false;
                    }
                });

                function updateActiveItem(items) {
                    items.forEach(item => item.classList.remove("active"));
                    if (activeIndex >= 0 && items[activeIndex]) {
                        items[activeIndex].classList.add("active");
                        items[activeIndex].scrollIntoView({ block: "nearest" });
                    }
                }

                const editFreightBtn = document.getElementById("editFreightBtn");
                const freightInput = document.getElementById("freightInput");
                let isFreightEditing = false;

                if (editFreightBtn && freightInput) {
                    editFreightBtn.addEventListener("click", function() {
                        if (!isFreightEditing) {
                            freightInput.removeAttribute("readonly");
                            freightInput.focus();
                            editFreightBtn.textContent = "Save Freight";
                            isFreightEditing = true;
                        } else {
                            const newFreight = freightInput.value;
                            const cnoteNumberInput = document.getElementById("cnoteNumber");
                            if (!cnoteNumberInput || !cnoteNumberInput.value) {
                                alert("CNote number is not available.");
                                return;
                            }
                            fetch("/dealer/update_freight/", {
                                method: "POST",
                                headers: {
                                    "Content-Type": "application/json",
                                    "X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken]").value
                                },
                                body: JSON.stringify({
                                    cnote_number: cnoteNumberInput.value,
                                    freight: newFreight
                                })
                            })
                            .then(response => response.json())
                            .then(data => {
                                if (data.success) {
                                    alert("Freight updated successfully!");
                                    freightInput.setAttribute("readonly", "true");
                                    freightInput.value = data.freight.toFixed(2);
                                    document.getElementById("grandTotalInput").value = data.grand_total.toFixed(2);
                                    document.getElementById("totalAmt").value = data.grand_total.toFixed(2);
                                    editFreightBtn.textContent = "Edit Freight";
                                    isFreightEditing = false;
                                } else {
                                    alert("Error updating freight: " + (data.error || "Unknown error"));
                                }
                            })
                            .catch(error => {
                                console.error("Error updating freight:", error);
                                alert("An error occurred while updating the freight.");
                            });
                        }
                    });
                    freightInput.addEventListener("input", updateFreightAndTotal);
                }

                fetchCities();
                updateTotals();
            }
        });
    </script>
</body>
</html>
