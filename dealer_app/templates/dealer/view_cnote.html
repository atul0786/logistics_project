<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CNote Details - Logistics Management System</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    
    <style>
        * {
          box-sizing: border-box;
          margin: 0;
          padding: 0;
        }
  
        body {
          font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
          line-height: 1.6;
          background-color: #f0f8ff;
          color: #333;
        }
  
        .container {
          max-width: 1400px;
          margin: 0 auto;
          padding: 20px;
        }
  
        header {
          background-color: #87ceeb;
          color: #333;
          padding: 10px 0;
          box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
  
        .logo {
          width: 80px;
          height: auto;
        }
  
        /* Top bar container to manage entire layout */
          .top-bar {
          display: flex;
          justify-content: flex-end; /* Pushes content to the right */
          align-items: center;
          padding: 0 20px; /* Adjust the padding */
                  }
        .user-info {
          text-align: center;
          flex-grow: 1;
        }
  
        .search-bar input {
          width: 200px;
          padding: 8px;
          border: none;
          outline: none;
          font-size: 14px;
        }
  
        .search-bar button {
          padding: 8px 15px;
          background-color: #4682b4;
          color: white;
          border: none;
          border-radius: 20px;
          cursor: pointer;
          transition: background-color 0.3s;
        }
  
        .search-bar button:hover {
          background-color: #36648b;
        }
  
        nav {
          background-color: #4682b4;
          padding: 10px 0;
        }
  
        nav ul {
          list-style-type: none;
          display: flex;
          justify-content: space-around;
          flex-wrap: wrap;
        }
  
        nav ul li {
          position: relative;
        }
  
        nav ul li a {
          color: white;
          text-decoration: none;
          padding: 5px 10px;
          border-radius: 4px;
          transition: background-color 0.3s;
        }
  
        nav ul li a:hover {
          background-color: #3a6d8c;
        }
  
        nav ul li ul {
          display: none;
          position: absolute;
          top: 100%;
          left: 0;
          background-color: #4682b4;
          padding: 10px;
          border-radius: 0 0 4px 4px;
          z-index: 1000;
        }
  
        nav ul li:hover > ul {
          display: block;
        }
  
        nav ul li ul li {
          width: 200px;
          padding: 5px 0;
        }
  
        nav ul li ul li a {
          display: block;
          padding: 5px 10px;
        }
  
        .function-keys {
          background-color: #4682b4;
          color: white;
          padding: 10px 0;
          text-align: center;
        }
        .autocomplete-container {
          position: relative;
        }
  
        #destinationList {
          position: absolute;
          top: 100%;
          left: 0;
          background-color: #fff;
          border: 1px solid #ddd;
          padding: 10px;
          width: 100%;
          max-height: 200px;
          overflow-y: auto;
          z-index: 1;
        }
  
        .function-keys span {
          margin: 0 10px;
          cursor: pointer;
          padding: 5px 10px;
          border-radius: 4px;
          transition: background-color 0.3s;
        }
  
        .function-keys span:hover {
          background-color: #3a6d8c;
        }
  
        main {
          display: flex;
          flex-wrap: wrap;
          gap: 20px;
          margin-top: 20px;
        }
  
        .form-container,
        .charges-container {
          background-color: white;
          padding: 20px;
          border-radius: 8px;
          box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
  
        .form-container {
          flex: 3;
          min-width: 600px;
        }
  
        .charges-container {
          flex: 1;
          min-width: 250px;
        }
  
        h2 {
          margin-bottom: 20px;
          color: #4682b4;
          border-bottom: 2px solid #4682b4;
          padding-bottom: 10px;
        }
  
        .form-row {
          display: flex;
          gap: 20px;
          margin-bottom: 15px;
        }
  
        .form-group {
          flex: 1;
        }
  
        label {
          display: block;
          margin-bottom: 5px;
          font-weight: bold;
        }
  
        input,
        select,
        textarea {
          width: 100%;
          padding: 8px;
          border: 1px solid #ddd;
          border-radius: 4px;
          font-size: 14px;
        }
  
        textarea {
          resize: vertical;
        }
  
        .required::after {
          content: " *";
          color: red;
        }
  
        button {
          background-color: #4682b4;
          color: white;
          padding: 10px 15px;
          border: none;
          border-radius: 4px;
          cursor: pointer;
          transition: background-color 0.3s;
        }
  
        button:hover {
          background-color: #3a6d8c;
        }
  
        table {
          width: 100%;
          border-collapse: collapse;
          margin-bottom: 20px;
        }
  
        th,
        td {
          border: 1px solid #ddd;
          padding: 8px;
          text-align: left;
          font-size: 14px;
        }
  
        th {
          background-color: #4682b4;
          color: white;
        }
  
        .article-details {
          max-height: 300px;
          overflow-y: auto;
          margin-bottom: 20px;
        }
  
        .article-details table {
          table-layout: fixed;
        }
  
        .article-details th,
        .article-details td {
          width: 16.66%;
        }
  
        .article-details input,
        .article-details select {
          width: 100%;
        }
  
        #submitBtn {
          background-color: #4caf50;
          color: white;
          padding: 14px 20px;
          margin: 8px 0;
          border: none;
          cursor: pointer;
          width: 100%;
          font-size: 18px;
        }
  
        #submitBtn:hover {
          background-color: #45a049;
        }
  
        .manual-fields {
          display: none;
        }
  
        .autocomplete-container {
          position: relative;
        }
  
        .autocomplete-list {
          position: absolute;
          z-index: 1;
          list-style-type: none;
          padding: 0;
          margin: 0;
          background-color: #fff;
          border: 1px solid #ddd;
          max-height: 150px;
          overflow-y: auto;
          width: 100%;
          display: none;
        }
  
        .autocomplete-list li {
          padding: 8px;
          cursor: pointer;
        }
  
        .autocomplete-list li:hover,
        .autocomplete-list li.selected {
          background-color: #f0f0f0;
        }
  
        @media (max-width: 1200px) {
          .form-container {
            flex: 2;
          }
        }
  
        @media (max-width: 992px) {
          .form-container,
          .charges-container {
            flex: 1 1 100%;
          }
        }
        
        /* Container for search and logout */
        .search-logout-container {
          display: flex;
          justify-content: space-between;
          align-items: center;
          width: 100%; /* Ensure it takes full width */
        }
        /* Search bar styles */
        .search-bar {
        display: flex;
        align-items: center;
        background-color: #ffffff;
        border-radius: 20px;
        padding: 5px 10px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        } 
        
  /* Logout button styles */
    .logout-button {  
      position: absolute;  
      right: 10px;  
      top: 53px;  
      }
  
  .logout-button button {
    background-color: #ff4500;
    color: white;
    padding: 9px 18px;
    border: none;
    border-radius: 20px;
    cursor: pointer;
    transition: background-color 0.3s;
  }
  
  .logout-button button:hover {
    background-color: #e63900;
  }
  /* Add styles for status indicator */
          .status-indicator {
              display: inline-block;
              padding: 5px 10px;
              border-radius: 4px;
              font-weight: bold;
              margin-top: 10px;
          }
          .status-booked { background-color: #ffd700; color: #000; }
          .status-dispatched { background-color: #1e90ff; color: #fff; }
          .status-received { background-color: #32cd32; color: #fff; }
          .status-due-for-delivery { background-color: #ff8c00; color: #fff; }
          .status-delivered { background-color: #008000; color: #fff; }
          .status-received-at-godown { background-color: #4b0082; color: #fff; }
          .status-cancelled { background-color: #ff0000; color: #fff; }
      
      
  
  
  
    </style>
</head>
<body>
    <header>
        <div class="container">
          <div class="top-bar">
            <div class="logo" style="width: 80px; height: 80px; border-radius: 50%; overflow: hidden;">  
              {% if dealer.photo %}  
                 <img src="{{ dealer.photo.url }}" alt="Dealer Photo" style="width: 100%; height: 100%; object-fit: cover">  
              {% else %}  
                 <span style="font-size: 64px; line-height: 80px; text-align: center">ðŸ˜Š</span>  
              {% endif %}  
           </div> 
           <div class="user-info"> 
            <p>Welcome {{ dealer.name }} ({{ dealer.city}} - {{ dealer.state}})</p><p id="currentDateTime"></p>  
            <a href="#" id="contactSupport">Contact Support</a>  
           </div>  
           <div class="search-bar">
              <input type="text" id="searchCNote" placeholder="Search CNote Number" />
              <button id="searchButton">Search</button>
            </div>
            <form action="{% url 'logout' %}" method="post" class="logout-button">
              {% csrf_token %}
              <button type="submit" id="logoutBtn">Logout</button>
            </form>
        </div>
      </header>

    <nav>
        <div class="container">
            <ul>
                <li>
                    <a href="#"><i class="fas fa-home"></i> Home</a>
                </li>
                <li>
                    <a href="#"><i class="fas fa-cogs"></i> Operations</a>
                    <ul>
                        <li>
                            <a href="{% url 'dealer:loading_sheet' %}"> Loading Sheet</a>
                        </li>
                        <li><a href="#">Operation 2</a></li>
                        <li><a href="#">Operation 3</a></li>
                    </ul>
                </li>
                <li>
                    <a href="#"><i class="fas fa-search"></i> Search</a>
                </li>
                <li>
                    <a href="{% url 'dealer:booking_register' %}"><i class="fas fa-chart-bar"></i> Report</a>
                    <ul>
                        <li><a href="{% url 'dealer:booking_register' %}">Booking Register</a></li>
                        <li><a href="#">Report 2</a></li>
                        <li><a href="#">Report 3</a></li>
                    </ul>
                </li>
                <li>
                    <a href="#"><i class="fas fa-user"></i> Profile</a>
                    <ul>
                        <li><a href="#">Edit Profile</a></li>
                        <li><a href="#">Change Password</a></li>
                        <li><a href="#">Logout</a></li>
                    </ul>
                </li>
                <li>
                    <a href="#"><i class="fas fa-tasks"></i> Masters</a>
                    <ul>
                        <li><a href="#">Master 1</a></li>
                        <li><a href="#">Master 2</a></li>
                        <li><a href="#">Master 3</a></li>
                    </ul>
                </li>
                <li>
                    <a href="#"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
                    <ul>
                        <li><a href="#">Overview</a></li>
                        <li><a href="#">Analytics</a></li>
                        <li><a href="#">Reports</a></li>
                    </ul>
                </li>
            </ul>
        </div>
    </nav>

    <div class="function-keys">
        <div class="container">
            <span id="paidBtn">F7 : PAID</span>
            <span id="toPayBtn">F8 : TO PAY</span>
            <span id="tbbBtn">F9 : T BB</span>
            <span id="focBtn">F10 : F OC</span>
            <span id="manualBtn">ALT+M : MANUAL</span>
        </div>
    </div>

    <div class="container">
        <main>
            <div class="form-container">
                <h2>CNote Details</h2>
                <form id="cnoteDetailsForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="fromCity">From City</label>
                            <input type="text" id="fromCity" name="from_city" required />
                        </div>
                        <div class="form-group">
                            <label for="cnoteNumber">CNote Number</label>
                            <input type="text" id="cnoteNumber" name="cnote_number" required />
                        </div>
                        <div class="form-group">
                            <label for="fromDealer">From Dealer</label>
                            <input type="text" id="fromDealer" name="from_dealer" required />
                        </div>
                        <div class="form-group">
                            <label for="date">Date</label>
                            <input type="date" id="date" name="date" required />
                        </div>
                        <div class="form-group">
                            <label for="time">Time</label>
                            <input type="time" id="time" name="time" required />
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="bookingType" class="required">Booking Type</label>
                            <select id="bookingType" name="booking_type" required>
                                <option value="sundry" selected>Sundry</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="deliveryType" class="required">Delivery Type</label>
                            <select id="deliveryType" name="delivery_type" required>
                                <option value="economy" selected>ECONOMY DELIVERY</option>
                                <option value="express">EXPRESS DELIVERY</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="deliveryMethod" class="required">Delivery Method</label>
                            <select id="deliveryMethod" name="delivery_method" required>
                                <option value="door" selected>Door Delivery</option>
                                <option value="godown">Godown Delivery</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="deliveryDestination" class="required">Delivery Destination</label>
                            <div class="autocomplete-container">
                                <input type="text" id="deliveryDestination" name="delivery_destination" required />
                                <ul id="destinationList" class="autocomplete-list"></ul>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="ewayBillNumber">EWAYBILL NUMBER</label>
                            <input type="text" id="ewayBillNumber" name="ewayBillNumber" />
                        </div>
                    </div>
                    <div class="form-row manual-fields">
                        <div class="form-group">
                            <label for="manualDate" class="required">Manual Date</label>
                            <input type="date" id="manualDate" name="manualDate" required />
                        </div>
                        <div class="form-group">
                            <label for="manualCNoteNumber" class="required">CN Note Number</label>
                            <input type="text" id="manualCNoteNumber" name="manualCNoteNumber" required />
                        </div>
                        <div class="form-group">
                            <label for="manualCNoteType" class="required">CN Note Type</label>
                            <select id="manualCNoteType" name="manualCNoteType" required>
                                <option value="">Select</option>
                                <option value="paid">Paid</option>
                                <option value="topay">To Pay</option>
                                <option value="tbb">TBB</option>
                                <option value="foc">FOC</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <h3>Consignor (From)</h3>
                            <label for="consignorName" class="required">Consignor Name</label>
                            <input type="text" id="consignorName" name="consignor_name" required />
                            <label for="consignorMobile" class="required">Mobile No</label>
                            <input type="tel" id="consignorMobile" name="consignor_mobile" maxlength="10" required />
 <label for="consignorGST">GST No</label>
                            <input type="text" id="consignorGST" name="consignorGST" />
                            <label for="consignorAddress">Address</label>
                            <textarea id="consignorAddress" name="consignorAddress" rows="3"></textarea>
                        </div>
                        <div class="form-group">
                            <h3>Consignee (To)</h3>
                            <label for="consigneeName" class="required">Consignee Name</label>
                            <input type="text" id="consigneeName" name="consignee_name" required />
                            <label for="consigneeMobile" class="required">Mobile No</label>
                            <input type="tel" id="consigneeMobile" name="consignee_mobile" maxlength="10" required />
                            <label for="consigneeGST">GST No</label>
                            <input type="text" id="consigneeGST" name="consigneeGST" />
                            <label for="consigneeAddress">Address</label>
                            <textarea id="consigneeAddress" name="consigneeAddress" rows="3"></textarea>
                        </div>
                    </div>
                    <h3>Article Details</h3>
                    <div class="article-details">
                        <table id="articleTable">
                            <thead>
                                <tr>
                                    <th>Article</th>
                                    <th>Art</th>
                                    <th>Art Type</th>
                                    <th>Said To Cont</th>
                                    <th>Art Amt</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>
                                        <select name="article" class="article-select" required>
                                            <option value="Article" selected>Article</option>
                                            <option value="Weight">Weight</option>
                                            <option value="Fix">Fix</option>
                                        </select>
                                    </td>
                                    <td><input type="number" name="art" required></td>
                                    <td>
                                        <select name="artType" required>
                                            <option value="">Select</option>
                                            <option value="type1">Type 1</option>
                                            <option value="type2">Type 2</option>
                                        </select>
                                    </td>
                                    <td><input type="text" name="saidToCont" required></td>
                                    <td>
                                        <input type="number" name="artAmt" class="art-amt" step="0.01" required>
                                    </td>
                                    <td>
                                        <button type="button" class="remove-article" disabled>Remove</button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <button type="button" id="addArticle">Add Article</button>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="actualWt" class="required">Actual Wt</label>
                            <input type="number" id="actualWt" name="actual_weight" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label for="chargedWt" class="required">Charged Wt</label>
                            <input type="number" id="chargedWt" name="charged_weight" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label for="wtRate" class="required">Wt Rate</label>
                            <input type="number" id="wtRate" name="weight_rate" step="0.01" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="wtAmt">Wt Amt</label>
                            <input type="number" id="wtAmt" name="weight_amount" step="0.01" readonly>
                        </div>
                        <div class="form-group">
                            <label for="fixAmt">Fix Amt</label>
                            <input type="number" id="fixAmt" name="fix_amount" step="0.01">
                        </div>
                        <div class="form-group">
                            <label for="invoiceNo" class="required">Invoice No</label>
                            <input type="text" id="invoiceNo" name="invoice_number" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="declaredValue" class="required">Declared Value</label>
                            <input type="number " id="declaredValue" name="declared_value" step="0. 01" required>
                        </div>
                        <div class="form-group">
                            <label for="riskType" class="required">Risk Type</label>
                            <select id="riskType" name="risk_type" required>
                                <option value="owner" selected>Owner Risk</option>
                                <option value="carrier">Carrier Risk</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="podRequired">POD Required</label>
                            <select id="podRequired" name="pod_required">
                                <option value="yes">YES</option>
                                <option value="no">NO</option>
                            </select>
                        </div>
                    </div>
                    <button type="submit" id="submitBtn">Save</button>
                </form>
            </div>
            <div class="charges-container">
                <h2>Charges</h2>
                <table>
                    <tr>
                        <td>Freight</td>
                        <td>
                            <input type="number" id="freight" name="freight" value="0" step="0.01">
                        </td>
                    </tr>
                    <tr>
                        <td>Docket Charge</td>
                        <td>
                            <input type="number" id="docketCharge" name="docket_charge" value="0" step="0.01">
                        </td>
                    </tr>
                    <tr>
                        <td>Door Dly.</td>
                        <td>
                            <input type="number" id="doorDlyCharge" name="door_delivery_charge" value="0" step="0.01">
                        </td>
                    </tr>
                    <tr>
                        <td>Handling</td>
                        <td>
                            <input type="number" id="handlingCharge" name="handling_charge" value="0" step="0.01">
                        </td>
                    </tr>
                    <tr>
                        <td>Pickup</td>
                        <td>
                            <input type="number" id="pickupCharge" name="pickup_charge" value="0" step="0.01">
                        </td>
                    </tr>
                    <tr>
                        <td>Transhipment Charge</td>
                        <td>
                            <input type="number" id="transhipmentCharge" name="transhipment_charge" value="0" step="0.01">
                        </td>
                    </tr>
                    <tr>
                        <td>Insurance</td>
                        <td>
                            <input type="number" id="insurance" name="insurance" value="0" step="0.01">
                        </td>
                    </tr>
                    <tr>
                        <td>Fuel Surcharge</td>
                        <td>
                            <input type="number" id="fuelSurcharge" name="fuel_surcharge" value="0" step="0.01">
                        </td>
                    </tr>
                    <tr>
                        <td>Commission</td>
                        <td>
                            <input type="number" id="commission" name="commission" value="0" step="0.01">
                        </td>
                    </tr>
                    <tr>
                        <td>Other</td>
                        <td>
                            <input type="number" id="otherCharge" name="other_charge" value="0" step="0.01">
                        </td>
                    </tr>
                    <tr>
                        <td>Carrier Risk</td>
                        <td>
                            <input type="number" id="carrierRisk" name="carrier_risk" value="0" step="0.01">
                        </td>
                    </tr>
                    <tr>
                        <td>Grand Total</td>
                        <td>
                            <input type="number" id="grandTotal" name="grand_total" value="0" step="0.01" readonly>
                        </td>
                    </tr>
                </table>
            </div>
        </main>
    </div>

    <div class="status-update-container" style="margin-top: 20px;">
        <h3>Update CNote Status</h3>
        {% if cnote %}
            <form action="{% url 'dealer:update_cnote_status' cnote.id %}" method="post">
                {% csrf_token %}
                <select name="status">
                    {% for status, label in cnote.STATUS_CHOICES %}
                        <option value="{{ status }}">{{ label }}</option>
                    {% endfor %}
                </select>
                <button type="submit">Update Status</button>
            </form>
        {% else %}
            <p>No CNote available to update.</p>
        {% endif %}
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function() {
            const form = document.getElementById("cnoteDetailsForm");
            const addArticleButton = document .getElementById("addArticle");
            const articleTable = document.getElementById("articleTable").getElementsByTagName("tbody")[0];
            const chargedWtInput = document.getElementById("chargedWt");
            const wtRateInput = document.getElementById("wtRate");
            const wtAmtInput = document.getElementById("wtAmt");
            const fixAmtInput = document.getElementById("fixAmt");
            const freightInput = document.getElementById("freight");
            const manualFields = document.querySelector(".manual-fields");
            const manualDateInput = document.getElementById("manualDate");
            const manualCNoteNumber = document.getElementById("manualCNoteNumber");
            const manualCNoteType = document.getElementById("manualCNoteType");
            const deliveryDestinationInput = document.getElementById("deliveryDestination");
            const destinationList = document.getElementById("destinationList");

            const validDestinations = [
                "MUMBAI",
                "DELHI",
                "BANGALORE",
                "CHENNAI",
                "KOLKATA",
            ];
            let selectedIndex = -1;
            let articleType = "Article"; // Default article type

            function showAutocompleteList(input) {
                const value = input.value.toUpperCase();
                const filteredDestinations = validDestinations.filter((dest) =>
                    dest.startsWith(value)
                );
                destinationList.innerHTML = "";

                if (filteredDestinations.length > 0) {
                    filteredDestinations.forEach((dest) => {
                        const li = document.createElement("li");
                        li.textContent = dest;
                        li.addEventListener("click", () => {
                            input.value = dest;
                            destinationList.style.display = "none";
                        });
                        destinationList.appendChild(li);
                    });
                    destinationList.style.display = "block";
                } else {
                    destinationList.style.display = "none";
                }
                selectedIndex = -1;
            }

            deliveryDestinationInput.addEventListener("input", function() {
                showAutocompleteList(this);
            });

            deliveryDestinationInput.addEventListener("keydown", function(e) {
                const items = destinationList.getElementsByTagName("li");
                if (e.key === "ArrowDown") {
                    e.preventDefault();
                    selectedIndex =
                        selectedIndex < items.length - 1 ? selectedIndex + 1 : 0;
                    updateSelectedItem(items);
                } else if (e.key === "ArrowUp") {
                    e.preventDefault();
                    selectedIndex =
                        selectedIndex > 0 ? selectedIndex - 1 : items.length - 1;
                    updateSelectedItem(items);
                } else if (e.key === "Enter" && selectedIndex > -1) {
                    e.preventDefault();
                    if (items[selectedIndex]) {
                        this.value = items[selectedIndex].textContent;
                        destinationList.style.display = "none";
                    }
                }
            });

            function updateSelectedItem(items) {
                for (let i = 0; i < items.length; i++) {
                    items[i].classList.toggle("selected", i === selectedIndex);
                }
            }

            document.addEventListener("click", function(e) {
                if (e.target !== deliveryDestinationInput) {
                    destinationList.style.display = "none";
                }
            });

            function updateDateTime() {
                const now = new Date();
                const dateTimeString = now.toLocaleString("en-US", {
                    day: "2-digit",
                    month: "2-digit",
                    year: "numeric",
                    hour: "2-digit",
                    minute: "2-digit",
                    second: "2-digit",
                    hour12: true,
                });
                document.getElementById("currentDateTime").textContent =
                    dateTimeString;
            }

            setInterval(updateDateTime, 1000);
            updateDateTime();

            function updateCNoteStatus(status) {
                const statusInput = document.getElementById("cnoteStatus");
                const statusDisplay = document.getElementById("statusDisplay");
                statusInput.value = status;
                statusDisplay.className = `status-indicator status-${status.replace(" ", "-")}`;
                statusDisplay.textContent = `Status: ${status.charAt(0).toUpperCase() + status.slice(1)}`;
            }

            function updateStatusDisplay(status) {
                const statusDisplay = document.getElementById("statusDisplay");
                statusDisplay.className = `status-indicator status-${status.replace("_", "-")}`;
                statusDisplay.textContent = `Status: ${status.replace("_", " ").charAt(0).toUpperCase() + status.slice(1)}`;
            }

            document.addEventListener("keydown", function(event) {
                const keyMap = {
                    F7: "PAID",
                    F8: "TO PAY",
                    F9: "TBB",
                    F10: "FOC",
                    "Alt+m": "MANUAL",
                };
                const type =
                    keyMap[event.key] || keyMap[`${event.altKey && event.key === "m"}`];
                if (type) {
                    event.preventDefault();
                    updatePaymentType(type);
                }
            });

            document.getElementById("paidBtn").addEventListener("click", () => updatePaymentType("PAID"));
            document.getElementById("toPayBtn").addEventListener("click", () => updatePaymentType("TO PAY"));
            document.getElementById ("tbbBtn").addEventListener("click", () => updatePaymentType("TBB"));
            document.getElementById("focBtn").addEventListener("click", () => updatePaymentType("FOC"));
            document.getElementById("manualBtn").addEventListener("click", () => updatePaymentType("MANUAL"));

            function updatePaymentType(type) {
                document.getElementById("paymentTypeHeader").textContent = type;
                document.getElementById("paymentType").value = type;
                manualFields.style.display = type === "MANUAL" ? "flex" : "none";

                const manualRequired = type === "MANUAL";
                manualDateInput.required = manualRequired;
                manualCNoteNumber.required = manualRequired;
                manualCNoteType.required = manualRequired;

                if (manualRequired) {
                    setManualDateRestrictions();
                }
            }

            function setManualDateRestrictions() {
                const today = new Date();
                const thirtyDaysAgo = new Date(today);
                thirtyDaysAgo.setDate(today.getDate() - 30);

                manualDateInput.max = today.toISOString().split("T")[0];
                manualDateInput.min = thirtyDaysAgo.toISOString().split("T")[0];
                manualDateInput.value = today.toISOString().split("T")[0];
            }

            function handleArticleTypeChange(select) {
                articleType = select.value;
                updateRowFields(select.closest("tr"));
                updateAllRows();
            }

            function updateRowFields(row) {
                const artAmtInput = row.querySelector(".art-amt");
                const wtRateInput = document.getElementById("wtRate");
                const wtAmtInput = document.getElementById("wtAmt");
                const fixAmtInput = document.getElementById("fixAmt");
                const chargedWtInput = document.getElementById("chargedWt");

                const articleSelect = row.querySelector("select[name='article']");
                const selectedArticle = articleSelect.value;

                switch (selectedArticle) {
                    case "Article":
                        artAmtInput.disabled = false;
                        wtRateInput.disabled = true;
                        wtAmtInput.disabled = true;
                        fixAmtInput.disabled = true;
                        wtRateInput.value = 0.0;
                        wtAmtInput.value = 0.0;
                        fixAmtInput.value = 0.0;
                        break;
                    case "Weight":
                        artAmtInput.disabled = true;
                        wtRateInput.disabled = false;
                        wtAmtInput.disabled = true;
                        fixAmtInput.disabled = true;
                        wtAmtInput.value = 0.0;
                        fixAmtInput.value = 0.0;
                        break;
                    case "Fix":
                        artAmtInput.disabled = true;
                        wtRateInput.disabled = true;
                        wtAmtInput.disabled = true;
                        fixAmtInput.disabled = false;
                        wtRateInput.value = 0.0;
                        wtAmtInput.value = 0.0;
                        break;
                }

                calculateRowAmount(row);
            }

            function calculateRowAmount(row) {
                const artAmtInput = row.querySelector(".art-amt");
                const wtRateInput = document.getElementById("wtRate");
                const wtAmtInput = document.getElementById("wtAmt");
                const fixAmtInput = document.getElementById("fixAmt");
                const chargedWtInput = document.getElementById("chargedWt");

                let amount = 0;

                switch (articleType) {
                    case "Article":
                        amount = parseFloat(artAmtInput.value) || 0;
                        break;
                    case "Weight":
                        const chargedWt = parseFloat(chargedWtInput.value) || 0;
                        const wtRate = parseFloat(wtRateInput.value) || 0;
                        amount = chargedWt * wtRate;
                        wtAmtInput.value = amount.toFixed(2);
                        break;
                    case "Fix":
                        amount = parseFloat(fixAmtInput.value) || 0;
                        break;
                }

                updateFreight();
            }

            function updateAllRows() {
                const rows = articleTable.getElementsByTagName("tr");
                for (let i = 0; i < rows.length; i++) {
                    const select = rows[i].querySelector("select[name='article']");
                    if (select) {
                        const selectedArticle = select.value;
                        updateRowFields(rows[i]);
                    }
                }
            }

            function updateFreight() {
                let totalFreight = 0;
                const rows = articleTable.getElementsByTagName("tr");
                for (let i = 0; i < rows.length; i++) {
                    const artAmtInput = rows[i].querySelector(".art-amt");
                    const wtAmtInput = document.getElementById("wtAmt");
                    const fixAmtInput = document.getElementById("fixAmt");

                    switch (articleType) {
                        case "Article":
                            totalFreight += parseFloat(artAmtInput.value) || 0;
                            break;
                        case "Weight":
                            totalFreight += parseFloat(wtAmtInput.value) || 0;
                            break;
                        case "Fix":
                            totalFreight += parseFloat (fixAmtInput.value) || 0;
                            break;
                    }
                }

                const freightInput = document.getElementById("freight");
                freightInput.value = totalFreight.toFixed(2);
                calculateGrandTotal();
            }

            function calculateGrandTotal() {
                let grandTotal = 0;
                const chargesInputs = document.querySelectorAll(".charges-container input[type='number']");
                for (let i = 0; i < chargesInputs.length; i++) {
                    grandTotal += parseFloat(chargesInputs[i].value) || 0;
                }

                const grandTotalInput = document.getElementById("grandTotal");
                grandTotalInput.value = grandTotal.toFixed(2);
            }

            function addArticle() {
                const newRow = articleTable.insertRow();
                newRow.innerHTML = `
                    <td>
                        <select name="article" class="article-select" required>
                            <option value="Article" selected>Article</option>
                            <option value="Weight">Weight</option>
                            <option value="Fix">Fix</option>
                        </select>
                    </td>
                    <td><input type="number" name="art" required></td>
                    <td>
                        <select name="artType" required>
                            <option value="">Select</option>
                            <option value="type1">Type 1</option>
                            <option value="type2">Type 2</option>
                        </select>
                    </td>
                    <td><input type="text" name="saidToCont" required></td>
                    <td><input type="number" name="artAmt" class="art-amt" step="0.01" required></td>
                    <td><button type="button" class="remove-article">Remove</button></td>
                `;

                const select = newRow.querySelector("select[name='article']");
                select.value = articleType;
                updateRowFields(newRow);

                select.addEventListener("change", function() {
                    handleArticleTypeChange(this);
                });

                setupArticleRowListeners(newRow);
                calculateTotalFreight();
            }

            function calculateTotalFreight() {
                let totalFreight = 0;
                const rows = articleTable.getElementsByTagName("tr");
                for (let i = 0; i < rows.length; i++) {
                    const artAmtInput = rows[i].querySelector(".art-amt");
                    const wtAmtInput = document.getElementById("wtAmt");
                    const fixAmtInput = document.getElementById("fixAmt");

                    switch (articleType) {
                        case "Article":
                            totalFreight += parseFloat(artAmtInput.value) || 0;
                            break;
                        case "Weight":
                            totalFreight += parseFloat(wtAmtInput.value) || 0;
                            break;
                        case "Fix":
                            totalFreight += parseFloat(fixAmtInput.value) || 0;
                            break;
                    }
                }

                const freightInput = document.getElementById("freight");
                freightInput.value = totalFreight.toFixed(2);
                calculateGrandTotal();
            }

            addArticleButton.addEventListener("click", addArticle);

            articleTable.addEventListener("click", function(e) {
                if (e.target.classList.contains("remove-article")) {
                    e.target.closest("tr").remove();
                    updateFreight();
                }
            });

            function setupArticleRowListeners(row) {
                row.querySelector(".remove-article").disabled =
                    articleTable.rows.length <= 1;
            }

            setupArticleRowListeners(articleTable.rows[0]);
            calculateTotalFreight();

            const articleSelects = articleTable.querySelectorAll("select[name='article']");
            for (let i = 0; i < articleSelects.length; i++) {
                articleSelects[i].addEventListener("change", function() {
                    handleArticleTypeChange(this);
                });
            }

            updateRowFields(articleTable.rows[0]);
        });

        const urlParams = new URLSearchParams(window.location.search);
        const cnoteNumber = urlParams.get("cnoteNumber");

        if (cnoteNumber) {
            fetch(`/api/cnote-details/${cnoteNumber}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error("CNote not found");
                    }
                    return response.json();
                })
                .then(data => {
                    // Populate the form fields with the fetched CNote data
                    document.getElementById("fromCity").value = data.from_city;
                    document.getElementById("cnoteNumber").value = data.cnote_number;
                    document.getElementById("fromDealer").value = data.from_dealer;
                    document.getElementById("date").value = data.date;
                    document.getElementById("time").value = data.time;
                    // Populate other fields as needed
                })
                .catch(error => {
                    console.error("Error fetching CNote details:", error);
                    alert("CNote not found. Please check the number and try again.");
                });
        } else {
            alert("Invalid CNote number");
        }
    </script>
</body>
</html>