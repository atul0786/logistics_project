<!DOCTYPE html>
<html lang="en">
<head>
    {% load static %} 
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Logistics Management System</title>
    <link
        rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.4;
            background-color: #f5f9fc;
            color: #2c3e50;
            height: 100vh;
            overflow: hidden;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
            padding: 8px;
            height: calc(100vh - 50px);
            display: flex;
            flex-direction: column;
        }

        /* Header Styles */
        .header-container {
            display: flex;
            background: linear-gradient(135deg, #3498db, #2c3e50);
            color: white;
            padding: 5px 10px;
            border-radius: 6px;
            margin-bottom: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            align-items: center;
        }

        .logo-section {
            display: flex;
            align-items: center;
            flex: 0 0 200px;
        }

        .logo {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            overflow: hidden;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
        }

        .logo i {
            color: #3498db;
            font-size: 24px;
        }

        .user-info {
            flex: 1;
            text-align: left;
            padding: 0 15px;
        }

        .user-info p {
            margin: 2px 0;
            font-size: 0.9em;
        }

        .search-section {
            flex: 0 0 300px;
            display: flex;
            align-items: center;
        }

        .search-bar {
            display: flex;
            align-items: center;
            background-color: white;
            border-radius: 20px;
            padding: 5px 10px;
            width: 100%;
        }

        .search-bar input {
            border: none;
            outline: none;
            padding: 5px;
            width: 100%;
            font-size: 0.9em;
        }

        .search-bar button {
            background-color: #2980b9;
            color: white;
            border: none;
            border-radius: 20px;
            padding: 5px 12px;
            cursor: pointer;
            font-size: 0.8em;
            margin-left: 5px;
        }

        .logout-section {
            flex: 0 0 100px;
            text-align: right;
        }

        .logout-button button {
            background-color: #e74c3c;
            color: white;
            border: none;
            border-radius: 20px;
            padding: 6px 15px;
            cursor: pointer;
            font-size: 0.9em;
        }

        /* Navigation Styles */
        .nav-container {
            display: flex;
            background: linear-gradient(135deg, #2c3e50, #34495e);
            border-radius: 6px;
            margin-bottom: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 0;
        }

        nav ul {
            list-style-type: none;
            display: flex;
            padding: 0;
            margin: 0;
            width: 100%;
        }

        nav ul li {
            position: relative;
        }

        nav ul li a {
            color: white;
            text-decoration: none;
            padding: 10px 15px;
            display: block;
            transition: background-color 0.3s ease;
            font-size: 0.9em;
        }

        nav ul li a:hover {
            background-color: #3498db;
        }

        nav ul li ul {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            background-color: #2c3e50;
            min-width: 200px;
            z-index: 1000;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border-radius: 0 0 4px 4px;
        }

        nav ul li:hover > ul {
            display: block;
        }

        nav ul li ul li {
            width: 100%;
        }

        nav ul li ul li a {
            padding: 10px 15px;
            background-color: #2c3e50;
        }

        nav ul li ul li a:hover {
            background-color: #3498db;
        }

        /* Function Keys */
        .function-keys {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 8px;
            flex-wrap: wrap;
        }

        .function-keys span {
            font-size: 0.8em;
            font-weight: bold;
            text-align: center;
            cursor: pointer;
            padding: 8px 12px;
            background: linear-gradient(135deg, #ecf0f1, #bdc3c7);
            border: 1px solid #95a5a6;
            border-radius: 4px;
            transition: all 0.2s ease;
            min-width: 80px;
        }

        .function-keys span:hover {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
        }

        .function-keys span.active {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
            color: white;
            border-color: #27ae60;
        }

        /* Main Content */
        .main-content {
            display: flex;
            gap: 8px;
            height: 100%;
            overflow: hidden;
        }

        .form-container {
            flex: 3;
            background-color: white;
            padding: 12px;
            border-radius: 6px;
            box-shadow: 0 0 8px rgba(0, 0, 0, 0.08);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .charges-container {
            flex: 1;
            background-color: white;
            padding: 12px;
            border-radius: 6px;
            box-shadow: 0 0 8px rgba(0, 0, 0, 0.08);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        h2 {
            margin-bottom: 10px;
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 5px;
            font-size: 1.1em;
        }

        h3 {
            color: #2c3e50;
            margin: 8px 0;
            font-size: 1em;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        /* Form Elements */
        .form-row {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
        }

        .form-group {
            flex: 1;
        }

        label {
            display: block;
            margin-bottom: 2px;
            font-weight: bold;
            font-size: 0.8em;
            color: #34495e;
        }

        input, select, textarea {
            width: 100%;
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.85em;
            background-color: #f9f9f9;
        }

        textarea {
            height: 60px;
            resize: vertical;
        }

        .required::after {
            content: " *";
            color: #e74c3c;
        }

        /* Article Table */
        .article-details {
            max-height: 180px;
            overflow-y: auto;
            margin: 8px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.8em;
        }

        th, td {
            border: 1px solid #ddd;
            padding: 5px;
            text-align: left;
        }

        th {
            background-color: #3498db;
            color: white;
            position: sticky;
            top: 0;
        }

        /* Charges Table */
        .charges-container table {
            font-size: 0.8em;
        }

        .charges-container table td {
            padding: 4px;
        }

        .charges-container input {
            padding: 4px;
            text-align: right;
        }

        /* Buttons */
        button {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 6px 12px;
            cursor: pointer;
            font-size: 0.85em;
            transition: background 0.2s;
        }

        button:hover {
            background: linear-gradient(135deg, #2980b9, #1c6ea4);
        }

        .reset-consignor-btn {
            background: linear-gradient(135deg, #7f8c8d, #95a5a6);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            margin-left: 5px;
            cursor: pointer;
            font-size: 0.7em;
        }

        .reset-consignor-btn:hover {
            background: linear-gradient(135deg, #95a5a6, #7f8c8d);
        }

        #submitBtn {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
            width: 100%;
            padding: 10px;
            margin-top: 10px;
            font-size: 0.9em;
            font-weight: bold;
        }

        #submitBtn:hover {
            background: linear-gradient(135deg, #27ae60, #219653);
        }

        /* Status Indicators */
        .status-indicator {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            margin: 5px 0;
            font-weight: bold;
        }

        .status-booked { background-color: #f39c12; color: #000; }
        .status-dispatched { background-color: #3498db; color: #fff; }
        .status-received { background-color: #2ecc71; color: #fff; }
        .status-delivered { background-color: #27ae60; color: #fff; }
        .status-cancelled { background-color: #e74c3c; color: #fff; }

        /* Payment Type Header */
        #paymentTypeHeader {
            text-align: center;
            padding: 8px;
            border-radius: 6px;
            margin-bottom: 10px;
            font-weight: bold;
            font-size: 0.9em;
            transition: all 0.3s ease;
        }

        #paymentTypeHeader.no-payment {
            background: linear-gradient(135deg, #ffebee, #ffcdd2);
            color: #c62828;
            border: 1px dashed #ef5350;
        }

        #paymentTypeHeader.has-payment {
            background: linear-gradient(135deg, #e8f5e8, #c8e6c9);
            color: #2e7d32;
            border: 1px solid #66bb6a;
        }

        /* Manual Fields */
        .manual-fields {
            display: none;
            background-color: #f9f9f9;
            padding: 8px;
            border-radius: 4px;
            border: 1px dashed #bbb;
            margin-bottom: 8px;
        }

        /* Search and Dropdown */
        .search-container {
            position: relative;
            width: 100%;
        }

        .search-input {
            width: 100%;
            padding: 6px;
            padding-right: 30px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 0.85em;
        }

        .dropdown-arrow {
            position: absolute;
            top: 50%;
            right: 8px;
            transform: translateY(-50%);
            cursor: pointer;
            color: #7f8c8d;
        }

        .dropdown-list {
            position: absolute;
            top: 100%;
            left: 0;
            width: 100%;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-top: none;
            background: white;
            z-index: 1000;
            display: none;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .dropdown-item {
            padding: 8px;
            cursor: pointer;
            font-size: 0.85em;
            border-bottom: 1px solid #f1f1f1;
        }

        .dropdown-item:hover,
        .dropdown-item.active {
            background-color: #e3f2fd;
        }

        /* Consignee Suggestions */
        .consignee-input-wrapper {
            position: relative;
        }

        .party-suggestions {
            position: absolute;
            z-index: 1000;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            max-height: 200px;
            overflow-y: auto;
            width: 100%;
            list-style: none;
            padding: 0;
            margin: 0;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            display: none;
        }

        .party-suggestions li {
            padding: 8px;
            cursor: pointer;
            border-bottom: 1px solid #f1f1f1;
            font-size: 0.85em;
        }

        .party-suggestions li:last-child {
            border-bottom: none;
        }

        .party-suggestions li:hover {
            background-color: #e3f2fd;
        }

        .party-suggestions .selected {
            background-color: #bbdefb;
        }

        /* Last CNote Details */
        .last-cnote-details {
            margin-top: 12px;
            padding: 8px;
            background-color: #f9f9f9;
            border-radius: 4px;
            border: 1px solid #eee;
        }

        .last-cnote-details h3 {
            margin-bottom: 6px;
            color: #2c3e50;
        }

        .last-cnote-details p {
            margin: 3px 0;
            font-size: 0.8em;
        }

        .last-cnote-details a {
            color: #2980b9;
            text-decoration: none;
        }

        .last-cnote-details a:hover {
            text-decoration: underline;
        }

        /* Status Update */
        .status-update-container {
            margin-top: 12px;
            padding: 8px;
            background-color: #f9f9f9;
            border-radius: 4px;
            border: 1px solid #eee;
        }

        .status-update-container h3 {
            margin-bottom: 6px;
            color: #2c3e50;
        }

        .status-update-container select {
            margin-right: 8px;
            padding: 5px;
        }

        /* Popup Message */
        .popup-message {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #ff4444, #cc0000);
            color: white;
            padding: 12px 20px;
            border-radius: 6px;
            z-index: 10000;
            display: none;
            box-shadow: 0 4px 15px rgba(255, 68, 68, 0.3);
            border: 1px solid #ff6666;
            font-weight: bold;
            font-size: 0.9em;
            max-width: 500px;
            text-align: center;
            animation: slideDown 0.3s ease-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }

        .popup-message.success {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            border-color: #66bb6a;
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
        }

        .popup-message .close-btn {
            position: absolute;
            top: 5px;
            right: 8px;
            background: none;
            border: none;
            color: white;
            font-size: 16px;
            cursor: pointer;
            padding: 0;
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .popup-message .close-btn:hover {
            opacity: 0.7;
        }

        .popup-message .icon {
            display: inline-block;
            margin-right: 6px;
            font-size: 14px;
        }

        /* Error Message */
        .error-message {
            background-color: #e74c3c;
            color: white;
            padding: 10px;
            margin: 8px 0;
            border-radius: 4px;
            text-align: center;
            display: none;
            font-size: 0.85em;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #bdc3c7;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #95a5a6;
        }

        /* Responsive Adjustments */
        @media (max-width: 1400px) {
            .form-container {
                flex: 2;
            }
            
            .form-row {
                flex-wrap: wrap;
            }
            
            .form-group {
                flex: 1 1 calc(50% - 4px);
            }
            
            .header-container {
                flex-wrap: wrap;
            }
            
            .logo-section, .user-info, .search-section, .logout-section {
                flex: 1 1 100%;
                margin-bottom: 5px;
            }
        }
    </style>
</head>
<body>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <div class="container">
        <!-- Header -->
        <div class="header-container">
            <div class="logo-section">
                <div class="logo">
                    
                    <img src="{% static 'images/logo.jpg' %}" alt="Company Logo" style="width: 100%; height: auto; max-height: 25mm;">                
                    
                </div>
                <div>
                    <p style="font-weight: bold;">Good Way</p>
                    <p style="font-weight: bold;">Express</p>
                </div>
            </div>
            
            <div class="user-info">
                <p>Welcome {{ dealer.name }} ({{ dealer.city }} - {{ dealer.state }})</p>
                <p id="currentDateTime" style="margin-top: 2px; font-size: 0.8em;"></p>  
            </div>
            
            <div class="search-section">
                <div class="search-bar">
                    <input type="text" id="searchCNote" name="cnote_number" placeholder="Search CNote Number" required />
                    <button type="submit" id="searchButton">Search</button>
                </div>
                <div id="errorMessage" class="error-message" style="display: none;"></div>
            </div>
            
            <div class="logout-section">
                <form action="{% url 'logout' %}" method="post" class="logout-button">
                    {% csrf_token %}
                    <button type="submit" id="logoutBtn">Logout</button>
                </form>
            </div>
        </div>

        <!-- Navigation -->
        <div class="nav-container">
            <nav>
                <ul>
                    <li>
                        <a href="{% url 'dealer:create_cnotes' %}"><i class="fas fa-home"></i> Home</a>
                    </li>
                    <li>
                        <a href="#"><i class="fas fa-cogs"></i> Operations</a>
                        <ul>
                            <li>
                                <a href="{% url 'dealer:create_cnotes' %}"> Booking</a>
                            </li>
                            <li>
                                <a href="{% url 'dealer:import_cnotes' %}" target="_blank" rel="noopener noreferrer" class="btn btn-secondary">Bulk Booking</a>
                            </li>
                            <li>
                                <a href="{% url 'dealer:loading_sheet' %}"target="_blank" rel="noopener noreferrer"> Loading Sheet</a>
                            </li>
                        </ul>
                    </li>

                    <li>
                        <a href="#"><i class="fas fa-tools"></i> Master</a>
                            <ul>
                                <li>
                                    <a href="{% url 'dealer:select_qr_printer' %}" target="_blank">QR Printer Setting</a>
                                </li>
                            </ul>
                    </li>

                    
                    <li>
                        <a href="{% url 'dealer:booking_register' %}"target="_blank" rel="noopener noreferrer"><i class="fas fa-chart-bar"></i> Report</a>
                        <ul>
                        </ul>
                    </li>
                </ul>
            </nav>
        </div>

        <!-- Function Keys -->
        <div class="function-keys">
            <span id="paidBtn">F7 : PAID</span>
            <span id="toPayBtn">F8 : TO PAY</span>
            <span id="tbbBtn">F9 : TBB</span>
            <span id="focBtn">F10 : FOC</span>
            <span id="manualBtn">ALT+M : MANUAL</span>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Form Container -->
            <div class="form-container">
                <h2 id="paymentTypeHeader" class="no-payment">⚠️ कृपया Payment Type Select करें / Please Select Payment Type</h2>

                {% if cnote.status != 'cancelled' %}
                    {% if user.is_transporter %}
                        {% if cnote.status == 'dispatched' %}
                            <form action="{% url 'mark_cnote_received' cnote.id %}" method="post">
                                {% csrf_token %}
                                <button type="submit">Mark as Received</button>
                            </form>
                        {% elif cnote.status == 'received' %}
                            <form action="{% url 'create_delivery' cnote.id %}" method="post">
                                {% csrf_token %}
                                <button type="submit">Create Delivery</button>
                            </form>
                        {% endif %}
                    {% endif %}
                    
                    {% if user.is_dealer and cnote.status == 'booked' %}
                        <form action="{% url 'cancel_cnote' cnote.id %}" method="post">
                            {% csrf_token %}
                            <button type="submit">Cancel CNote</button>
                        </form>
                    {% endif %}
                {% endif %}

                <form id="bookingForm" method="post" action="{% url 'dealer:create_cnotes' %}">
                    {% csrf_token %}
                    <input type="hidden" id="paymentType" name="paymentType" value="" />
                    <input type="hidden" id="cnoteStatus" name="cnoteStatus" value="booked">
                    <!-- Hidden input to store the selected destination ID -->
                    <input type="hidden" id="deliveryDestinationId" name="delivery_destination_id" value="">

                    <div id="statusDisplay" class="status-indicator status-booked">Status: Booked</div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="bookingType" class="required">Booking Type</label>
                            <select id="bookingType" name="booking_type" required>
                                <option value="sundry" selected>Sundry</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="deliveryType" class="required">Delivery Type</label>
                            <select id="deliveryType" name="delivery_type" required>
                                <option value="economy" selected>ECONOMY DELIVERY</option>
                                <option value="express">EXPRESS DELIVERY</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="deliveryMethod" class="required">Delivery Method</label>
                            <select id="deliveryMethod" name="delivery_method" required>
                                <option value="door" selected>Door Delivery</option>
                                <option value="godown">Godown Delivery</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="deliveryDestination" class="required">Delivery Destination</label>
                            <div class="search-container">
                                <input 
                                    type="text" 
                                    class="search-input" 
                                    placeholder="Search or select destination" 
                                    id="deliveryDestination"
                                    name="delivery_destination"
                                    required
                                >
                                <span class="dropdown-arrow" id="dropdownArrow">▾</span>
                                <div class="dropdown-list" id="dropdownList">
                                    <!-- Dropdown items will be populated dynamically -->
                                </div>
                            </div>
                        </div>
                    
                        <div class="form-group">
                            <label for="ewayBillNumber">EWAYBILL NUMBER</label>
                            <input type="text" id="ewayBillNumber" name="ewayBillNumber" />
                        </div>
                    </div>

                    <div class="manual-fields">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="manualDate" class="required">Manual Date</label>
                                <input type="date" id="manualDate" name="manualDate" required />
                            </div>
                            <div class="form-group">
                                <label for="manualCNoteNumber" class="required">CN Note Number</label>
                                <input type="text" id="manualCNoteNumber" name="manualCNoteNumber" required />
                            </div>
                            <div class="form-group">
                                <label for="manualCNoteType" class="required">CN Note Type</label>
                                <select id="manualCNoteType" name="manualCNoteType" required>
                                    <option value="">Select</option>
                                    <option value="paid">Paid</option>
                                    <option value="topay">To Pay</option>
                                    <option value="tbb">TBB</option>
                                    <option value="foc">FOC</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <h3>Consignor (From) 
                                <button type="button" class="reset-consignor-btn">Reset to Dealer Info</button>
                            </h3>
                            <label for="consignorName" class="required">Consignor Name</label>
                            <input type="text" id="consignorName" name="consignor_name" required value="{{ dealer.name }}" />
                            <label for="consignorMobile" class="required">Mobile No</label>
                            <input type="tel" id="consignorMobile" name="consignor_mobile" maxlength="10" required value="{{ dealer.mobile_number_1 }}" />
                            <label for="consignorGST">GST No</label>
                            <input type="text" id="consignorGST" name="consignorGST" value="{{ dealer.gstn }}" />
                            <label for="consignorAddress">Address</label>
                            <textarea id="consignorAddress" name="consignorAddress" rows="2">{{ dealer.address }}</textarea>
                        </div>
                        <div class="form-group">
                            <h3>Consignee (To) - Destination Wise Party
                                <input type="checkbox" id="destinationWiseParty" checked style="margin-left: 5px; width: 14px; height: 14px;">
                            </h3>
                            <label for="consigneeName" class="required">Consignee Name</label>
                            <div class="consignee-input-wrapper">
                                <input type="text" id="consigneeName" name="consignee_name" required value="{{ consignee_data.name|default:'' }}" />
                                <ul id="consigneeSuggestions" class="party-suggestions"></ul>
                            </div>
                            <label for="consigneeMobile" class="required">Mobile No</label>
                            <input type="tel" id="consigneeMobile" name="consignee_mobile" maxlength="10" required value="{{ consignee_data.mobile|default:'' }}" />
                            <label for="consigneeGST">GST No</label>
                            <input type="text" id="consigneeGST" name="consigneeGST" value="{{ consignee_data.gst|default:'' }}" />
                            <label for="consigneeAddress">Address</label>
                            <textarea id="consigneeAddress" name="consigneeAddress" rows="2">{{ consignee_data.address|default:'' }}</textarea>
                        </div>
                    </div>

                    <h3>Article Details</h3>
                    <div class="article-details">
                        <table id="articleTable">
                            <thead>
                                <tr>
                                    <th>Article</th>
                                    <th>Art</th>
                                    <th>Art Type</th>
                                    <th>Said To Contain</th>
                                    <th>Per Pkt Amt</th>
                                    <th>Total Amt</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>
                                        <select name="article" class="article-select" required>
                                            <option value="Article" selected>Article</option>
                                        </select>
                                    </td>
                                    <td><input type="number" name="art" class="art-input" required /></td>
                                    <td>
                                        <select name="artType" required>
                                            <option value="">Select</option>
                                            <option value="type1">SMALL BOX</option>
                                            <option value="type2">BIG BOX</option>
                                        </select>
                                    </td>
                                    <td><input type="text" name="saidToContain" required /></td>
                                    <td><input type="number" name="perPktAmt" class="per-pkt-amt" step="0.01" required /></td>
                                    <td><input type="number" name="totalAmt" class="total-amt" step="0.01" required /></td>
                                    <td>
                                        <button type="button" class="remove-article" disabled>Remove</button>
                                    </td>
                                </tr>
                            </tbody>
                            <tfoot>
                                <tr>
                                    <td colspan="4"><button type="button" id="addArticle">Add Article</button></td>
                                    <td><label>Total Amt</label></td>
                                    <td><input type="number" id="overallTotalAmt" step="0.01" readonly /></td>
                                    <td></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="actualWt" class="required">Actual Wt</label>
                            <input type="number" id="actualWt" name="actual_weight" step="0.01" required />
                        </div>
                        <div class="form-group">
                            <label for="chargedWt" class="required">Charged Wt</label>
                            <input type="number" id="chargedWt" name="charged_weight" step="0.01" required />
                        </div>
                        <div class="form-group">
                            <label for="wtRate" class="required">Wt Rate</label>
                            <input type="number" id="wtRate" name="weight_rate" step="0.01" required />
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="wtAmt">Wt Amt</label>
                            <input type="number" id="wtAmt" name="weight_amount" step="0.01" readonly />
                        </div>
                        <div class="form-group">
                            <label for="fixAmt">Fix Amt</label>
                            <input type="number" id="fixAmt" name="fix_amount" step="0.01" />
                        </div>
                        <div class="form-group">
                            <label for="invoiceNo" class="required">Invoice No</label>
                            <input type="text" id="invoiceNo" name="invoice_number" required />
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="declaredValue" class="required">Declared Value</label>
                            <input type="number" id="declaredValue" name="declared_value" step="0.01" required />
                        </div>
                        <div class="form-group">
                            <label for="riskType" class="required">Risk Type</label>
                            <select id="riskType" name="risk_type" required>
                                <option value="owner" selected>Owner Risk</option>
                                <option value="carrier">Carrier Risk</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="podRequired">POD Required</label>
                            <select id="podRequired" name="pod_required">
                                <option value="yes">YES</option>
                                <option value="no">NO</option>
                            </select>
                        </div>
                    </div>

                    <button type="submit" id="submitBtn">Save</button>
                </form>
            </div>

            <!-- Charges Container -->
            <div class="charges-container">
                <h2>Charges</h2>
                <table>
                    <tr>
                        <td>Freight</td>
                        <td>
                            <input type="number" id="freight" name="freight" value="0" step="0.01" />
                        </td>
                    </tr>
                    <tr>
                        <td>Docket Charge</td>
                        <td>
                            <input type="number" id="docketCharge" name="docket_charge" value="0" step="0.01" />
                        </td>
                    </tr>
                    <tr>
                        <td>Door Dly.</td>
                        <td>
                            <input type="number" id="doorDlyCharge" name="door_delivery_charge" value="0" step="0.01" />
                        </td>
                    </tr>
                    <tr>
                        <td>Handling</td>
                        <td>
                            <input type="number" id="handlingCharge" name="handling_charge" value="0" step="0.01" />
                        </td>
                    </tr>
                    <tr>
                        <td>Pickup</td>
                        <td>
                            <input type="number" id="pickupCharge" name="pickup_charge" value="0" step="0.01" />
                        </td>
                    </tr>
                    <tr>
                        <td>Transhipment Charge</td>
                        <td>
                            <input type="number" id="transhipmentCharge" name="transhipment_charge" value="0" step="0.01" />
                        </td>
                    </tr>
                    <tr>
                        <td>Insurance</td>
                        <td>
                            <input type="number" id="insurance" name="insurance" value="0" step="0.01" />
                        </td>
                    </tr>
                    <tr>
                        <td>Fuel Surcharge</td>
                        <td>
                            <input type="number" id="fuelSurcharge" name="fuel_surcharge" value="0" step="0.01" />
                        </td>
                    </tr>
                    <tr>
                        <td>Commission</td>
                        <td>
                            <input type="number" id="commission" name="commission" value="0" step="0.01" />
                        </td>
                    </tr>
                    <tr>
                        <td>Other</td>
                        <td>
                            <input type="number" id="otherCharge" name="other_charge" value="0" step="0.01" />
                        </td>
                    </tr>
                    <tr>
                        <td>Carrier Risk</td>
                        <td>
                            <input type="number" id="carrierRisk" name="carrier_risk" value="0" step="0.01" />
                        </td>
                    </tr>
                    <tr>
                        <td>Grand Total</td>
                        <td>
                            <input type="number" id="grandTotal" name="grand_total" value="0" step="0.01" readonly />
                        </td>
                    </tr>
                </table>
                
                <div class="last-cnote-details">
                    <h3>
                        {% if last_cnote %}
                            <a href="{% url 'dealer:view_cnote' last_cnote.cnote_number %}">
                                Last CNote Details
                            </a>
                        {% else %}
                            Last CNote Details
                        {% endif %}
                    </h3>
                    {% if last_cnote %}
                        <p><strong>CNote Number:</strong> {{ last_cnote.cnote_number }}</p>
                        <p><strong>Destination:</strong> {{ last_cnote.delivery_destination }}</p>
                        <p><strong>Payment Mode:</strong> {{ last_cnote.payment_type }}</p>
                        <p><strong>Article:</strong> 
                            {% for article in last_cnote.articles.all %}
                                {{ article.article_type }} ({{ article.art }}){% if not forloop.last %}, {% endif %}
                            {% endfor %}
                        </p>
                        <p><strong>Total Amount:</strong> {{ last_cnote.grand_total }}</p>
                    {% else %}
                        <p><strong>CNote Number:</strong> 0</p>
                        <p><strong>Destination:</strong> -</p>
                        <p><strong>Payment Mode:</strong> -</p>
                        <p><strong>Article:</strong> -</p>
                        <p><strong>Total Amount:</strong> 0</p>
                    {% endif %}
                </div>

                <div class="status-update-container">
                    <h3>Update CNote Status</h3>
                    {% if cnote %}
                        <form action="{% url 'dealer:update_cnote_status' cnote.id %}" method="post">
                            {% csrf_token %}
                            <div style="display: flex; gap: 8px; align-items: center;">
                                <select name="status" style="flex: 1;">
                                    {% for status, label in cnote.STATUS_CHOICES %}
                                        <option value="{{ status }}">{{ label }}</option>
                                    {% endfor %}
                                </select>
                                <button type="submit">Update Status</button>
                            </div>
                        </form>
                    {% else %}
                        <p>No CNote available to update.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- Enhanced Popup Message -->
    <div id="popupMessage" class="popup-message">
        <button class="close-btn" onclick="closePopup()">&times;</button>
        <span class="icon">⚠️</span>
        <span id="popupText"></span>
    </div>

    <script>
        // Enhanced Popup Functions
        function showPopupMessage(message, type = 'error') {
            const popup = document.getElementById('popupMessage');
            const popupText = document.getElementById('popupText');
            const icon = popup.querySelector('.icon');
            
            popupText.textContent = message;
            
            // Set icon and style based on type
            if (type === 'success') {
                popup.className = 'popup-message success';
                icon.textContent = '✅';
            } else {
                popup.className = 'popup-message';
                icon.textContent = '⚠️';
            }
            
            popup.style.display = 'block';
            
            // Auto hide after 5 seconds
            setTimeout(() => {
                popup.style.display = 'none';
            }, 5000);
        }

        function closePopup() {
            document.getElementById('popupMessage').style.display = 'none';
        }

        // Enhanced Payment Type Header Update
        function updatePaymentTypeHeader(paymentType) {
            const header = document.getElementById('paymentTypeHeader');
            if (paymentType) {
                header.textContent = `Selected Payment Type: ${paymentType}`;
                header.className = 'has-payment';
            } else {
                header.textContent = '⚠️ कृपया Payment Type Select करें / Please Select Payment Type';
                header.className = 'no-payment';
            }
        }

        document.addEventListener("DOMContentLoaded", function () {
            const form = document.getElementById("bookingForm");
            const addArticleButton = document.getElementById("addArticle");
            const articleTable = document.getElementById("articleTable").getElementsByTagName("tbody")[0];
            const chargedWtInput = document.getElementById("chargedWt");
            const wtRateInput = document.getElementById("wtRate");
            const wtAmtInput = document.getElementById("wtAmt");
            const fixAmtInput = document.getElementById("fixAmt");
            const freightInput = document.getElementById("freight");
            const overallTotalAmtInput = document.getElementById("overallTotalAmt");
            const manualFields = document.querySelector(".manual-fields");
            const manualDateInput = document.getElementById("manualDate");
            const manualCNoteNumber = document.getElementById("manualCNoteNumber");
            const manualCNoteType = document.getElementById("manualCNoteType");
            const deliveryDestinationInput = document.getElementById("deliveryDestination");
            const deliveryDestinationIdInput = document.getElementById("deliveryDestinationId");
            const originalConsignorName = document.getElementById("consignorName").value;
            const originalConsignorMobile = document.getElementById("consignorMobile").value;
            const originalConsignorGST = document.getElementById("consignorGST").value;
            const originalConsignorAddress = document.getElementById("consignorAddress").value;
            const paymentTypeInput = document.getElementById('paymentType');
            const paymentTypeHeader = document.getElementById('paymentTypeHeader');
            const submitBtn = document.getElementById('submitBtn');
            const resetConsignorBtn = document.querySelector('.reset-consignor-btn');

            let isSubmitting = false;
            let originalSubmitText = submitBtn.textContent;

            const dropdownList = document.getElementById("dropdownList");
            const dropdownArrow = document.getElementById("dropdownArrow");
            let cities = [];
            let activeIndex = -1;
            let isFullListVisible = false;

            // Reset consignor info
            resetConsignorBtn.addEventListener('click', function() {
                document.getElementById('consignorName').value = originalConsignorName;
                document.getElementById('consignorMobile').value = originalConsignorMobile;
                document.getElementById('consignorGST').value = originalConsignorGST;
                document.getElementById('consignorAddress').value = originalConsignorAddress;
            });

            // Function to fetch cities from the backend
            function fetchCities() {
                fetch("/dealer/fetch_cities/")
                    .then((response) => {
                        if (!response.ok) {
                            throw new Error(`Failed to fetch cities: ${response.statusText}`);
                        }
                        return response.json();
                    })
                    .then((data) => {
                        if (data.success) {
                            cities = data.cities.map(city => ({
                                id: city.id,
                                name: city.destination_name
                            }));
                        } else {
                            console.error("Error fetching cities:", data.error);
                        }
                    })
                    .catch((error) => {
                        console.error("Error fetching cities:", error);
                    });
            }

            // Function to populate the dropdown based on a filter
            function populateDropdown(filter = "") {
                dropdownList.innerHTML = "";
                const filteredCities = filter
                    ? cities.filter(city => city.name.toLowerCase().includes(filter.toLowerCase()))
                    : cities;

                filteredCities.forEach((city, index) => {
                    const div = document.createElement("div");
                    div.classList.add("dropdown-item");
                    div.textContent = city.name;
                    div.dataset.id = city.id;
                    div.addEventListener("click", () => {
                        deliveryDestinationInput.value = city.name;
                        deliveryDestinationIdInput.value = city.id;
                        dropdownList.style.display = "none";
                        isFullListVisible = false;
                    });
                    dropdownList.appendChild(div);
                });

                if (filter || isFullListVisible) {
                    dropdownList.style.display = filteredCities.length > 0 ? "block" : "none";
                } else {
                    dropdownList.style.display = "none";
                }
                activeIndex = -1;
            }

            // Event listeners for the delivery destination input
            deliveryDestinationInput.addEventListener("input", (e) => {
                isFullListVisible = false;
                populateDropdown(e.target.value);
            });

            dropdownArrow.addEventListener("click", () => {
                if (dropdownList.style.display === "block" && isFullListVisible) {
                    dropdownList.style.display = "none";
                    isFullListVisible = false;
                } else {
                    populateDropdown();
                    isFullListVisible = true;
                    dropdownList.style.display = "block";
                }
            });

            document.addEventListener("click", (e) => {
                if (!e.target.closest(".search-container")) {
                    dropdownList.style.display = "none";
                    isFullListVisible = false;
                }
            });

            deliveryDestinationInput.addEventListener("keydown", (e) => {
                const items = Array.from(dropdownList.querySelectorAll(".dropdown-item"));

                if (e.key === "ArrowDown") {
                    e.preventDefault();
                    activeIndex = (activeIndex + 1) % items.length;
                    updateActiveItem(items);
                } else if (e.key === "ArrowUp") {
                    e.preventDefault();
                    activeIndex = (activeIndex - 1 + items.length) % items.length;
                    updateActiveItem(items);
                } else if (e.key === "Enter") {
                    e.preventDefault();
                    if (activeIndex >= 0 && items[activeIndex]) {
                        deliveryDestinationInput.value = items[activeIndex].textContent;
                        deliveryDestinationIdInput.value = items[activeIndex].dataset.id;
                        dropdownList.style.display = "none";
                        isFullListVisible = false;
                    } else if (items.length === 1) {
                        deliveryDestinationInput.value = items[0].textContent;
                        deliveryDestinationIdInput.value = items[0].dataset.id;
                        dropdownList.style.display = "none";
                        isFullListVisible = false;
                    }
                }
            });

            function updateActiveItem(items) {
                items.forEach(item => item.classList.remove("active"));
                if (activeIndex >= 0 && items[activeIndex]) {
                    items[activeIndex].classList.add("active");
                    items[activeIndex].scrollIntoView({ block: "nearest" });
                }
            }

            // Fetch cities on page load
            fetchCities();

            function updateDateTime() {
                const now = new Date();
                const options = { 
                    timeZone: "Asia/Kolkata",
                    year: "numeric",
                    month: "2-digit",
                    day: "2-digit",
                    hour: "2-digit",
                    minute: "2-digit",
                    second: "2-digit",
                    hour12: true
                };
                const dateTimeString = now.toLocaleString("en-US", options);
                document.getElementById("currentDateTime").textContent = dateTimeString;
            }

            setInterval(updateDateTime, 1000);
            updateDateTime();

            function updateCNoteStatus(status) {
                const statusInput = document.getElementById('cnoteStatus');
                const statusDisplay = document.getElementById('statusDisplay');
                statusInput.value = status;
                statusDisplay.className = `status-indicator status-${status.replace(' ', '-')}`;
                statusDisplay.textContent = `Status: ${status.charAt(0).toUpperCase() + status.slice(1)}`;
            }

            document.addEventListener("keydown", function (event) {
                const keyMap = {
                    F7: "PAID",
                    F8: "TO PAY",
                    F9: "TBB",
                    F10: "FOC",
                    "Alt+m": "MANUAL",
                };
                const type = keyMap[event.key] || (event.altKey && event.key === "m" ? keyMap["Alt+m"] : null);
                if (type) {
                    event.preventDefault();
                    updatePaymentType(type);
                }
            });

            ["paidBtn","toPayBtn","tbbBtn", "focBtn", "manualBtn"].forEach(id => {
                document.getElementById(id).addEventListener("click", () => {
                    if (id === "toPayBtn") {
                        updatePaymentType("TO PAY");
                    } else {
                        updatePaymentType(id.replace("Btn", "").toUpperCase());
                    }
                });
            });

            function updatePaymentType(type) {
                document.querySelectorAll('.function-keys span').forEach(span => {
                    span.classList.remove('active');
                });
                
                const buttonMap = {
                    'PAID': 'paidBtn',
                    'TO PAY': 'toPayBtn', 
                    'TBB': 'tbbBtn',
                    'FOC': 'focBtn',
                    'MANUAL': 'manualBtn'
                };
                
                if (buttonMap[type]) {
                    document.getElementById(buttonMap[type]).classList.add('active');
                }

                updatePaymentTypeHeader(type);
                
                document.getElementById("paymentType").value = type;
                
                manualFields.style.display = type === "MANUAL" ? "flex" : "none";

                const manualRequired = type === "MANUAL";
                [manualDateInput, manualCNoteNumber, manualCNoteType].forEach(el => el.required = manualRequired);

                if (manualRequired) {
                    setManualDateRestrictions();
                }

                closePopup();
            }

            function setManualDateRestrictions() {
                const today = new Date();
                const thirtyDaysAgo = new Date(today);
                thirtyDaysAgo.setDate(today.getDate() - 30);

                manualDateInput.max = today.toISOString().split("T")[0];
                manualDateInput.min = thirtyDaysAgo.toISOString().split("T")[0];
                manualDateInput.value = today.toISOString().split("T")[0];
            }

            function handleArticleTypeChange(select) {
                const row = select.closest("tr");
                const wtRateInput = document.getElementById("wtRate");
                const wtAmtInput = document.getElementById("wtAmt");
                const fixAmtInput = document.getElementById("fixAmt");
                const perPktAmtInput = row.querySelector(".per-pkt-amt");
                const totalAmtInput = row.querySelector(".total-amt");

                [wtRateInput, wtAmtInput, fixAmtInput, perPktAmtInput, totalAmtInput].forEach(input => {
                    input.disabled = false;
                    input.value = '';
                });

                if (select.value === 'Article' || !select.value) {
                    wtRateInput.disabled = true;
                    wtAmtInput.disabled = true;
                    fixAmtInput.disabled = true;
                    wtRateInput.value = '0';
                    wtAmtInput.value = '0';
                    fixAmtInput.value = '0';
                }

                updateRowFields(row);
                updateOverallTotal();
            }

            function updateRowFields(row) {
                const artInput = row.querySelector(".art-input");
                const perPktAmtInput = row.querySelector(".per-pkt-amt");
                const totalAmtInput = row.querySelector(".total-amt");
                const saidToContainInput = row.querySelector("input[name='saidToContain']");
                const selectedArticle = row.querySelector("select[name='article']").value;

                [artInput, perPktAmtInput, totalAmtInput, saidToContainInput].forEach(input => input.disabled = false);

                calculateRowAmount(row);
            }

            function calculateRowAmount(row) {
                const articleType = row.querySelector(".article-select").value;
                const artInput = row.querySelector(".art-input");
                const perPktAmtInput = row.querySelector(".per-pkt-amt");
                const totalAmtInput = row.querySelector(".total-amt");
                const wtRateInput = document.getElementById("wtRate");
                const wtAmtInput = document.getElementById("wtAmt");
                const fixAmtInput = document.getElementById("fixAmt");
                const chargedWtInput = document.getElementById("chargedWt");

                switch(articleType) {
                    case 'Article':
                        const art = parseFloat(artInput.value) || 0;
                        const perPktAmt = parseFloat(perPktAmtInput.value) || 0;
                        const totalAmt = art * perPktAmt;
                        totalAmtInput.value = totalAmt.toFixed(2);
                        break;
                    case 'Weight':
                        const chargedWt = parseFloat(chargedWtInput.value) || 0;
                        const wtRate = parseFloat(wtRateInput.value) || 0;
                        const wtAmt = chargedWt * wtRate;
                        wtAmtInput.value = wtAmt.toFixed(2);
                        break;
                    case 'Fix':
                        break;
                }

                updateOverallTotal();
            }

            function handleTotalAmtChange(row) {
                const artInput = row.querySelector(".art-input");
                const perPktAmtInput = row.querySelector(".per-pkt-amt");
                const totalAmtInput = row.querySelector(".total-amt");

                const art = parseFloat(artInput.value) || 0;
                const totalAmt = parseFloat(totalAmtInput.value) || 0;

                if (art !== 0) {
                    const perPktAmt = totalAmt / art;
                    perPktAmtInput.value = perPktAmt.toFixed(2);
                }

                updateOverallTotal();
            }

            function updateOverallTotal() {
                const articleTable = document.getElementById("articleTable").getElementsByTagName("tbody")[0];
                let total = 0;
                Array.from(articleTable.rows).forEach(row => {
                    const totalAmtInput = row.querySelector(".total-amt");
                    total += parseFloat(totalAmtInput.value) || 0;
                });
                const overallTotalAmtInput = document.getElementById("overallTotalAmt");
                overallTotalAmtInput.value = total.toFixed(2);
                updateFreight();
            }

            function updateFreight() {
                const overallTotalAmtInput = document.getElementById("overallTotalAmt");
                const freightInput = document.getElementById("freight");
                freightInput.value = overallTotalAmtInput.value;
                calculateGrandTotal();
            }

            function calculateGrandTotal() {
                const chargesInputs = document.querySelectorAll('.charges-container input[type="number"]');
                let grandTotal = 0;

                chargesInputs.forEach(input => {
                    if (input.id !== "grandTotal") {
                        const value = parseFloat(input.value) || 0;
                        grandTotal += value;
                    }
                });

                const grandTotalInput = document.getElementById("grandTotal");
                if (grandTotalInput) {
                    grandTotalInput.value = grandTotal.toFixed(2);
                }
            }

            function addArticle() {
                const newRow = articleTable.insertRow();
                newRow.innerHTML = `
                    <td>
                        <select name="article" class="article-select" required>
                            <option value="Article" selected>Article</option>
                            <option value="Weight">Weight</option>
                            <option value="Fix">Fix</option>
                        </select>
                    </td>
                    <td><input type="number" name="art" class="art-input" required></td>
                    <td>
                        <select name="artType" required>
                            <option value="">Select</option>
                            <option value="type1">SMALL BOX</option>
                            <option value="type2">BIG BOX</option>
                        </select>
                    </td>
                    <td><input type="text" name="saidToContain" required></td>
                    <td><input type="number" name="perPktAmt" class="per-pkt-amt" step="0.01" required></td>
                    <td><input type="number" name="totalAmt" class="total-amt" step="0.01" required></td>
                    <td><button type="button" class="remove-article">Remove</button></td>
                `;

                const select = newRow.querySelector("select[name='article']");
                select.value = "Article";
                handleArticleTypeChange(select);

                setupArticleRowListeners(newRow);
                updateOverallTotal();
            }

            addArticleButton.addEventListener("click", addArticle);

            articleTable.addEventListener("click", function (e) {
                if (e.target.classList.contains("remove-article")) {
                    e.target.closest("tr").remove();
                    updateOverallTotal();
                }
            });

            function setupArticleRowListeners(row) {
                const articleSelect = row.querySelector('.article-select');
                const artInput = row.querySelector('.art-input');
                const perPktAmtInput = row.querySelector('.per-pkt-amt');
                const totalAmtInput = row.querySelector('.total-amt');
                const saidToContainInput = row.querySelector('input[name="saidToContain"]');
                const wtRateInput = document.getElementById("wtRate");
                const fixAmtInput = document.getElementById("fixAmt");
                const chargedWtInput = document.getElementById("chargedWt");

                articleSelect.addEventListener('change', () => handleArticleTypeChange(articleSelect));
                artInput.addEventListener('input', () => calculateRowAmount(row));
                perPktAmtInput.addEventListener('input', () => calculateRowAmount(row));
                totalAmtInput.addEventListener('input', () => handleTotalAmtChange(row));
                saidToContainInput.addEventListener('input', () => calculateRowAmount(row));
                wtRateInput.addEventListener('input', () => calculateRowAmount(row));
                fixAmtInput.addEventListener('input', () => calculateRowAmount(row));
                chargedWtInput.addEventListener('input', () => calculateRowAmount(row));

                row.querySelector(".remove-article").disabled = articleTable.rows.length <= 1;
            }

            setupArticleRowListeners(articleTable.rows[0]);
            updateOverallTotal();

            articleTable.querySelectorAll("select[name='article']").forEach(select => {
                select.addEventListener("change", function () {
                    handleArticleTypeChange(this);
                });
            });

            updateRowFields(articleTable.rows[0]);
            addInputListeners();

            function addInputListeners() {
                const inputs = document.querySelectorAll('.art-input, .per-pkt-amt, .total-amt, .charges-container input[type="number"], input[name="saidToContain"]');
                inputs.forEach(input => {
                    input.addEventListener('input', function() {
                        updateOverallTotal();
                        calculateGrandTotal();
                    });
                });
            }

            var searchCnoteUrl = "{% url 'dealer:search_cnote' %}";

            document.getElementById("searchButton").addEventListener("click", function(e) {
                e.preventDefault();
                const cnoteNumber = document.getElementById("searchCNote").value.trim();
                
                if (cnoteNumber === "") {
                    showPopupMessage("कृपया valid CNote number enter करें! Please enter a valid CNote number.");
                    return;
                }
                
                console.log("Searching for CNote:", cnoteNumber);
                console.log("Redirecting to:", searchCnoteUrl + "?cnote_number=" + encodeURIComponent(cnoteNumber));
                
                window.location.href = searchCnoteUrl + "?cnote_number=" + encodeURIComponent(cnoteNumber);
            });

            document.querySelectorAll('.charges-container input[type="number"]').forEach(input => {
                input.addEventListener('input', calculateGrandTotal);
            });

            // Enhanced Form Submission with Popup Notifications
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                
                if (isSubmitting) {
                    showPopupMessage("⚠️ Form पहले से submit हो रहा है! Form is already being submitted, please wait...");
                    return;
                }

                calculateWeightAmount();
                calculateGrandTotal();

                const selectedPaymentType = paymentTypeInput.value;
                if (!selectedPaymentType) {
                    showPopupMessage("⚠️ कृपया Payment Mode select करें! Please select a payment mode before saving. (F7-PAID, F8-TO PAY, F9-TBB, F10-FOC)");
                    return;
                }

                const selectedDestinationId = deliveryDestinationIdInput.value;
                const destinationName = deliveryDestinationInput.value.trim();
                if (!selectedDestinationId || !destinationName) {
                    showPopupMessage("⚠️ कृपया valid delivery destination select करें! Please select a valid delivery destination from the dropdown.");
                    return;
                }

                const consigneeName = document.getElementById("consigneeName").value.trim();
                if (!consigneeName) {
                    showPopupMessage("⚠️ कृपया Consignee Name भरें! Please fill consignee name.");
                    return;
                }

                const consigneeMobile = document.getElementById("consigneeMobile").value.trim();
                if (!consigneeMobile || consigneeMobile.length !== 10) {
                    showPopupMessage("⚠️ कृपया valid 10 digit mobile number भरें! Please enter a valid 10-digit mobile number.");
                    return;
                }

                const articles = [];
                const rows = articleTable.querySelectorAll('tbody tr');
                let articleValidationFailed = false;
                
                rows.forEach((row, index) => {
                    const article = row.querySelector('select[name="article"]').value;
                    const art = row.querySelector('input[name="art"]').value;
                    const artType = row.querySelector('select[name="artType"]').value;
                    const saidToContain = row.querySelector('input[name="saidToContain"]').value;
                    const perPktAmt = row.querySelector('input[name="perPktAmt"]').value;
                    const totalAmt = row.querySelector('input[name="totalAmt"]').value;

                    if (!article || !art || !artType || !saidToContain || !perPktAmt || !totalAmt) {
                        showPopupMessage(`⚠️ Article row ${index + 1} में सभी fields भरें! Please fill all fields in article row ${index + 1}.`);
                        articleValidationFailed = true;
                        return;
                    }

                    articles.push({
                        article: article,
                        art: art,
                        artType: artType,
                        saidToContain: saidToContain,
                        perPktAmt: perPktAmt,
                        totalAmt: totalAmt
                    });
                });

                if (articleValidationFailed) {
                    return;
                }

                isSubmitting = true;
                submitBtn.disabled = true;
                submitBtn.textContent = 'Saving... कृपया प्रतीक्षा करें';
                submitBtn.style.backgroundColor = '#cccccc';
                submitBtn.style.cursor = 'not-allowed';

                const chargeFields = {
                    'freight': 'freight',
                    'docketCharge': 'docket_charge',
                    'doorDlyCharge': 'door_delivery_charge',
                    'handlingCharge': 'handling_charge',
                    'pickupCharge': 'pickup_charge',
                    'transhipmentCharge': 'transhipment_charge',
                    'insurance': 'insurance',
                    'fuelSurcharge': 'fuel_surcharge',
                    'commission': 'commission',
                    'otherCharge': 'other_charge',
                    'carrierRisk': 'carrier_risk',
                    'grandTotal': 'grand_total'
                };

                const formData = new FormData(this);

                formData.delete('article');
                formData.delete('art');
                formData.delete('artType');
                formData.delete('saidToContain');
                formData.delete('perPktAmt');
                formData.delete('totalAmt');
                articles.forEach((article, index) => {
                    Object.entries(article).forEach(([key, value]) => {
                        formData.append(`articles[${index}][${key}]`, value);
                    });
                });

                Object.entries(chargeFields).forEach(([frontendId, backendName]) => {
                    const input = document.getElementById(frontendId);
                    if (input) {
                        const value = parseFloat(input.value) || 0;
                        formData.set(backendName, value.toFixed(2));
                    }
                });

                console.log("Form data before submission:");
                for (let [key, value] of formData.entries()) {
                    console.log(`${key}: ${value}`);
                }

                showPopupMessage("📤 Form submit हो रहा है... Please wait, form is being submitted...", 'success');

                fetch(this.action, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                        'Accept': 'application/json'
                    }
                })
                .then(response => {
                    if (!response.ok) {
                        return response.text().then(text => {
                            try {
                                return Promise.reject(JSON.parse(text));
                            } catch (e) {
                                return Promise.reject({ error: text });
                            }
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        showPopupMessage("✅ Form successfully submitted! फॉर्म सफलतापूर्वक submit हो गया!", 'success');
                        
                        submitBtn.textContent = 'Success! Redirecting...';
                        
                        setTimeout(() => {
                            window.location.href = data.redirect_url;
                        }, 1500);
                    } else {
                        console.error('Error in server response:', data.error);
                        showPopupMessage('❌ Error: ' + data.error);
                        resetSubmissionState();
                    }
                })
                .catch(error => {
                    console.error('Error during form submission:', error);
                    if (!error.redirect_url) {
                        showPopupMessage('❌ Form submit करने में error आया है! An error occurred while saving the data. Please try again.');
                    }
                    resetSubmissionState();
                });
            });

            function resetSubmissionState() {
                isSubmitting = false;
                submitBtn.disabled = false;
                submitBtn.textContent = originalSubmitText;
                submitBtn.style.backgroundColor = '#4caf50';
                submitBtn.style.cursor = 'pointer';
            }

            function validateForm() {
                const requiredFields = form.querySelectorAll('[required]');
                let isValid = true;
                requiredFields.forEach(field => {
                    if (!field.value.trim()) {
                        isValid = false;
                        field.classList.add('error');
                    } else {
                        field.classList.remove('error');
                    }
                });
                return isValid;
            }

            function validateNumericInput(input) {
                input.addEventListener('input', function() {
                    this.value = this.value.replace(/[^0-9.]/g, '');
                    if (this.value.split('.').length > 2) {
                        this.value = this.value.replace(/\.+$/, '');
                    }
                });
            }

            document.querySelectorAll('input[type="number"]').forEach(validateNumericInput);

            chargedWtInput.addEventListener('input', calculateWeightAmount);
            wtRateInput.addEventListener('input', calculateWeightAmount);

            document.getElementById("wtRate").addEventListener('input', () => calculateRowAmount(articleTable.rows[0]));
            document.getElementById("fixAmt").addEventListener('input', () => calculateRowAmount(articleTable.rows[0]));
            document.getElementById("chargedWt").addEventListener('input', () => calculateRowAmount(articleTable.rows[0]));

            function calculateWeightAmount() {
                const chargedWt = parseFloat(chargedWtInput.value) || 0;
                const wtRate = parseFloat(wtRateInput.value) || 0;
                wtAmtInput.value = (chargedWt * wtRate).toFixed(2);
                calculateGrandTotal();
            }

            // Initialize the default state for the first row
            const defaultArticleSelect = articleTable.querySelector("select[name='article']");
            if (defaultArticleSelect) {
                handleArticleTypeChange(defaultArticleSelect);
            }

            // Initialize payment type header
            updatePaymentTypeHeader('');
        });

        document.querySelectorAll('input, textarea').forEach(input => {
            input.addEventListener('input', function() {
                this.value = this.value.toUpperCase();
            });
        });

        document.addEventListener("DOMContentLoaded", function () {
            const consigneeNameInput = document.getElementById("consigneeName");
            const destinationInput = document.getElementById("deliveryDestination");
            const destinationWiseCheckbox = document.getElementById("destinationWiseParty");
            const suggestionsList = document.getElementById("consigneeSuggestions");
            let debounceTimer;
            let selectedIndex = -1;

            // Input event handler with debounce
            consigneeNameInput.addEventListener("input", function() {
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(() => {
                    const query = this.value.trim();
                    const destination = destinationInput.value.trim();
                    const destinationWise = destinationWiseCheckbox.checked;

                    if (query.length < 2) {
                        suggestionsList.innerHTML = "";
                        suggestionsList.style.display = "none";
                        return;
                    }

                    fetchPartySuggestions(query, destination, destinationWise);
                }, 300);
            });

            // Event listeners for destination and checkbox changes
            destinationInput.addEventListener("change", function() {
                if (consigneeNameInput.value.trim().length >= 2) {
                    const query = consigneeNameInput.value.trim();
                    const destination = this.value.trim();
                    const destinationWise = destinationWiseCheckbox.checked;
                    fetchPartySuggestions(query, destination, destinationWise);
                }
            });

            destinationWiseCheckbox.addEventListener("change", function() {
                if (consigneeNameInput.value.trim().length >= 2) {
                    const query = consigneeNameInput.value.trim();
                    const destination = destinationInput.value.trim();
                    const destinationWise = this.checked;
                    fetchPartySuggestions(query, destination, destinationWise);
                }
            });

            function fetchPartySuggestions(query, destination, destinationWise) {
                const params = new URLSearchParams({
                    query: query,
                    destination: destination,
                    destination_wise: destinationWise
                });

                fetch(`/dealer/api/party-suggestions/?${params}`)
                    .then(response => response.json())
                    .then(data => {
                        suggestionsList.innerHTML = "";
                        
                        data.forEach(party => {
                            const li = document.createElement("li");
                            li.innerHTML = `
                                <strong>${party.party_name}</strong>
                                <br>Code: ${party.party_code}
                                ${party.mobile_number_1 ? `<br>Mobile: ${party.mobile_number_1}` : ''}
                                ${party.gst_no ? `<br>GST: ${party.gst_no}` : ''}
                                ${party.city ? `<br>City: ${party.city}` : ''}
                            `;
                            li.addEventListener("click", () => {
                                fillConsigneeDetails(party);
                                suggestionsList.style.display = "none";
                            });
                            suggestionsList.appendChild(li);
                        });

                        suggestionsList.style.display = data.length > 0 ? "block" : "none";
                    })
                    .catch(error => {
                        console.error("Error fetching suggestions:", error);
                        suggestionsList.style.display = "none";
                    });
            }

            function fillConsigneeDetails(party) {
                document.getElementById("consigneeName").value = party.party_name;
                document.getElementById("consigneeMobile").value = party.mobile_number_1 || '';
                document.getElementById("consigneeGST").value = party.gst_no || '';
                document.getElementById("consigneeAddress").value = 
                    `${party.address || ''}\n${party.city || ''}\n${party.state || ''}`.trim();
            }

            // Handle keyboard navigation
            consigneeNameInput.addEventListener("keydown", function(e) {
                const items = suggestionsList.getElementsByTagName("li");
                
                switch(e.key) {
                    case "ArrowDown":
                        e.preventDefault();
                        selectedIndex = Math.min(selectedIndex + 1, items.length - 1);
                        updateSelection(items);
                        break;
                    case "ArrowUp":
                        e.preventDefault();
                        selectedIndex = Math.max(selectedIndex - 1, 0);
                        updateSelection(items);
                        break;
                    case "Enter":
                        e.preventDefault();
                        if (selectedIndex >= 0 && items[selectedIndex]) {
                            items[selectedIndex].click();
                        }
                        break;
                    case "Escape":
                        suggestionsList.style.display = "none";
                        selectedIndex = -1;
                        break;
                }
            });

            function updateSelection(items) {
                Array.from(items).forEach((item, index) => {
                    item.classList.toggle("selected", index === selectedIndex);
                    if (index === selectedIndex) {
                        item.scrollIntoView({ block: "nearest" });
                    }
                });
            }

            // Close suggestions when clicking outside
            document.addEventListener("click", function(e) {
                if (!consigneeNameInput.contains(e.target) && !suggestionsList.contains(e.target)) {
                    suggestionsList.style.display = "none";
                    selectedIndex = -1;
                }
            });
        });
    </script>
</body>
</html>
