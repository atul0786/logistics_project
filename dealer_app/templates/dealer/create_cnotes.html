<!DOCTYPE html>
<html lang="en">
<head>
    {% load static %} 
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Logistics Management System</title>
    <link
        rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        .reset-consignor-btn {
            background-color: #6c757d;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 5px 10px;
            margin-left: 10px;
            cursor: pointer;
            font-size: 0.8em;
        }

        .reset-consignor-btn:hover {
            background-color: #5a6268;
        }

        body {
            font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.4;
            background-color: #f0f8ff;
            color: #333;
            height: 100vh;
            overflow-x: hidden;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 10px;
            height: calc(100vh - 100px);
            overflow-y: auto;
        }

        header {
            background-color: #87ceeb;
            color: #333;
            padding: 5px 0;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            height: 60px;
        }

        .logo {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            overflow: hidden;
        }

        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 10px;
            height: 100%;
        }

        .user-info {
            text-align: center;
            flex-grow: 1;
            margin: 0 20px;
        }

        .search-bar {
            display: flex;
            align-items: center;
            background-color: white;
            border-radius: 20px;
            padding: 5px 10px;
            margin-right: 20px;
        }

        .search-bar input {
            border: none;
            outline: none;
            padding: 5px;
            width: 200px;
        }

        .search-bar button {
            background-color: #4682b4;
            color: white;
            border: none;
            border-radius: 20px;
            padding: 5px 15px;
            cursor: pointer;
        }

        .logout-button button {
            background-color: #ff4500;
            color: white;
            border: none;
            border-radius: 20px;
            padding: 5px 15px;
            cursor: pointer;
        }

        nav ul {
            list-style-type: none;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0;
            margin: 0;
            background-color: #4682b4;
        }

        nav ul li {
            position: relative;
            margin: 0;
        }

        nav ul li a {
            color: white;
            text-decoration: none;
            padding: 10px 15px;
            display: block;
            transition: background-color 0.3s ease;
        }

        nav ul li a:hover {
            background-color: #3a6d8c;
        }

        nav ul li ul {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            background-color: #4682b4;
            min-width: 200px;
            z-index: 1000;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border-radius: 4px;
        }

        nav ul li:hover > ul {
            display: block;
        }

        nav ul li ul li {
            width: 100%;
        }

        nav ul li ul li a {
            color: white;
            text-decoration: none;
            padding: 10px 15px;
            display: block;
            background-color: #4682b4;
            transition: background-color 0.3s ease;
        }

        nav ul li ul li a:hover {
            background-color: #3a6d8c;
        }

        nav ul li ul li:first-child a {
            border-top-left-radius: 4px;
            border-top-right-radius: 4px;
        }

        nav ul li ul li:last-child a {
            border-bottom-left-radius: 4px;
            border-bottom-right-radius: 4px;
        }

        .function-keys {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-top: 10px;
        }

        .function-keys span {
            font-size: 14px;
            font-weight: bold;
            text-align: center;
            cursor: pointer;
            padding: 10px 15px;
            background-color: #f0f0f0;
            border: 1px solid #ddd;
            border-radius: 5px;
            transition: background-color 0.3s, color 0.3s;
        }

        .function-keys span:hover {
            background-color: #007bff;
            color: white;
        }

        .function-keys span.active {
            background-color: #007bff;
            color: white;
        }

        main {
            display: flex;
            gap: 10px;
            height: calc(100% - 30px);
            overflow: hidden;
            padding: 10px 0;
        }

        .form-container, .charges-container {
            background-color: white;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            overflow-y: auto;
        }

        .form-container {
            flex: 3;
        }

        .charges-container {
            flex: 1;
        }

        h2 {
            margin-bottom: 10px;
            color: #4682b4;
            border-bottom: 2px solid #4682b4;
            padding-bottom: 5px;
            font-size: 1.2em;
        }

        .form-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .form-group {
            flex: 1;
        }

        label {
            display: block;
            margin-bottom: 2px;
            font-weight: bold;
            font-size: 0.9em;
        }

        input, select, textarea {
            width: 100%;
            padding: 4px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9em;
        }

        textarea {
            height: 40px;
            resize: none;
        }

        .article-details {
            max-height: 150px;
            overflow-y: auto;
            margin: 10px 0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9em;
        }

        th, td {
            border: 1px solid #ddd;
            padding: 4px;
            text-align: left;
        }

        th {
            background-color: #4682b4;
            color: white;
        }

        .charges-container table td {
            padding: 3px;
        }

        .charges-container input {
            padding: 2px 4px;
        }

        button {
            background-color: #4682b4;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 0.9em;
        }

        button:hover {
            background-color: #3a6d8c;
        }

        .status-indicator {
            display: inline-block;
            padding: 3px 6px;
            border-radius: 4px;
            font-size: 0.8em;
            margin: 5px 0;
        }

        .status-booked { background-color: #ffd700; color: #000; }
        .status-dispatched { background-color: #1e90ff; color: #fff; }
        .status-received { background-color: #32cd32; color: #fff; }
        .status-delivered { background-color: #008000; color: #fff; }
        .status-cancelled { background-color: #ff0000; color: #fff; }

        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        @media (max-width: 1200px) {
            .form-container {
                flex: 2;
            }
            
            .form-row {
                flex-wrap: wrap;
            }
            
            .form-group {
                flex: 1 1 calc(50% - 5px);
            }
        }

        .required::after {
            content: " *";
            color: red;
        }

        #submitBtn {
            background-color: #4caf50;
            width: 100%;
            padding: 10px;
            margin-top: 10px;
            font-size: 1em;
        }

        #submitBtn:hover {
            background-color: #45a049;
        }

        .manual-fields {
            display: none;
        }

        .error {
            border: 1px solid red;
        }
    </style>
</head>
<body>
    <header>
        <div class="top-bar">
            <div class="logo" style="width: 55px; height: 55px; border-radius: 50%; overflow: hidden;">  
                {% if dealer.photo %}  
                    <img src="{{ dealer.photo.url }}" alt="Dealer Photo" style="width: 100%; height: 100%; object-fit: cover">  
                {% else %}  
                    
                {% endif %}  
            </div>
            <div class="user-info"> 
                <p>Welcome {{ dealer.name }} ({{ dealer.city}} - {{ dealer.state}})</p>
                <p id="currentDateTime"></p>  
            </div>  
            <div class="search-bar">
                <form method="GET" action="{% url 'dealer:search_cnote' %}">
                    <input type="text" id="searchCNote" name="cnote_number" placeholder="Search CNote Number" required />
                    <button type="submit" id="searchButton">Search</button>
                </form>
            </div>
            <form action="{% url 'logout' %}" method="post" class="logout-button">
                {% csrf_token %}
                <button type="submit" id="logoutBtn">Logout</button>
            </form>
        </div>
    </header>

    <nav>
        <ul>
            <li>
                <a href="#"><i class="fas fa-home"></i> Home</a>
            </li>
            <li>
                <a href="#"><i class="fas fa-cogs"></i> Operations</a>
                <ul>
                    <li>
                        <a href="{% url 'dealer:create_cnotes' %}"> Booking</a>
                    </li>
                    <li>
                        <a href="{% url 'dealer:loading_sheet' %}"> Loading Sheet</a>
                    </li>
                    <li>
                        <a href="#">Operation 3</a>
                    </li>
                </ul>
            </li>
            <li>
                <a href="{% url 'dealer:search' %}"><i class="fas fa-search"></i> Search</a>
            </li>
            <li>
                <a href="{% url 'dealer:booking_register' %}"><i class="fas fa-chart-bar"></i> Report</a>
                <ul>
                    <li><a href="{% url 'dealer:booking_register' %}">Booking Register</a></li>
                    <li><a href="#">Report 2</a></li>
                    <li><a href="#">Report 3</a></li>
                </ul>
            </li>
            <li>
                <a href="#"><i class="fas fa-user"></i> Profile</a>
                <ul>
                    <li><a href="#">Edit Profile</a></li>
                    <li><a href="#">Change Password</a></li>
                    <li><a href="#">Logout</a></li>
                </ul>
            </li>
            <li>
                <a href="#"><i class="fas fa-tasks"></i> Masters</a>
                <ul>
                    <li><a href="#">Master 1</a></li>
                    <li><a href="#">Master 2</a></li>
                    <li><a href="#">Master 3</a></li>
                </ul>
            </li>
            <li>
                <a href="#"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
                <ul>
                    <li><a href="#">Overview</a></li>
                    <li><a href="#">Analytics</a></li>
                    <li><a href="#">Reports</a></li>
                </ul>
            </li>
        </ul>
    </nav>

    <div class="function-keys">
        <span id="paidBtn">F7 : PAID</span>
        <span id="toPayBtn">F8 : TO PAY</span>
        <span id="tbbBtn">F9 : TBB</span>
        <span id="focBtn">F10 : FOC</span>
        <span id="manualBtn">ALT+M : MANUAL</span>
    </div>

    <div class="container">
        <main>
            <div class="form-container">
                <h2 id="paymentTypeHeader">Select Payment Type</h2>

                {% if cnote.status != 'cancelled' %}
                    {% if user.is_transporter %}
                        {% if cnote.status == 'dispatched' %}
                            <form action="{% url 'mark_cnote_received' cnote.id %}" method="post">
                                {% csrf_token %}
                                <button type="submit">Mark as Received</button>
                            </form>
                        {% elif cnote.status == 'received' %}
                            <form action="{% url 'create_delivery' cnote.id %}" method="post">
                                {% csrf_token %}
                                <button type="submit">Create Delivery</button>
                            </form>
                        {% endif %}
                    {% endif %}
                    
                    {% if user.is_dealer and cnote.status == 'booked' %}
                        <form action="{% url 'cancel_cnote' cnote.id %}" method="post">
                            {% csrf_token %}
                            <button type="submit">Cancel CNote</button>
                        </form>
                    {% endif %}
                {% endif %}

                <form id="bookingForm" method="post" action="{% url 'dealer:create_cnotes' %}">
                    {% csrf_token %}
                    <input type="hidden" id="paymentType" name="paymentType" value="" />
                    <input type="hidden" id="cnoteStatus" name="cnoteStatus" value="booked">

                    <div id="statusDisplay" class="status-indicator status-booked">Status: Booked</div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="bookingType" class="required">Booking Type</label>
                            <select id="bookingType" name="booking_type" required>
                                <option value="sundry" selected>Sundry</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="deliveryType" class="required">Delivery Type</label>
                            <select id="deliveryType" name="delivery_type" required>
                                <option value="economy" selected>ECONOMY DELIVERY</option>
                                <option value="express">EXPRESS DELIVERY</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="deliveryMethod" class="required">Delivery Method</label>
                            <select id="deliveryMethod" name="delivery_method" required>
                                <option value="door" selected>Door Delivery</option>
                                <option value="godown">Godown Delivery</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="deliveryDestination" class="required">Delivery Destination</label>
                            <select id="deliveryDestination" name="delivery_destination" required>
                                <option value="">Select a City</option>
                                {% for city in cities %}
                                    <option value="{{ city.name }}">{{ city.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    
                        <div class="form-group">
                            <label for="ewayBillNumber">EWAYBILL NUMBER</label>
                            <input type="text" id="ewayBillNumber" name="ewayBillNumber" />
                        </div>
                    </div>

                    <div class="form-row manual-fields">
                        <div class="form-group">
                            <label for="manualDate" class="required">Manual Date</label>
                            <input type="date" id="manualDate" name="manualDate" required />
                        </div>
                        <div class="form-group">
                            <label for="manualCNoteNumber" class="required">CN Note Number</label>
                            <input type="text" id="manualCNoteNumber" name="manualCNoteNumber" required />
                        </div>
                        <div class="form-group">
                            <label for="manualCNoteType" class="required">CN Note Type</label>
                            <select id="manualCNoteType" name="manualCNoteType" required>
                                <option value="">Select</option>
                                <option value="paid">Paid</option>
                                <option value="topay">To Pay</option>
                                <option value="tbb">TBB</option>
                                <option value="foc">FOC</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <h3>Consignor (From)</h3>
                            <label for="consignorName" class="required">Consignor Name</label>
                            <input type="text" id="consignorName" name="consignor_name" required value="{{ dealer.name }}" />
                            <label for="consignorMobile" class="required">Mobile No</label>
                            <input type="tel" id="consignorMobile" name="consignor_mobile" maxlength="10" required value="{{ dealer.mobile_number_1 }}" />
                            <label for="consignorGST">GST No</label>
                            <input type="text" id="consignorGST" name="consignorGST" value="{{ dealer.gstn }}" />
                            <label for="consignorAddress">Address</label>
                            <textarea id="consignorAddress" name="consignorAddress" rows="3">{{ dealer.address }}</textarea>
                        </div>
                        <div class="form-group">
                            <h3>Consignee (To)</h3>
                            <label for="consigneeName" class="required">Consignee Name</label>
                            <input type="text" id="consigneeName" name="consignee_name" required value="{{ consignee_data.name|default:'' }}" />
                            <label for="consigneeMobile" class="required">Mobile No</label>
                            <input type="tel" id="consigneeMobile" name="consignee_mobile" maxlength="10" required value="{{ consignee_data.mobile|default:'' }}" />
                            <label for="consigneeGST">GST No</label>
                            <input type="text" id="consigneeGST" name="consigneeGST" value="{{ consignee_data.gst|default:'' }}" />
                            <label for="consigneeAddress">Address</label>
                            <textarea id="consigneeAddress" name="consigneeAddress" rows="3">{{ consignee_data.address|default:'' }}</textarea>
                        </div>
                    </div>

                    <h3>Article Details</h3>
                    <div class="article-details">
                        <table id="articleTable">
                          <thead>
                            <tr>
                                <th>Article</th>
                                <th>Art</th>
                                <th>Art Type</th>
                                <th>Said To Contain</th>
                                <th>Per Pkt Amt</th>
                                <th>Total Amt</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                            <tbody>
                                <tr>
                                    <td>
                                        <select name="article" class="article-select" required>
                                            <option value="Article" selected>Article</option>
                                            <option value="Weight">Weight</option>
                                            <option value="Fix">Fix</option>
                                        </select>
                                    </td>
                                    <td><input type="number" name="art" required /></td>
                                    <td>
                                        <select name="artType" required>
                                            <option value="">Select</option>
                                            <option value="type1">Type 1</option>
                                            <option value="type2">Type 2</option>
                                        </select>
                                    </td>
                                    <td><input type="text" name="saidToContain" required /></td>
                                    <td><input type="number" name="perPktAmt" class="per-pkt-amt" step="0.01" required /></td>
                                    <td><input type="number" name="totalAmt" class="total-amt" step="0.01" required /></td>
                                    
                                    <td>
                                        <button type="button" class="remove-article" disabled>Remove</button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <button type="button" id="addArticle">Add Article</button>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="actualWt" class="required">Actual Wt</label>
                            <input type="number" id="actualWt" name="actual_weight" step="0.01" required />
                        </div>
                        <div class="form-group">
                            <label for="chargedWt" class="required">Charged Wt</label>
                            <input type="number" id="chargedWt" name="charged_weight" step="0.01" required />
                        </div>
                        <div class="form-group">
                            <label for="wtRate" class="required">Wt Rate</label>
                            <input type="number" id="wtRate" name="weight_rate" step="0.01" required />
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="wtAmt">Wt Amt</label>
                            <input type="number" id="wtAmt" name="weight_amount" step="0.01" readonly />
                        </div>
                        <div class="form-group">
                            <label for="fixAmt">Fix Amt</label>
                            <input type="number" id="fixAmt" name="fix_amount" step="0.01" />
                        </div>
                        <div class="form-group">
                            <label for="invoiceNo" class="required">Invoice No</label>
                            <input type="text" id="invoiceNo" name="invoice_number" required />
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="declaredValue" class="required">Declared Value</label>
                            <input type="number" id="declaredValue" name="declared_value" step="0.01" required />
                        </div>
                        <div class="form-group">
                            <label for="riskType" class="required">Risk Type</label>
                            <select id="riskType" name="risk_type" required>
                                <option value="owner" selected>Owner Risk</option>
                                <option value="carrier">Carrier Risk</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="podRequired">POD Required</label>
                            <select id="podRequired" name="pod_required">
                                <option value="yes">YES</option>
                                <option value="no">NO</option>
                            </select>
                        </div>
                    </div>

                    <button type="submit" id="submitBtn">Save</button>
                </form>
            </div>

            <div class="charges-container">
                <h2>Charges</h2>
                <table>
                    <tr>
                        <td>Freight</td>
                        <td>
                            <input type="number" id="freight" name="freight" value="0" step="0.01" />
                        </td>
                    </tr>
                    <tr>
                        <td>Docket Charge</td>
                        <td>
                            <input type="number" id="docketCharge" name="docket_charge" value="0" step="0.01" />
                        </td>
                    </tr>
                    <tr>
                        <td>Door Dly.</td>
                        <td>
                            <input type="number" id="doorDlyCharge" name="door_delivery_charge" value="0" step="0.01" />
                        </td>
                    </tr>
                    <tr>
                        <td>Handling</td>
                        <td>
                            <input type="number" id="handlingCharge" name="handling_charge" value="0" step="0.01" />
                        </td>
                    </tr>
                    <tr>
                        <td>Pickup</td>
                        <td>
                            <input type="number" id="pickupCharge" name="pickup_charge" value="0" step="0.01" />
                        </td>
                    </tr>
                    <tr>
                        <td>Transhipment Charge</td>
                        <td>
                            <input type="number" id="transhipmentCharge" name="transhipment_charge" value="0" step="0.01" />
                        </td>
                    </tr>
                    <tr>
                        <td>Insurance</td>
                        <td>
                            <input type="number" id="insurance" name="insurance" value="0" step="0.01" />
                        </td>
                    </tr>
                    <tr>
                        <td>Fuel Surcharge</td>
                        <td>
                            <input type="number" id="fuelSurcharge" name="fuel_surcharge" value="0" step="0.01" />
                        </td>
                    </tr>
                    <tr>
                        <td>Commission</td>
                        <td>
                            <input type="number" id="commission" name="commission" value="0" step="0.01" />
                        </td>
                    </tr>
                    <tr>
                        <td>Other</td>
                        <td>
                            <input type="number" id="otherCharge" name="other_charge" value="0" step="0.01" />
                        </td>
                    </tr>
                    <tr>
                        <td>Carrier Risk</td>
                        <td>
                            <input type="number" id="carrierRisk" name="carrier_risk" value="0" step="0.01" />
                        </td>
                    </tr>
                    <tr>
                        <td>Grand Total</td>
                        <td>
                            <input type="number" id="grandTotal" name="grand_total" value="0" step="0.01" readonly />
                        </td>
                    </tr>
                </table>
                
                <div style="clear: both;"></div>
                <div class="last-cnote-details" style="margin-top: 10px;">
                    <h3 style="color: #4682b4; font-weight: bold; text-decoration: underline;">
                        <a href="{% url 'dealer:view_cnote' last_cnote.cnote_number %}" style="color: #4682b4; text-decoration: underline;">
                            Last CNote Details
                        </a>
                    </h3>
                    {% if last_cnote %}
                        <p><strong>CNote Number:</strong> {{ last_cnote.cnote_number }}</p>
                        <p><strong>Destination:</strong> {{ last_cnote.delivery_destination }}</p>
                        <p><strong>Payment Mode:</strong> {{ last_cnote.payment_type }}</p>
                        <p><strong>Article:</strong> 
                            {% for article in last_cnote.articles.all %}
                                {{ article.article_type }} ({{ article.art }}){% if not forloop.last %}, {% endif %}
                            {% endfor %}
                        </p>
                        <p><strong>Total Amount:</strong> {{ last_cnote.grand_total }}</p>
                    {% else %}
                        <p>No CNote available.</p>
                    {% endif %}
                </div>
            </div>
        </main>
    </div>

    <div class="status-update-container" style="margin-top: 20px;">
        <h3>Update CNote Status</h3>
        {% if cnote %}
            <form action="{% url 'dealer:update_cnote_status' cnote.id %}" method="post">
                {% csrf_token %}
                <select name="status">
                    {% for status, label in cnote.STATUS_CHOICES %}
                        <option value="{{ status }}">{{ label }}</option>
                    {% endfor %}
                </select>
                <button type="submit">Update Status</button>
            </form>
        {% else %}
            <p>No CNote available to update.</p>
        {% endif %}
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const form = document.getElementById("bookingForm");
            const addArticleButton = document.getElementById("addArticle");
            const articleTable = document.getElementById("articleTable").getElementsByTagName("tbody")[0];
            const chargedWtInput = document.getElementById("chargedWt");
            const wtRateInput = document.getElementById("wtRate");
            const wtAmtInput = document.getElementById("wtAmt");
            const fixAmtInput = document.getElementById("fixAmt");
            const freightInput = document.getElementById("freight");
            const manualFields = document.querySelector(".manual-fields");
            const manualDateInput = document.getElementById("manualDate");
            const manualCNoteNumber = document.getElementById("manualCNoteNumber");
            const manualCNoteType = document.getElementById("manualCNoteType");
            const deliveryDestinationInput = document.getElementById("deliveryDestination");
            const originalConsignorName = document.getElementById("consignorName").value;
            const originalConsignorMobile = document.getElementById("consignorMobile").value;
            const originalConsignorGST = document.getElementById("consignorGST").value;
            const originalConsignorAddress = document.getElementById("consignorAddress").value;
            const paymentTypeInput = document.getElementById('paymentType');
            const paymentTypeHeader = document.getElementById('paymentTypeHeader');


            let destinationList = document.getElementById("destinationList");
            if (!destinationList) {
                destinationList = document.createElement("ul");
                destinationList.id = "destinationList";
                destinationList.style.display = "none";
                destinationList.style.position = "absolute";
                destinationList.style.background = "white";
                destinationList.style.border = "1px solid #ddd";
                destinationList.style.maxHeight = "150px";
                destinationList.style.overflowY = "auto";
                deliveryDestinationInput.parentNode.insertBefore(destinationList, deliveryDestinationInput.nextSibling);
            }

            // Create reset button
            const resetConsignorBtn = document.createElement('button');
            resetConsignorBtn.type = 'button';
            resetConsignorBtn.className = 'reset-consignor-btn';
            resetConsignorBtn.textContent = 'Reset to Dealer Info';
            resetConsignorBtn.onclick = function() {
                document.getElementById('consignorName').value = originalConsignorName;
                document.getElementById('consignorMobile').value = originalConsignorMobile;
                document.getElementById('consignorGST').value = originalConsignorGST;
                document.getElementById('consignorAddress').value = originalConsignorAddress;
            };

            // Insert the reset button after the consignor section
            document.querySelector(".form-group h3").appendChild(resetConsignorBtn);

            const validDestinations = ["MUMBAI", "DELHI", "BANGALORE", "CHENNAI", "KOLKATA"];
            let selectedIndex = -1;
            let articleType = "Article";

            function showAutocompleteList(input) {
                const value = input.value.toUpperCase();
                const filteredDestinations = validDestinations.filter((dest) => dest.startsWith(value));
                destinationList.innerHTML = "";

                if (filteredDestinations.length > 0) {
                    filteredDestinations.forEach((dest) => {
                        const li = document.createElement("li");
                        li.textContent = dest;
                        li.addEventListener("click", () => {
                            input.value = dest;
                            destinationList.style.display = "none";
                        });
                        destinationList.appendChild(li);
                    });
                    destinationList.style.display = "block";
                } else {
                    destinationList.style.display = "none";
                }
                selectedIndex = -1;
            }

            deliveryDestinationInput.addEventListener("input", function () {
                showAutocompleteList(this);
            });

            // Payment mode handler
            function initializePaymentMode() {
                const paymentButtons = {
                    'paidBtn': 'PAID',
                    'toPayBtn': 'TO PAY', 
                    'tbbBtn': 'TBB',
                    'focBtn': 'FOC'
                };

                const paymentTypeInput = document.getElementById('paymentType');
                const paymentTypeHeader = document.getElementById('paymentTypeHeader');

              // Set TBB as default
              function setDefaultPaymentMode() {
                  const tbbBtn = document.getElementById('tbbBtn');
                  if (tbbBtn) {
                      
                      // Simulate a click on the TBB button
                      tbbBtn.click(); // This will trigger the click event for TBB button
                  }
              }

              function setActiveButton(button) {
                  Object.keys(paymentButtons).forEach(btnId => 
                      document.getElementById(btnId)?.classList.remove('active')
                  );
                  button.classList.add('active');
              }

              function updatePaymentType(type) {
                  if (paymentTypeHeader) paymentTypeHeader.textContent = type;
                  if (paymentTypeInput) paymentTypeInput.value = type;
              }

              // Add click handlers to payment buttons
              Object.keys(paymentButtons).forEach(btnId => {
                  const btn = document.getElementById(btnId);
                  if (btn) {
                      btn.addEventListener('click', () => {
                          setActiveButton(btn);
                          updatePaymentType(paymentButtons[btnId]);
                      });
                  }
              });

              // Add keyboard shortcuts
              document.addEventListener('keydown', (event) => {
                  const keyMap = {
                      'F7': 'PAID',
                      'F8': 'TO PAY',
                      'F9': 'TBB',
                      'F10': 'FOC'
                  };

                const type = keyMap[event.key];
                if (type) {
                    event.preventDefault();
                    const button = document.getElementById(`${type.toLowerCase().replace(' ', '')}Btn`);
                    if (button) {
                        setActiveButton(button);
                        updatePaymentType(type);
                    }
                }
            });

            // Set default mode on initialization
            setDefaultPaymentMode();
        }
           // Initialize payment mode

            function initializePaymentMode() {
                  const tbbBtn = document.getElementById('tbbBtn');
                  if (tbbBtn) {
                      // Simulate a click on the TBB button
                      tbbBtn.click(); // This will trigger the click event for TBB button
                  }
               }

               // Call the function to set the default payment type
                initializePaymentMode();


            deliveryDestinationInput.addEventListener("keydown", function (e) {
                const items = destinationList.getElementsByTagName("li");
                if (e.key === "ArrowDown" || e.key === "ArrowUp") {
                    e.preventDefault();
                    selectedIndex = e.key === "ArrowDown" 
                        ? (selectedIndex < items.length - 1 ? selectedIndex + 1 : 0)
                        : (selectedIndex > 0 ? selectedIndex - 1 : items.length - 1);
                    updateSelectedItem(items);
                } else if (e.key === "Enter" && selectedIndex > -1) {
                    e.preventDefault();
                    if (items[selectedIndex]) {
                        this.value = items[selectedIndex].textContent;
                        destinationList.style.display = "none";
                    }
                }
            });

            function updateSelectedItem(items) {
                Array.from(items).forEach((item, index) => {
                    item.classList.toggle("selected", index === selectedIndex);
                });
            }

            document.addEventListener("click", function (e) {
                if (e.target !== deliveryDestinationInput) {
                    destinationList.style.display = "none";
                }
            });

            function updateDateTime() {
                const now = new Date();
                const dateTimeString = now.toLocaleString("en-US", {
                    day: "2-digit",
                    month: "2-digit",
                    year: "numeric",
                    hour: "2-digit",
                    minute: "2-digit",
                    second: "2-digit",
                    hour12: true,
                });
                document.getElementById("currentDateTime").textContent = dateTimeString;
            }

            setInterval(updateDateTime, 1000);
            updateDateTime();

            function updateCNoteStatus(status) {
                const statusInput = document.getElementById('cnoteStatus');
                const statusDisplay = document.getElementById('statusDisplay');
                statusInput.value = status;
                statusDisplay.className = `status-indicator status-${status.replace(' ', '-')}`;
                statusDisplay.textContent = `Status: ${status.charAt(0).toUpperCase() + status.slice(1)}`;
            }

            document.addEventListener("keydown", function (event) {
                const keyMap = {
                    F7: "PAID",
                    F8: "TO PAY",
                    F9: "TBB",
                    F10: "FOC",
                    "Alt+m": "MANUAL",
                };
                const type = keyMap[event.key] || (event.altKey && event.key === "m" ? keyMap["Alt+m"] : null);
                if (type) {
                    event.preventDefault();
                    updatePaymentType(type);
                }
            });

            ["paidBtn", "toPayBtn", "tbbBtn", "focBtn", "manualBtn"].forEach(id => {
                document.getElementById(id).addEventListener("click", () => updatePaymentType(id.replace("Btn", "").toUpperCase()));
            });

            function updatePaymentType(type) {
                document.getElementById("paymentTypeHeader").textContent = type;
                document.getElementById("paymentType").value = type;
                manualFields.style.display = type === "MANUAL" ? "flex" : "none";

                const manualRequired = type === "MANUAL";
                [manualDateInput, manualCNoteNumber, manualCNoteType].forEach(el => el.required = manualRequired);

                if (manualRequired) {
                    setManualDateRestrictions();
                }
            }

            function setManualDateRestrictions() {
                const today = new Date();
                const thirtyDaysAgo = new Date(today);
                thirtyDaysAgo.setDate(today.getDate() - 30);

                manualDateInput.max = today.toISOString().split("T")[0];
                manualDateInput.min = thirtyDaysAgo.toISOString().split("T")[0];
                manualDateInput.value = today.toISOString().split("T")[0];
            }

            function handleArticleTypeChange(select) {
                articleType = select.value;
                updateRowFields(select.closest("tr"));
                updateAllRows();
            }

            function updateRowFields(row) {
                const artAmtInput = row.querySelector(".art-amt");
                const selectedArticle = row.querySelector("select[name='article']").value;

                [artAmtInput, wtRateInput, wtAmtInput, fixAmtInput].forEach(input => input.disabled = true);
                [wtRateInput, wtAmtInput, fixAmtInput].forEach(input => input.value = 0);

                switch (selectedArticle) {
                    case "Article":
                        artAmtInput.disabled = false;
                        break;
                    case "Weight":
                        wtRateInput.disabled = false;
                        break;
                    case "Fix":
                        fixAmtInput.disabled = false;
                        break;
                }

                calculateRowAmount(row);
            }

            function calculateRowAmount(row) {
               
                const artInput = row.querySelector(".art-input");
                const perPktAmtInput = row.querySelector(".per-pkt-amt");
                const totalAmtInput = row.querySelector(".total-amt");
                let amount = 0;
                const art = parseFloat(artInput.value) || 0;
                const perPktAmt = parseFloat(perPktAmtInput.value) || 0;

                const totalAmt = art * perPktAmt;
                totalAmtInput.value = totalAmt.toFixed(2);

                switch (articleType) {
                    case "Article":
                        amount = parseFloat(artAmtInput.value) || 0;
                        break;
                    case "Weight":
                        const chargedWt = parseFloat(chargedWtInput.value) || 0;
                        const wtRate = parseFloat(wtRateInput.value) || 0;
                        amount = chargedWt * wtRate;
                        wtAmtInput.value = amount.toFixed(2);
                        break;
                    case "Fix":
                        amount = parseFloat(fixAmtInput.value) || 0;
                        break;
                }

                updateFreight();
            }
            function handleTotalAmtChange(row) {
                const artInput = row.querySelector(".art-input");
                const perPktAmtInput = row.querySelector(".per-pkt-amt");
                const totalAmtInput = row.querySelector(".total-amt");

                const art = parseFloat(artInput.value) || 0;
                const totalAmt = parseFloat(totalAmtInput.value) || 0;

                if (art !== 0) {
                    const perPktAmt = totalAmt / art;
                    perPktAmtInput.value = perPktAmt.toFixed(2);
                }

                updateFreight();
            }

            function updateAllRows() {
                Array.from(articleTable.rows).forEach(row => {
                    const select = row.querySelector("select[name='article']");
                    if (select) {
                        updateRowFields(row);
                    }
                });
            }

            function updateFreight() {
                let totalFreight = 0;
                Array.from(articleTable.rows).forEach(row => {
                    const artAmtInput = row.querySelector(".art-amt");
                    const selectedArticle = row.querySelector("select[name='article']").value;

                    switch (selectedArticle) {
                        case "Article":
                            totalFreight += parseFloat(artAmtInput.value) || 0;
                            break;
                        case "Weight":
                            const chargedWt = parseFloat(chargedWtInput.value) || 0;
                            const wtRate = parseFloat(wtRateInput.value) || 0;
                            totalFreight += chargedWt * wtRate;
                            break;
                        case "Fix":
                            totalFreight += parseFloat(fixAmtInput.value) || 0;
                            break;
                    }
                });

                freightInput.value = totalFreight.toFixed(2);
                calculateGrandTotal();
            }

            function calculateGrandTotal() {
                const chargesInputs = document.querySelectorAll('.charges-container input[type="number"]');
                let grandTotal = 0;

                chargesInputs.forEach(input => {
                    if (input.id !== "grandTotal") {
                        const value = parseFloat(input.value) || 0;
                        console.log(`${input.name}: ${value}`);
                        grandTotal += value;
                    }
                });

                console.log(`Calculated Grand Total: ${grandTotal}`);
                const grandTotalInput = document.getElementById("grandTotal");
                if (grandTotalInput) {
                    grandTotalInput.value = grandTotal.toFixed(2);
                }
            }

            function addArticle() {
                const newRow = articleTable.insertRow();
                newRow.innerHTML = `
                    <td>
                        <select name="article" class="article-select" required>
                            <option value="Article" selected>Article</option>
                            <option value="Weight">Weight</option>
                            <option value="Fix">Fix</option>
                        </select>
                    </td>
                    <td><input type="number" name="art" class="art-input" required></td>
                    <td>
                        <select name="artType" required>
                            <option value="">Select</option>
                            <option value="type1">Type 1</option>
                            <option value="type2">Type 2</option>
                        </select>
                    </td>
                    <td><input type="text" name="saidToContain" required></td>
                    <td><input type="number" name="perPktAmt" class="per-pkt-amt" step="0.01" required></td>
                    <td><input type="number" name="totalAmt" class="total-amt" step="0.01" readonly></td>
                    <td><button type="button" class="remove-article">Remove</button></td>
                `;

                const select = newRow.querySelector("select[name='article']");
                select.value = articleType;
                updateRowFields(newRow);

                select.addEventListener("change", function () {
                    handleArticleTypeChange(this);
                });

                const newArtAmtInput = newRow.querySelector('.art-amt');
                newArtAmtInput.addEventListener('input', updateFreight);

                setupArticleRowListeners(newRow);
                calculateTotalFreight();
            }

            function calculateTotalFreight() {
                let totalFreight = 0;
                Array.from(articleTable.rows).forEach(row => {
                    const artAmtInput = row.querySelector(".art-amt");
                    switch (articleType) {
                        case "Article":
                            totalFreight += parseFloat(artAmtInput.value) || 0;
                            break;
                        case "Weight":
                            totalFreight += parseFloat(wtAmtInput.value) || 0;
                            break;
                        case "Fix":
                            totalFreight += parseFloat(fixAmtInput.value) || 0;
                            break;
                    }
                });

                freightInput.value = totalFreight.toFixed(2);
                calculateGrandTotal();
            }

            addArticleButton.addEventListener("click", addArticle);

            articleTable.addEventListener("click", function (e) {
                if (e.target.classList.contains("remove-article")) {
                    e.target.closest("tr").remove();
                    updateFreight();
                }
            });

            function setupArticleRowListeners(row) {
              const artInput = row.querySelector('.art-input');
              const perPktAmtInput = row.querySelector('.per-pkt-amt');
              const totalAmtInput = row.querySelector('.total-amt');

              artInput.addEventListener('input', () => calculateRowAmount(row));
              perPktAmtInput.addEventListener('input', () => calculateRowAmount(row));
              totalAmtInput.addEventListener('input', () => handleTotalAmtChange(row));

              row.querySelector(".remove-article").disabled = articleTable.rows.length <= 1;
          }
                
            setupArticleRowListeners(articleTable.rows[0]);
            calculateTotalFreight();

            articleTable.querySelectorAll("select[name='article']").forEach(select => {
                select.addEventListener("change", function () {
                    handleArticleTypeChange(this);
                });
            });

            updateRowFields(articleTable.rows[0]);
            addInputListeners();

            function addInputListeners() {
                const inputs = document.querySelectorAll('.art-amt, #wtRate, #chargedWt, #fixAmt, .charges-container input[type="number"]');
                inputs.forEach(input => {
                    input.addEventListener('input', function() {
                        updateFreight();
                        calculateGrandTotal();
                    });
                });
            }

            var viewCnoteUrl = "{% url 'dealer:view_cnote' 'CNOTE_NUMBER' %}";

            document.getElementById("searchButton").addEventListener("click", function() {  
                const cnoteNumber = document.getElementById("searchCNote").value.trim();  
                
                if (cnoteNumber === "") {  
                    alert("Please enter a valid CNote number");  
                    return;  
                }  
                
                console.log("Searching for CNote:", cnoteNumber);
                console.log("Redirecting to:", viewCnoteUrl.replace('CNOTE_NUMBER', cnoteNumber));
                
                window.location.href = viewCnoteUrl.replace('CNOTE_NUMBER', cnoteNumber);  
            });

            document.querySelectorAll('.charges-container input[type="number"]').forEach(input => {
                input.addEventListener('input', calculateGrandTotal);
            });
                      
            // Add event listener for form submission
            form.addEventListener('submit', function(event) {
                event.preventDefault();
                calculateGrandTotal();

                // Ensure the payment type is set correctly
                const selectedPaymentType = paymentTypeInput.value;
                if (!selectedPaymentType) {
                    alert("Please select a payment type.");
                    return;
                }
                        
                // Define all charge fields with their exact backend field names
                const chargeFields = {
                    'freight': 'freight',
                    'docketCharge': 'docket_charge',
                    'doorDlyCharge': 'door_delivery_charge',
                    'handlingCharge': 'handling_charge',
                    'pickupCharge': 'pickup_charge',
                    'transhipmentCharge': 'transhipment_charge',
                    'insurance': 'insurance',
                    'fuelSurcharge': 'fuel_surcharge',
                    'commission': 'commission',
                    'otherCharge': 'other_charge',
                    'carrierRisk': 'carrier_risk',
                    'grandTotal': 'grand_total'
                };
                
                // Add all charge fields to the form data
                Object.entries(chargeFields).forEach(([frontendId, backendName]) => {
                    const input = document.getElementById(frontendId);
                    if (input) {
                        const value = parseFloat(input.value) || 0;
                        console.log(`Adding ${backendName}: ${value}`);
                        
                        // Remove any existing hidden input with this name
                        const existingInput = this.querySelector(`input[name="${backendName}"]`);
                        if (existingInput) {
                            existingInput.remove();
                        }
                        
                        // Create new hidden input
                        const hiddenInput = document.createElement('input');
                        hiddenInput.type = 'hidden';
                        hiddenInput.name = backendName;
                        hiddenInput.value = value.toFixed(2);
                        this.appendChild(hiddenInput);
                    }
                });

                 // Proceed with form submission
                const formData = new FormData(this);
                console.log("Form data before submission:");
                for (let [key, value] of formData.entries()) {
                    console.log(`${key}: ${value}`);
                }

                fetch(form.action, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    }
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        console.log('CNote created successfully:', data);
                        alert('CNote created successfully!');
                        window.location.href = data.redirect_url;
                    } else {
                        console.error('Error in server response:', data.error);
                        alert('Error: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error during form submission:', error);
                    alert('An error occurred while submitting the form. Please check the console for more details.');
                });
            });

            function validateForm() {
                const requiredFields = form.querySelectorAll('[required]');
                let isValid = true;
                requiredFields.forEach(field => {
                    if (!field.value.trim()) {
                        isValid = false;
                        field.classList.add('error');
                    } else {
                        field.classList.remove('error');
                    }
                });
                return isValid;
            }

            form.addEventListener('submit', function(event) {
                event.preventDefault();
                if (!validateForm()) {
                    alert('Please fill all required fields');
                    return;
                }
                // Rest of the submission code
            });

            function validateNumericInput(input) {
                input.addEventListener('input', function() {
                    this.value = this.value.replace(/[^0-9.]/g, '');
                    if (this.value.split('.').length > 2) {
                        this.value = this.value.replace(/\.+$/, '');
                    }
                });
            }

            document.querySelectorAll('input[type="number"]').forEach(validateNumericInput);
        });
    </script>
</body>
</html>
