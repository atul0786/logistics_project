{% extends 'base.html' %}

{% block content %}
<div class="container mt-4">
    <h2>üì¶ Bulk CNote Booking</h2>
    <hr>
   <br>
    <!-- ‚úÖ Excel Template Download Button -->
    <a href="{% url 'dealer:export_excel_template' %}" class="btn btn-primary">
        üì• Download Excel Template
    </a>
    <br><br>

    <!-- ‚úÖ Excel Upload Form -->
    <form method="POST" enctype="multipart/form-data" id="uploadForm">
        {% csrf_token %}
        <div class="mb-3">
            <label for="excel_file" class="form-label">üìÇ Upload Excel File:</label>
            <input type="file" name="excel_file" id="excel_file" class="form-control" accept=".xlsx, .xls" required>
        </div>
        <br>
        <button type="submit" class="btn btn-success">‚¨Ü Import & Save</button>
        <div id="loading" class="mt-2 text-primary" style="display: none;">
            ‚è≥ Processing... Please wait.
        </div>
    </form>

    <!-- ‚úÖ Message Display -->
    {% if messages %}
    <div class="mt-3">
        {% for message in messages %}
        <div class="alert alert-{{ message.tags }}">{{ message }}</div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- ‚úÖ Show Error Table if Failed Rows Exist -->
    {% if failed_rows %}
    <h4 class="mt-4 text-danger">‚ùå Failed Rows:</h4>
    <table class="table table-bordered">
        <thead>
            <tr>
                <th>Row Data</th>
                <th>Error Message</th>
            </tr>
        </thead>
        <tbody>
            {% for row in failed_rows %}
            <tr>
                <td>{{ row.row }}</td>
                <td class="text-danger">{{ row.error }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% endif %}
</div>

<!-- ‚úÖ JavaScript for File Validation & Loading Indicator -->
<script>
    document.getElementById("uploadForm").addEventListener("submit", function() {
        let fileInput = document.getElementById("excel_file");
        let loadingDiv = document.getElementById("loading");

        // ‚úÖ Check if file is selected
        if (!fileInput.files.length) {
            alert("‚ö†Ô∏è Please select a file before uploading.");
            return false;
        }

        // ‚úÖ Check file format
        let fileName = fileInput.value.toLowerCase();
        if (!fileName.endsWith(".xlsx") && !fileName.endsWith(".xls")) {
            alert("‚ö†Ô∏è Invalid file format! Please upload an Excel (.xlsx, .xls) file.");
            return false;
        }

        // ‚úÖ Show loading message
        loadingDiv.style.display = "block";
    });
</script>
{% endblock %}
